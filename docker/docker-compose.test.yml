# AIVO Platform - Docker Compose Test Configuration
# ══════════════════════════════════════════════════════════════════════════════
# This file provides test-specific configuration including:
# - Isolated test databases
# - Test-specific environment variables
# - Minimal service set for integration testing
# ══════════════════════════════════════════════════════════════════════════════

# Note: 'version' field is obsolete in Docker Compose v2+

x-test-env: &test-env
  NODE_ENV: test
  LOG_LEVEL: warn
  NATS_URL: nats://nats:4222
  REDIS_URL: redis://redis:6379

services:
  # ════════════════════════════════════════════════════════════════════════════
  # Infrastructure (Test Mode)
  # ════════════════════════════════════════════════════════════════════════════

  postgres:
    environment:
      POSTGRES_USER: aivo_test
      POSTGRES_PASSWORD: aivo_test_password
      POSTGRES_MULTIPLE_DATABASES: >-
        aivo_auth_test,aivo_tenant_test,aivo_content_test,aivo_session_test,
        aivo_assessment_test,aivo_engagement_test,aivo_analytics_test,
        aivo_personalization_test,aivo_baseline_test,aivo_retention_test,
        aivo_marketplace_test,aivo_notification_test,aivo_billing_test,
        aivo_profile_test,aivo_research_test
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster tests

  redis:
    command: redis-server --appendonly no --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes: []  # No persistence for tests

  nats:
    volumes:
      - ./configs/nats.conf:/etc/nats/nats.conf:ro
    # No persistence for tests

  # ════════════════════════════════════════════════════════════════════════════
  # Core Services (Test Mode)
  # ════════════════════════════════════════════════════════════════════════════

  auth-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_auth_test
      JWT_SECRET: test-jwt-secret
      JWT_EXPIRES_IN: 1h
    healthcheck:
      interval: 10s
      start_period: 20s

  tenant-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_tenant_test
    healthcheck:
      interval: 10s
      start_period: 20s

  profile-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_profile_test
    healthcheck:
      interval: 10s
      start_period: 20s

  content-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_content_test
      STORAGE_BUCKET: aivo-content-test
    healthcheck:
      interval: 10s
      start_period: 20s

  session-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_session_test
    healthcheck:
      interval: 10s
      start_period: 20s

  assessment-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_assessment_test
    healthcheck:
      interval: 10s
      start_period: 20s

  engagement-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_engagement_test
    healthcheck:
      interval: 10s
      start_period: 20s

  personalization-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_personalization_test
    healthcheck:
      interval: 10s
      start_period: 20s

  analytics-svc:
    environment:
      <<: *test-env
      DATABASE_URL: postgresql://aivo_test:aivo_test_password@postgres:5432/aivo_analytics_test
    healthcheck:
      interval: 10s
      start_period: 20s

  ai-orchestrator:
    environment:
      <<: *test-env
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-key}
      DEFAULT_LLM_PROVIDER: mock
    healthcheck:
      interval: 10s
      start_period: 20s

  # ════════════════════════════════════════════════════════════════════════════
  # Test Runner Service
  # ════════════════════════════════════════════════════════════════════════════

  test-runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    networks:
      - aivo-network
    environment:
      <<: *test-env
      AUTH_SVC_URL: http://auth-svc:3000
      TENANT_SVC_URL: http://tenant-svc:3000
      CONTENT_SVC_URL: http://content-svc:3000
      SESSION_SVC_URL: http://session-svc:3000
      ASSESSMENT_SVC_URL: http://assessment-svc:3000
    depends_on:
      auth-svc:
        condition: service_healthy
      tenant-svc:
        condition: service_healthy
      content-svc:
        condition: service_healthy
    volumes:
      - ../tests:/app/tests:ro
      - test_results:/app/test-results
    command: pnpm run test:integration

  # ════════════════════════════════════════════════════════════════════════════
  # Disable non-essential services for tests
  # ════════════════════════════════════════════════════════════════════════════

  # Observability stack not needed for tests
  prometheus:
    profiles:
      - observability

  grafana:
    profiles:
      - observability

  jaeger:
    profiles:
      - observability

  loki:
    profiles:
      - observability

  otel-collector:
    profiles:
      - observability

  # API Gateway not needed for direct service tests
  kong:
    profiles:
      - gateway

  # Search not needed for most tests
  elasticsearch:
    profiles:
      - search

volumes:
  postgres_test_data:
  test_results:
