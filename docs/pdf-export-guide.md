# PDF Export Implementation Guide

This document describes how to implement PDF export for Aivo reports using a rendering service.

## Current Approach: Browser Print

The current implementation uses `window.print()` with print-friendly CSS. This approach:

- Works immediately in all browsers
- Produces clean PDFs via "Print to PDF"
- Requires no server-side infrastructure

## Future Enhancement: Server-Side PDF Generation

For automated PDF generation (e.g., scheduled reports, email attachments), implement a PDF rendering service using Puppeteer or Playwright.

### Architecture

```
┌──────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│   reports-svc    │────▶│   pdf-svc       │────▶│  Storage (S3)    │
│                  │     │  (Puppeteer)    │     │                  │
└──────────────────┘     └─────────────────┘     └──────────────────┘
                              │
                              ▼
                         ┌─────────────────┐
                         │ Headless Chrome │
                         │ renders HTML    │
                         └─────────────────┘
```

### Puppeteer Service Implementation

```typescript
// services/pdf-svc/src/generatePdf.ts

import puppeteer from 'puppeteer';

interface PdfOptions {
  url?: string;
  html?: string;
  format?: 'A4' | 'Letter';
  landscape?: boolean;
  margin?: {
    top?: string;
    right?: string;
    bottom?: string;
    left?: string;
  };
}

export async function generatePdf(options: PdfOptions): Promise<Buffer> {
  const browser = await puppeteer.launch({
    headless: 'new',
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  });

  try {
    const page = await browser.newPage();

    if (options.url) {
      await page.goto(options.url, { waitUntil: 'networkidle0' });
    } else if (options.html) {
      await page.setContent(options.html, { waitUntil: 'networkidle0' });
    }

    // Wait for any dynamic content
    await page.waitForSelector('.print-section', { timeout: 5000 });

    const pdf = await page.pdf({
      format: options.format || 'A4',
      landscape: options.landscape || false,
      margin: options.margin || {
        top: '20mm',
        right: '15mm',
        bottom: '20mm',
        left: '15mm',
      },
      printBackground: true,
      displayHeaderFooter: true,
      headerTemplate: '<div></div>',
      footerTemplate: `
        <div style="font-size: 10px; text-align: center; width: 100%; padding: 5px;">
          <span>Generated by Aivo Platform</span>
          <span style="margin-left: 20px;">Page <span class="pageNumber"></span> of <span class="totalPages"></span></span>
        </div>
      `,
    });

    return Buffer.from(pdf);
  } finally {
    await browser.close();
  }
}
```

### API Endpoint

```typescript
// services/pdf-svc/src/routes/export.ts

import type { FastifyPluginAsync } from 'fastify';
import { generatePdf } from '../generatePdf.js';

export const exportRoutes: FastifyPluginAsync = async (app) => {
  // POST /export/pdf
  app.post<{
    Body: { url?: string; html?: string; format?: string };
  }>('/export/pdf', async (request, reply) => {
    const { url, html, format } = request.body;

    if (!url && !html) {
      return reply.code(400).send({ error: 'url or html required' });
    }

    const pdf = await generatePdf({
      url,
      html,
      format: format as 'A4' | 'Letter',
    });

    return reply
      .header('Content-Type', 'application/pdf')
      .header('Content-Disposition', 'attachment; filename="report.pdf"')
      .send(pdf);
  });

  // GET /export/learner/:learnerId/pdf
  app.get<{
    Params: { learnerId: string };
  }>('/export/learner/:learnerId/pdf', async (request, reply) => {
    const { learnerId } = request.params;

    // Generate PDF from the web report URL
    const reportUrl = `${process.env.WEB_URL}/reports/learners/${learnerId}?print=true`;

    const pdf = await generatePdf({ url: reportUrl });

    return reply
      .header('Content-Type', 'application/pdf')
      .header('Content-Disposition', `attachment; filename="learner-${learnerId}-report.pdf"`)
      .send(pdf);
  });
};
```

### Docker Setup for Puppeteer

```dockerfile
# services/pdf-svc/Dockerfile

FROM node:20-slim

# Install dependencies for Puppeteer
RUN apt-get update && apt-get install -y \
    chromium \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libnspr4 \
    libnss3 \
    libx11-xcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    xdg-utils \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .

EXPOSE 4060
CMD ["node", "dist/index.js"]
```

### Usage in Frontend

```typescript
// Add PDF export button to report pages

async function downloadPdf(learnerId: string) {
  const response = await fetch(`/api/export/learner/${learnerId}/pdf`, {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    throw new Error('Failed to generate PDF');
  }

  const blob = await response.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `report-${learnerId}.pdf`;
  a.click();

  URL.revokeObjectURL(url);
}
```

## Considerations

1. **Performance**: Puppeteer is resource-intensive. Consider:
   - Connection pooling for browser instances
   - Caching generated PDFs
   - Rate limiting

2. **Security**:
   - Run Puppeteer in sandbox mode
   - Validate URLs to prevent SSRF
   - Set timeouts to prevent hanging

3. **Scaling**:
   - Use a dedicated PDF service container
   - Consider using AWS Lambda with Puppeteer layers
   - Queue PDF generation jobs for high volume

4. **Accessibility**:
   - Ensure generated PDFs are tagged for accessibility
   - Include alt text for charts/images
