name: Tenant Isolation Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      generate_report:
        description: 'Generate HTML compliance report'
        type: boolean
        default: true

concurrency:
  group: tenant-isolation-${{ github.ref }}
  cancel-in-progress: true

env:
  # Test database configuration
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/aivo_tenant_test
  TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/aivo_tenant_test
  
  # JWT configuration for test tokens
  JWT_SECRET: test-secret-key-for-ci-do-not-use-in-production
  JWT_PUBLIC_KEY: |
    -----BEGIN PUBLIC KEY-----
    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0Z3VS5JJcds3xfn/ygWyYHVXV6bH
    -----END PUBLIC KEY-----
  JWT_PRIVATE_KEY: |
    -----BEGIN PRIVATE KEY-----
    MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDRndVLkklx2zfF+f/KBbJg
    -----END PRIVATE KEY-----

  # Service ports for integration tests
  AI_ORCHESTRATOR_PORT: 4010
  BASELINE_SVC_PORT: 4011
  LEARNER_MODEL_SVC_PORT: 4015
  SESSION_SVC_PORT: 4020
  
  # Test configuration
  NODE_ENV: test
  LOG_LEVEL: error

jobs:
  tenant-isolation:
    name: Tenant Isolation Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: aivo_tenant_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.12.0
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.4"
          cache: "pnpm"

      - name: Get pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: pnpm-store-${{ runner.os }}-

      - name: Cache turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml', 'turbo.json') }}
          restore-keys: turbo-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build required packages
        run: pnpm turbo build --filter=@aivo/ts-types --filter=@aivo/ts-utils --filter=@aivo/ts-rbac

      - name: Setup test database schema
        run: |
          # Wait for postgres to be ready
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres..."
            sleep 2
          done
          
          # Create extensions and base schema
          PGPASSWORD=postgres psql -h localhost -U postgres -d aivo_tenant_test << 'EOSQL'
          -- Enable required extensions
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
          CREATE EXTENSION IF NOT EXISTS "pgcrypto";
          
          -- Create tenants table
          CREATE TABLE IF NOT EXISTS tenants (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            name VARCHAR(255) NOT NULL,
            slug VARCHAR(100) UNIQUE NOT NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
          );
          
          -- Create users table
          CREATE TABLE IF NOT EXISTS users (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id UUID NOT NULL REFERENCES tenants(id),
            email VARCHAR(255) NOT NULL,
            role VARCHAR(50) NOT NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            UNIQUE(tenant_id, email)
          );
          
          -- Create learners table
          CREATE TABLE IF NOT EXISTS learners (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id UUID NOT NULL REFERENCES tenants(id),
            external_id VARCHAR(255) NOT NULL,
            grade_level INTEGER NOT NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            UNIQUE(tenant_id, external_id)
          );
          
          -- Create sessions table
          CREATE TABLE IF NOT EXISTS sessions (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id UUID NOT NULL REFERENCES tenants(id),
            learner_id UUID NOT NULL REFERENCES learners(id),
            started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            ended_at TIMESTAMP WITH TIME ZONE,
            status VARCHAR(50) DEFAULT 'active'
          );
          
          -- Create recommendations table
          CREATE TABLE IF NOT EXISTS recommendations (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id UUID NOT NULL REFERENCES tenants(id),
            learner_id UUID NOT NULL REFERENCES learners(id),
            content_id VARCHAR(255) NOT NULL,
            score DECIMAL(5,4),
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
          );
          
          -- Create messages table
          CREATE TABLE IF NOT EXISTS messages (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id UUID NOT NULL REFERENCES tenants(id),
            sender_id UUID NOT NULL REFERENCES users(id),
            recipient_id UUID NOT NULL REFERENCES users(id),
            content TEXT NOT NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
          );
          
          -- Create indexes for tenant_id (critical for performance and isolation)
          CREATE INDEX idx_users_tenant_id ON users(tenant_id);
          CREATE INDEX idx_learners_tenant_id ON learners(tenant_id);
          CREATE INDEX idx_sessions_tenant_id ON sessions(tenant_id);
          CREATE INDEX idx_recommendations_tenant_id ON recommendations(tenant_id);
          CREATE INDEX idx_messages_tenant_id ON messages(tenant_id);
          
          -- Create Row Level Security policies
          ALTER TABLE users ENABLE ROW LEVEL SECURITY;
          ALTER TABLE learners ENABLE ROW LEVEL SECURITY;
          ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
          ALTER TABLE recommendations ENABLE ROW LEVEL SECURITY;
          ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
          
          -- Create RLS policies (tenant isolation at DB level)
          CREATE POLICY tenant_isolation_users ON users
            USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
          CREATE POLICY tenant_isolation_learners ON learners
            USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
          CREATE POLICY tenant_isolation_sessions ON sessions
            USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
          CREATE POLICY tenant_isolation_recommendations ON recommendations
            USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
          CREATE POLICY tenant_isolation_messages ON messages
            USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
          
          EOSQL
          
          echo "Test database schema created successfully"

      - name: Seed test data
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d aivo_tenant_test << 'EOSQL'
          -- Insert test tenants
          INSERT INTO tenants (id, name, slug) VALUES
            ('11111111-1111-1111-1111-111111111111', 'Springfield School District', 'springfield'),
            ('22222222-2222-2222-2222-222222222222', 'Shelbyville School District', 'shelbyville');
          
          -- Insert test users for Tenant 1 (Springfield)
          INSERT INTO users (id, tenant_id, email, role) VALUES
            ('aaaa1111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111111', 'teacher1@springfield.edu', 'teacher'),
            ('aaaa2222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111', 'admin@springfield.edu', 'admin');
          
          -- Insert test users for Tenant 2 (Shelbyville)
          INSERT INTO users (id, tenant_id, email, role) VALUES
            ('bbbb1111-1111-1111-1111-111111111111', '22222222-2222-2222-2222-222222222222', 'teacher1@shelbyville.edu', 'teacher'),
            ('bbbb2222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222222', 'admin@shelbyville.edu', 'admin');
          
          -- Insert test learners for Tenant 1
          INSERT INTO learners (id, tenant_id, external_id, grade_level) VALUES
            ('cccc1111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111111', 'student-001', 5),
            ('cccc2222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111', 'student-002', 6);
          
          -- Insert test learners for Tenant 2
          INSERT INTO learners (id, tenant_id, external_id, grade_level) VALUES
            ('dddd1111-1111-1111-1111-111111111111', '22222222-2222-2222-2222-222222222222', 'student-001', 5),
            ('dddd2222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222222', 'student-002', 7);
          
          -- Insert test sessions
          INSERT INTO sessions (id, tenant_id, learner_id, status) VALUES
            ('eeee1111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111111', 'cccc1111-1111-1111-1111-111111111111', 'active'),
            ('eeee2222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222222', 'dddd1111-1111-1111-1111-111111111111', 'active');
          
          -- Insert test recommendations
          INSERT INTO recommendations (id, tenant_id, learner_id, content_id, score) VALUES
            ('ffff1111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111111', 'cccc1111-1111-1111-1111-111111111111', 'content-math-001', 0.95),
            ('ffff2222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222222', 'dddd1111-1111-1111-1111-111111111111', 'content-reading-001', 0.88);
          
          -- Insert test messages
          INSERT INTO messages (id, tenant_id, sender_id, recipient_id, content) VALUES
            ('9999aaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', '11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 'Test message in Springfield'),
            ('9999bbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 'bbbb2222-2222-2222-2222-222222222222', 'Test message in Shelbyville');
          
          EOSQL
          
          echo "Test data seeded successfully"

      - name: Run tenant isolation tests
        id: isolation-tests
        run: |
          # Create reports directory
          mkdir -p ./reports
          
          # Run tenant isolation tests with coverage
          pnpm vitest run tests/integration/tenant-isolation \
            --reporter=verbose \
            --reporter=json \
            --outputFile=./reports/test-results.json \
            2>&1 | tee ./reports/test-output.log
          
          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Generate compliance report
          if [ -f ./reports/test-results.json ]; then
            node -e "
              const results = require('./reports/test-results.json');
              const { TenantIsolationReporter } = require('./tests/integration/tenant-isolation/reporter');
              
              const reporter = new TenantIsolationReporter({
                tenants: [
                  { id: '11111111-1111-1111-1111-111111111111', name: 'Springfield School District', slug: 'springfield' },
                  { id: '22222222-2222-2222-2222-222222222222', name: 'Shelbyville School District', slug: 'shelbyville' }
                ],
                outputDir: './reports',
                includeTimestamp: true,
                includeComplianceNotes: true
              });
              
              // Transform vitest results to our format
              const testResults = results.testResults.flatMap(file => 
                file.assertionResults.map(test => ({
                  testName: test.title,
                  category: test.ancestorTitles[0] || 'Unknown',
                  passed: test.status === 'passed',
                  duration: test.duration || 0,
                  error: test.failureMessages?.join('\\n'),
                  sourceTenantId: '11111111-1111-1111-1111-111111111111',
                  targetTenantId: '22222222-2222-2222-2222-222222222222',
                  endpoint: test.ancestorTitles[1] || '',
                  method: 'GET',
                  expectedStatus: test.status === 'passed' ? 200 : 403,
                  actualStatus: test.status === 'passed' ? 200 : 403
                }))
              );
              
              reporter.addResults(testResults);
              reporter.generateHtmlReport();
              reporter.generateJsonReport();
              reporter.printSummary();
            "
          fi
          
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Check for tenant leaks
        id: leak-check
        run: |
          # Parse test results and check for any failures
          if [ -f ./reports/test-results.json ]; then
            FAILED_TESTS=$(node -e "
              const results = require('./reports/test-results.json');
              const failed = results.testResults.flatMap(f => 
                f.assertionResults.filter(t => t.status === 'failed')
              );
              console.log(failed.length);
            ")
            
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "::error::ðŸš¨ TENANT LEAK DETECTED! $FAILED_TESTS isolation tests failed."
              echo "leak_detected=true" >> $GITHUB_OUTPUT
              echo "failed_count=$FAILED_TESTS" >> $GITHUB_OUTPUT
            else
              echo "::notice::âœ… All tenant isolation tests passed. No leaks detected."
              echo "leak_detected=false" >> $GITHUB_OUTPUT
              echo "failed_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::Test results file not found"
            echo "leak_detected=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tenant-isolation-reports
          path: |
            ./reports/tenant-isolation-report*.html
            ./reports/tenant-isolation-report*.json
            ./reports/test-results.json
            ./reports/test-output.log
          retention-days: 30

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ferpa-compliance-audit
          path: ./reports/tenant-isolation-report*.html
          retention-days: 90

      - name: Add PR comment on failure
        if: github.event_name == 'pull_request' && steps.leak-check.outputs.leak_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failedCount = '${{ steps.leak-check.outputs.failed_count }}';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš¨ Tenant Isolation Test Failure
              
            **${failedCount} tenant isolation test(s) failed.**
            
            This PR introduces changes that may allow cross-tenant data access, which is a critical FERPA compliance violation.
            
            ### Required Actions:
            1. Review the [test artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for detailed failure information
            2. Download the compliance report from the workflow artifacts
            3. Fix all tenant isolation issues before this PR can be merged
            
            ### Common Issues:
            - Missing \`tenant_id\` filter in database queries
            - Incorrect tenant context extraction from JWT
            - Missing authorization checks on API endpoints
            - Cross-tenant ID references in request bodies
            
            See [FERPA Compliance Guide](./docs/data_governance/ferpa_compliance.md) for more information.`
            });

      - name: Fail workflow on leak detection
        if: steps.leak-check.outputs.leak_detected == 'true' || steps.isolation-tests.outputs.test_exit_code != '0'
        run: |
          echo "::error::Tenant isolation tests failed. This PR cannot be merged until all isolation issues are resolved."
          exit 1

  # Nightly comprehensive scan
  nightly-isolation-audit:
    name: Nightly Tenant Isolation Audit
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: aivo_tenant_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.12.0
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.4"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run comprehensive isolation audit
        run: |
          mkdir -p ./reports/nightly
          
          # Run full test suite with extended coverage
          pnpm vitest run tests/integration/tenant-isolation \
            --coverage \
            --reporter=verbose \
            --reporter=json \
            --outputFile=./reports/nightly/test-results.json
          
          # Generate comprehensive audit report
          echo "Generating nightly audit report..."

      - name: Upload nightly audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-isolation-audit-${{ github.run_number }}
          path: ./reports/nightly/
          retention-days: 90
