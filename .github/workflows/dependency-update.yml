# .github/workflows/dependency-update.yml
# Automated Dependency Updates
# Creates PRs for dependency updates on schedule

name: Dependency Update

on:
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - node
          - flutter
          - security-only

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NODE DEPENDENCIES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-node-deps:
    name: Update Node Dependencies
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'node' || github.event.inputs.update_type == '' || github.event.inputs.update_type == 'security-only'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install

      - name: Check for updates
        id: updates
        run: |
          echo "Checking for updates..."
          
          if [[ "${{ github.event.inputs.update_type }}" == "security-only" ]]; then
            # Only update packages with known vulnerabilities
            pnpm audit --fix 2>&1 || true
            UPDATED="security"
          else
            # Update all dependencies
            pnpm update --recursive --latest 2>&1 || true
            UPDATED="all"
          fi
          
          # Check if there are changes
          if git diff --quiet pnpm-lock.yaml; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi
          echo "update_type=$UPDATED" >> $GITHUB_OUTPUT

      - name: Run tests
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          pnpm run typecheck || true
          pnpm run test || true
        continue-on-error: true

      - name: Create Pull Request
        if: steps.updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BOT_PAT }}
          commit-message: 'chore(deps): update node dependencies'
          title: 'â¬†ï¸ Update Node Dependencies'
          body: |
            ## ðŸ“¦ Dependency Update

            This PR updates Node.js dependencies.

            **Update Type:** ${{ steps.updates.outputs.update_type }}

            ### Changes
            - Updated dependencies according to latest versions
            - Lock file regenerated

            ### Checklist
            - [ ] CI passes
            - [ ] No breaking changes introduced
            - [ ] Tested locally if significant changes

            ---
            *This PR was automatically created by the dependency update workflow.*
          branch: deps/node-update-${{ github.run_number }}
          labels: |
            dependencies
            automated
            node

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FLUTTER DEPENDENCIES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-flutter-deps:
    name: Update Flutter Dependencies
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'flutter' || github.event.inputs.update_type == ''
    strategy:
      matrix:
        app: [mobile-learner, mobile-parent, mobile-teacher]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.x'
          channel: 'stable'

      - name: Update dependencies
        id: updates
        working-directory: apps/${{ matrix.app }}
        run: |
          flutter pub upgrade --major-versions 2>&1 || true
          
          if git diff --quiet pubspec.lock; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        if: steps.updates.outputs.has_updates == 'true'
        working-directory: apps/${{ matrix.app }}
        run: flutter test
        continue-on-error: true

      - name: Create Pull Request
        if: steps.updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BOT_PAT }}
          commit-message: 'chore(deps): update ${{ matrix.app }} flutter dependencies'
          title: 'â¬†ï¸ Update Flutter Dependencies - ${{ matrix.app }}'
          body: |
            ## ðŸ“¦ Flutter Dependency Update

            This PR updates Flutter dependencies for **${{ matrix.app }}**.

            ### Changes
            - Updated pub dependencies
            - Lock file regenerated

            ### Checklist
            - [ ] CI passes
            - [ ] No breaking changes introduced
            - [ ] Tested on device/simulator

            ---
            *This PR was automatically created by the dependency update workflow.*
          branch: deps/flutter-${{ matrix.app }}-${{ github.run_number }}
          labels: |
            dependencies
            automated
            flutter
            ${{ matrix.app }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GITHUB ACTIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == ''
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Update GitHub Actions
        uses: renovatebot/github-action@v40.1.0
        with:
          configurationFile: .github/renovate.json
          token: ${{ secrets.BOT_PAT }}
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: Update Summary
    runs-on: ubuntu-latest
    needs: [update-node-deps, update-flutter-deps]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“¦ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node Dependencies | ${{ needs.update-node-deps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter Dependencies | ${{ needs.update-flutter-deps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Check the Pull Requests tab for any created PRs" >> $GITHUB_STEP_SUMMARY
          echo "- Review changes before merging" >> $GITHUB_STEP_SUMMARY
          echo "- Run full test suite on significant updates" >> $GITHUB_STEP_SUMMARY
