# End-to-End Testing CI/CD Pipeline
#
# Comprehensive testing workflow for the AIVO platform including:
# - Multi-browser E2E tests (Playwright)
# - Integration tests with TestContainers
# - Accessibility tests (WCAG 2.1 AA)
# - Performance tests (k6)
# - Visual regression tests (Percy)
# - Contract tests (Pact)
# - Security scans
#
# COPPA Compliance: All test artifacts are handled securely

name: E2E Testing Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/web-learner/**'
      - 'packages/**'
      - '.github/workflows/e2e-testing.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/web-learner/**'
      - 'packages/**'
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - e2e
          - integration
          - accessibility
          - performance
          - visual
          - security
      environment:
        description: 'Target environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - local
          - staging
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  CI: true

jobs:
  # ===========================================================================
  # SETUP & LINTING
  # ===========================================================================

  setup:
    name: Setup & Lint
    runs-on: ubuntu-latest
    outputs:
      should_run_e2e: ${{ steps.changes.outputs.e2e }}
      should_run_integration: ${{ steps.changes.outputs.integration }}
      cache_key: ${{ steps.cache-keys.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            e2e:
              - 'apps/web-learner/**'
              - 'packages/**'
            integration:
              - 'apps/api-gateway/**'
              - 'services/**'
              - 'packages/**'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Generate cache key
        id: cache-keys
        run: echo "key=${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

  # ===========================================================================
  # UNIT & COMPONENT TESTS
  # ===========================================================================

  unit-tests:
    name: Unit Tests
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: |
          pnpm test -- \
            --shard=${{ matrix.shard }}/4 \
            --coverage \
            --coverageReporters=json \
            --outputFile=test-results-${{ matrix.shard }}.json

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.shard }}
          path: coverage/
          retention-days: 7

  # ===========================================================================
  # E2E TESTS (PLAYWRIGHT)
  # ===========================================================================

  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    needs: setup
    if: needs.setup.outputs.should_run_e2e == 'true' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1, 2, 3]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aivo
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: aivo_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build application
        run: pnpm build
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test
          REDIS_URL: redis://localhost:6379

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test

      - name: Seed test data
        run: pnpm db:seed:test
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test

      - name: Run E2E tests
        run: |
          cd apps/web-learner
          npx playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }}/3 \
            --reporter=html,json,junit
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test
          REDIS_URL: redis://localhost:6379
          BASE_URL: http://localhost:3000
          API_BASE_URL: http://localhost:3001
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.browser }}-${{ matrix.shard }}
          path: |
            apps/web-learner/e2e/test-results/
            apps/web-learner/e2e/playwright-report/
          retention-days: 30

      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-traces-${{ matrix.browser }}-${{ matrix.shard }}
          path: apps/web-learner/e2e/test-results/**/*.zip
          retention-days: 7

  # ===========================================================================
  # MOBILE E2E TESTS
  # ===========================================================================

  mobile-e2e-tests:
    name: Mobile E2E Tests
    needs: setup
    if: needs.setup.outputs.should_run_e2e == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        device: ['Pixel 5', 'iPhone 13', 'iPad Pro 11']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Build application
        run: pnpm build

      - name: Run mobile E2E tests
        run: |
          cd apps/web-learner
          npx playwright test \
            --project="mobile-chrome" \
            --reporter=html,json
        env:
          BASE_URL: http://localhost:3000
          DEVICE: ${{ matrix.device }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-e2e-results-${{ matrix.device }}
          path: apps/web-learner/e2e/test-results/
          retention-days: 14

  # ===========================================================================
  # ACCESSIBILITY TESTS
  # ===========================================================================

  accessibility-tests:
    name: Accessibility Tests (WCAG 2.1 AA)
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Run accessibility tests
        run: |
          cd apps/web-learner
          npx playwright test \
            --project=accessibility \
            --reporter=html,json

      - name: Generate accessibility report
        if: always()
        run: |
          cd apps/web-learner
          npx @axe-core/cli http://localhost:3000 \
            --tags wcag2a,wcag2aa,wcag21aa \
            --save a11y-report.json || true

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: |
            apps/web-learner/e2e/test-results/
            apps/web-learner/a11y-report.json
          retention-days: 30

      - name: Comment PR with accessibility results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('apps/web-learner/a11y-report.json', 'utf8'));
            const violations = report.violations || [];

            let body = '## â™¿ Accessibility Report\n\n';
            if (violations.length === 0) {
              body += 'âœ… **No accessibility violations found!**\n';
            } else {
              body += `âš ï¸ **${violations.length} accessibility violations found:**\n\n`;
              violations.slice(0, 5).forEach(v => {
                body += `- **${v.id}**: ${v.help} (${v.impact})\n`;
              });
              if (violations.length > 5) {
                body += `\n... and ${violations.length - 5} more\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ===========================================================================
  # VISUAL REGRESSION TESTS
  # ===========================================================================

  visual-regression-tests:
    name: Visual Regression Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Run visual regression tests
        run: |
          cd apps/web-learner
          npx playwright test \
            --project=visual \
            --update-snapshots=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Percy upload
        if: github.event_name == 'pull_request'
        run: npx percy upload apps/web-learner/e2e/test-results/screenshots
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Upload snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-snapshots
          path: apps/web-learner/e2e/test-results/screenshots/
          retention-days: 14

  # ===========================================================================
  # INTEGRATION TESTS
  # ===========================================================================

  integration-tests:
    name: Integration Tests
    needs: setup
    if: needs.setup.outputs.should_run_integration == 'true' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aivo
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: aivo_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: 'false'
          ES_JAVA_OPTS: '-Xms512m -Xmx512m'
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test
          REDIS_URL: redis://localhost:6379
          ELASTICSEARCH_URL: http://localhost:9200

      - name: Run migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test

      - name: Run integration tests
        run: |
          cd apps/web-learner
          npx playwright test e2e/integration/ --reporter=html,json
        env:
          DATABASE_URL: postgresql://aivo:test_password@localhost:5432/aivo_test
          REDIS_URL: redis://localhost:6379
          ELASTICSEARCH_URL: http://localhost:9200
          API_BASE_URL: http://localhost:3001

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: apps/web-learner/e2e/test-results/
          retention-days: 14

  # ===========================================================================
  # PERFORMANCE TESTS
  # ===========================================================================

  performance-tests:
    name: Performance Tests (k6)
    needs: [setup, e2e-tests]
    if: github.event_name == 'push' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run smoke tests
        run: |
          k6 run \
            --env BASE_URL=${{ secrets.STAGING_URL || 'http://localhost:3000' }} \
            --env API_URL=${{ secrets.STAGING_API_URL || 'http://localhost:3001' }} \
            --out json=k6-smoke-results.json \
            apps/web-learner/e2e/performance/load-test.js \
            --tag testid=smoke \
            --env SCENARIO=smoke

      - name: Run load tests
        if: github.event_name == 'schedule'
        run: |
          k6 run \
            --env BASE_URL=${{ secrets.STAGING_URL }} \
            --env API_URL=${{ secrets.STAGING_API_URL }} \
            --out json=k6-load-results.json \
            apps/web-learner/e2e/performance/load-test.js \
            --tag testid=load \
            --env SCENARIO=load

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: k6-*.json
          retention-days: 30

      - name: Post performance summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const results = fs.readFileSync('k6-smoke-results.json', 'utf8')
                .split('\n')
                .filter(line => line.trim())
                .map(line => JSON.parse(line))
                .filter(item => item.type === 'Point');

              const p95 = results.find(r => r.metric === 'http_req_duration' && r.data.tags?.quantile === '0.95');
              const errorRate = results.find(r => r.metric === 'http_req_failed');

              console.log('Performance Summary:');
              console.log(`P95 Latency: ${p95?.data?.value || 'N/A'}ms`);
              console.log(`Error Rate: ${errorRate?.data?.value || 'N/A'}%`);
            } catch (e) {
              console.log('Could not parse performance results:', e.message);
            }

  # ===========================================================================
  # CONTRACT TESTS
  # ===========================================================================

  contract-tests:
    name: Contract Tests (Pact)
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run consumer contract tests
        run: pnpm test:contracts:consumer

      - name: Run provider verification
        run: pnpm test:contracts:provider
        env:
          PACT_BROKER_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}

      - name: Publish contracts
        if: github.ref == 'refs/heads/main'
        run: |
          npx pact-broker publish ./pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch ${{ github.ref_name }}
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}

  # ===========================================================================
  # SECURITY TESTS
  # ===========================================================================

  security-tests:
    name: Security Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Run Snyk scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run OWASP ZAP baseline scan
        if: github.event_name == 'schedule'
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ secrets.STAGING_URL || 'http://localhost:3000' }}
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --debug --only-verified

  # ===========================================================================
  # COVERAGE REPORT
  # ===========================================================================

  coverage-report:
    name: Coverage Report
    needs: [unit-tests, e2e-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage/
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          npx nyc merge coverage/ merged-coverage.json
          npx nyc report --reporter=lcov --reporter=text-summary -t .

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Check coverage thresholds
        run: |
          npx nyc check-coverage \
            --lines 80 \
            --functions 80 \
            --branches 70 \
            --statements 80

  # ===========================================================================
  # REPORT & NOTIFY
  # ===========================================================================

  report:
    name: Generate Report
    needs: [e2e-tests, accessibility-tests, visual-regression-tests, integration-tests, performance-tests, security-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate consolidated report
        run: |
          echo "# Test Results Summary" > report.md
          echo "" >> report.md
          echo "| Suite | Status |" >> report.md
          echo "|-------|--------|" >> report.md
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> report.md
          echo "| Accessibility | ${{ needs.accessibility-tests.result }} |" >> report.md
          echo "| Visual Regression | ${{ needs.visual-regression-tests.result }} |" >> report.md
          echo "| Integration | ${{ needs.integration-tests.result }} |" >> report.md
          echo "| Performance | ${{ needs.performance-tests.result }} |" >> report.md
          echo "| Security | ${{ needs.security-tests.result }} |" >> report.md

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ E2E Testing Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*E2E Testing Pipeline Failed*\n\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
