# Kong Gateway Helm Values for AIVO Platform
#
# Install with:
#   helm repo add kong https://charts.konghq.com
#   helm install kong kong/kong -f helm-values.yaml -n aivo-gateway
#
# See: https://github.com/Kong/charts/tree/main/charts/kong

# =============================================================================
# Global Configuration
# =============================================================================
replicaCount: 2

image:
  repository: kong
  tag: "3.6"
  pullPolicy: IfNotPresent

# =============================================================================
# Kong Gateway Configuration
# =============================================================================
env:
  # Database mode (off = declarative/DB-less)
  database: "off"
  
  # Plugins to load
  plugins: "bundled,dash_context,learner_scope,consent_gate"
  
  # Lua plugin path for custom plugins
  lua_package_path: "/kong/plugins/?.lua;/kong/plugins/?/init.lua;;"
  
  # Log level
  log_level: "info"
  
  # Nginx proxy settings
  nginx_proxy_proxy_buffer_size: "160k"
  nginx_proxy_proxy_buffers: "64 160k"
  
  # Upstream keepalive
  upstream_keepalive_pool_size: "60"
  upstream_keepalive_max_requests: "100"
  
  # DNS settings for service discovery
  dns_resolver: "kube-dns.kube-system.svc.cluster.local"
  dns_order: "LAST,A,CNAME"

# =============================================================================
# Proxy Configuration
# =============================================================================
proxy:
  enabled: true
  type: LoadBalancer
  
  annotations:
    # AWS ALB annotations (adjust for your cloud provider)
    # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    {}
  
  http:
    enabled: true
    servicePort: 80
    containerPort: 8000
  
  tls:
    enabled: true
    servicePort: 443
    containerPort: 8443
    # TLS certificate from secret
    # parameters:
    #   - secretName: kong-tls-cert

# =============================================================================
# Admin API Configuration
# =============================================================================
admin:
  enabled: true
  type: ClusterIP  # Internal only
  
  http:
    enabled: true
    servicePort: 8001
    containerPort: 8001

# =============================================================================
# Declarative Configuration (DB-less)
# =============================================================================
dblessConfig:
  configMap: kong-config
  # Content will be loaded from ConfigMap containing kong.yml

# =============================================================================
# Custom Plugins Volume
# =============================================================================
extraVolumes:
  - name: kong-plugins
    configMap:
      name: kong-plugins

extraVolumeMounts:
  - name: kong-plugins
    mountPath: /kong/plugins
    readOnly: true

# =============================================================================
# Ingress Configuration
# =============================================================================
ingressController:
  enabled: false  # Using declarative config instead

# =============================================================================
# Resources
# =============================================================================
resources:
  requests:
    cpu: "500m"
    memory: "512Mi"
  limits:
    cpu: "2000m"
    memory: "2Gi"

# =============================================================================
# Autoscaling
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# =============================================================================
# Pod Disruption Budget
# =============================================================================
podDisruptionBudget:
  enabled: true
  maxUnavailable: 1

# =============================================================================
# Probes
# =============================================================================
livenessProbe:
  httpGet:
    path: /status
    port: 8100
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /status/ready
    port: 8100
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  name: kong-gateway

# =============================================================================
# Pod Security Context
# =============================================================================
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# =============================================================================
# Node Affinity / Tolerations
# =============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - kong
          topologyKey: kubernetes.io/hostname

# =============================================================================
# Prometheus Metrics
# =============================================================================
serviceMonitor:
  enabled: true
  namespace: monitoring
  interval: 30s
  labels:
    release: prometheus
