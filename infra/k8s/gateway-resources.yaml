---
# AIVO API Gateway Kubernetes Resources
#
# This file contains the Kubernetes resources for deploying Kong Gateway
# and Apollo Router as the API edge infrastructure.
#
# Apply with:
#   kubectl apply -f gateway-resources.yaml
#

# =============================================================================
# Namespace
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: aivo-gateway
  labels:
    app.kubernetes.io/name: aivo-gateway
    app.kubernetes.io/part-of: aivo

---
# =============================================================================
# Kong Configuration ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: config
data:
  kong.yml: |
    # Kong declarative configuration
    # See infra/kong/kong.yml for full configuration
    _format_version: "3.0"
    _transform: true
    
    # Include full kong.yml content here
    # or mount from ConfigMap/Secret

---
# =============================================================================
# Kong Plugins ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-plugins
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: plugins
data:
  # dash_context plugin
  dash_context_handler.lua: |
    -- See infra/kong/plugins/dash_context/handler.lua
  dash_context_schema.lua: |
    -- See infra/kong/plugins/dash_context/schema.lua
  
  # learner_scope plugin  
  learner_scope_handler.lua: |
    -- See infra/kong/plugins/learner_scope/handler.lua
  learner_scope_schema.lua: |
    -- See infra/kong/plugins/learner_scope/schema.lua
  
  # consent_gate plugin
  consent_gate_handler.lua: |
    -- See infra/kong/plugins/consent_gate/handler.lua
  consent_gate_schema.lua: |
    -- See infra/kong/plugins/consent_gate/schema.lua

---
# =============================================================================
# Apollo Supergraph ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-supergraph
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: apollo-router
    app.kubernetes.io/component: config
data:
  supergraph.graphql: |
    # See infra/apollo/supergraph.graphql
    # Generated by: rover supergraph compose --config ./supergraph-config.yaml

---
# =============================================================================
# Apollo Rhai Scripts ConfigMap
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-rhai-scripts
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: apollo-router
    app.kubernetes.io/component: scripts
data:
  rbac.rhai: |
    // See infra/apollo/rhai/rbac.rhai

---
# =============================================================================
# Redis for Rate Limiting
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: redis
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          command:
            - redis-server
            - --appendonly
            - "yes"
            - --maxmemory
            - "256mb"
            - --maxmemory-policy
            - "allkeys-lru"
          ports:
            - containerPort: 6379
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          livenessProbe:
            tcpSocket:
              port: 6379
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - redis-cli
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - name: redis-data
              mountPath: /data
      volumes:
        - name: redis-data
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: aivo-gateway
  labels:
    app.kubernetes.io/name: redis
spec:
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app.kubernetes.io/name: redis

---
# =============================================================================
# Network Policies
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-network-policy
  namespace: aivo-gateway
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: kong
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow external traffic to proxy ports
    - ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8443
  egress:
    # Allow to Apollo Router
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: apollo-router
      ports:
        - protocol: TCP
          port: 4000
    # Allow to backend services in aivo namespace
    - to:
        - namespaceSelector:
            matchLabels:
              name: aivo
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 3010
        - protocol: TCP
          port: 3020
        - protocol: TCP
          port: 3030
        - protocol: TCP
          port: 3040
        - protocol: TCP
          port: 3050
        - protocol: TCP
          port: 3060
        - protocol: TCP
          port: 3100
    # Allow to Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: apollo-router-network-policy
  namespace: aivo-gateway
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: apollo-router
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Kong only
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kong
      ports:
        - protocol: TCP
          port: 4000
  egress:
    # Allow to backend services in aivo namespace
    - to:
        - namespaceSelector:
            matchLabels:
              name: aivo
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 3010
        - protocol: TCP
          port: 3020
        - protocol: TCP
          port: 3030
        - protocol: TCP
          port: 3040
        - protocol: TCP
          port: 3050
        - protocol: TCP
          port: 3060
        - protocol: TCP
          port: 3100
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# Horizontal Pod Autoscaler for Kong
# =============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kong-hpa
  namespace: aivo-gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: kong
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# =============================================================================
# Pod Disruption Budget for Kong
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: kong-pdb
  namespace: aivo-gateway
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kong

---
# =============================================================================
# Pod Disruption Budget for Apollo Router
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: apollo-router-pdb
  namespace: aivo-gateway
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: apollo-router
