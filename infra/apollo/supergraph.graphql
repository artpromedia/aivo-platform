# AIVO Federated Supergraph Schema
#
# This is a placeholder supergraph schema. In production, this would be
# generated by Apollo Federation composition using `rover supergraph compose`.
#
# See: https://www.apollographql.com/docs/federation/
#
# To generate this schema:
#   rover supergraph compose --config ./supergraph-config.yaml > supergraph.graphql

schema
  @link(url: "https://specs.apollo.dev/link/v1.0")
  @link(url: "https://specs.apollo.dev/federation/v2.5", import: ["@key", "@shareable", "@external", "@requires", "@provides", "@tag", "@inaccessible"])
{
  query: Query
  mutation: Mutation
}

# =============================================================================
# Custom Directives for RBAC
# =============================================================================

"""
Restricts field access to users with the specified roles.
Applied at field resolution time by the router.
"""
directive @rbac(
  """Required roles for accessing this field (OR logic)"""
  roles: [Role!]!
) on FIELD_DEFINITION

"""
Marks a field as requiring authentication.
User must have a valid JWT to access this field.
"""
directive @auth on FIELD_DEFINITION

"""
Marks a field as requiring consent.
The specified consent type must be granted for the learner.
"""
directive @consent(
  """Required consent type"""
  type: ConsentType!
) on FIELD_DEFINITION

# =============================================================================
# Enums
# =============================================================================

enum Role {
  PARENT
  LEARNER
  TEACHER
  THERAPIST
  DISTRICT_ADMIN
  PLATFORM_ADMIN
  SUPPORT
  CURRICULUM_AUTHOR
  CURRICULUM_REVIEWER
  DISTRICT_CONTENT_ADMIN
}

enum ConsentType {
  BASELINE_ASSESSMENT
  AI_TUTOR
  RESEARCH_ANALYTICS
}

enum ConsentStatus {
  PENDING
  GRANTED
  REVOKED
  EXPIRED
}

# =============================================================================
# Root Query Type
# =============================================================================

type Query {
  # ---------------------------
  # Auth Queries
  # ---------------------------
  """Get current user's profile"""
  me: User @auth
  
  # ---------------------------
  # Tenant Queries
  # ---------------------------
  """Get tenant by ID (platform admin only)"""
  tenant(id: ID!): Tenant @auth @rbac(roles: [PLATFORM_ADMIN, SUPPORT])
  
  """List all tenants (platform admin only)"""
  tenants(first: Int, after: String): TenantConnection @auth @rbac(roles: [PLATFORM_ADMIN, SUPPORT])
  
  # ---------------------------
  # Learner Queries
  # ---------------------------
  """Get learner by ID"""
  learner(id: ID!): Learner @auth
  
  """List learners (teachers see their classes, parents see their children)"""
  learners(
    classroomId: ID
    first: Int
    after: String
  ): LearnerConnection @auth @rbac(roles: [TEACHER, THERAPIST, PARENT, DISTRICT_ADMIN, PLATFORM_ADMIN])
  
  # ---------------------------
  # Content Queries
  # ---------------------------
  """Get learning object by ID"""
  learningObject(id: ID!): LearningObject @auth
  
  """Search learning objects"""
  searchContent(
    query: String!
    gradeLevel: Int
    subject: String
    first: Int
    after: String
  ): LearningObjectConnection @auth
  
  # ---------------------------
  # Session Queries
  # ---------------------------
  """Get learning session by ID"""
  session(id: ID!): LearningSession @auth
  
  """List sessions for a learner"""
  learnerSessions(
    learnerId: ID!
    first: Int
    after: String
  ): LearningSessionConnection @auth
  
  # ---------------------------
  # Assessment Queries
  # ---------------------------
  """Get assessment by ID"""
  assessment(id: ID!): Assessment @auth
  
  """Get baseline assessment results (requires consent)"""
  baselineResults(learnerId: ID!): BaselineResults @auth @consent(type: BASELINE_ASSESSMENT)
  
  # ---------------------------
  # Report Queries
  # ---------------------------
  """Get learner progress report"""
  learnerReport(
    learnerId: ID!
    startDate: String
    endDate: String
  ): LearnerReport @auth @rbac(roles: [PARENT, TEACHER, THERAPIST, DISTRICT_ADMIN])
  
  """Get classroom report (teachers only)"""
  classroomReport(classroomId: ID!): ClassroomReport @auth @rbac(roles: [TEACHER, DISTRICT_ADMIN])
  
  # ---------------------------
  # Consent Queries
  # ---------------------------
  """Get consents for a learner"""
  consents(learnerId: ID!): [Consent!]! @auth @rbac(roles: [PARENT, TEACHER, DISTRICT_ADMIN, PLATFORM_ADMIN])
}

# =============================================================================
# Root Mutation Type
# =============================================================================

type Mutation {
  # ---------------------------
  # Auth Mutations
  # ---------------------------
  """Update user profile"""
  updateProfile(input: UpdateProfileInput!): User @auth
  
  # ---------------------------
  # Session Mutations
  # ---------------------------
  """Start a learning session"""
  startSession(input: StartSessionInput!): LearningSession @auth @rbac(roles: [LEARNER])
  
  """End a learning session"""
  endSession(sessionId: ID!): LearningSession @auth @rbac(roles: [LEARNER])
  
  """Record session event"""
  recordSessionEvent(input: SessionEventInput!): SessionEvent @auth @rbac(roles: [LEARNER])
  
  # ---------------------------
  # AI Mutations (requires consent)
  # ---------------------------
  """Get AI tutor response"""
  askAiTutor(input: AiTutorInput!): AiTutorResponse @auth @consent(type: AI_TUTOR)
  
  """Get AI hint for a problem"""
  getAiHint(input: AiHintInput!): AiHintResponse @auth @consent(type: AI_TUTOR)
  
  # ---------------------------
  # Consent Mutations
  # ---------------------------
  """Grant consent (parents only)"""
  grantConsent(input: GrantConsentInput!): Consent @auth @rbac(roles: [PARENT])
  
  """Revoke consent (parents only)"""
  revokeConsent(input: RevokeConsentInput!): Consent @auth @rbac(roles: [PARENT])
  
  # ---------------------------
  # Content Mutations (curriculum authors)
  # ---------------------------
  """Create learning object"""
  createLearningObject(input: CreateLearningObjectInput!): LearningObject @auth @rbac(roles: [CURRICULUM_AUTHOR, CURRICULUM_REVIEWER, PLATFORM_ADMIN])
  
  """Publish learning object"""
  publishLearningObject(id: ID!): LearningObject @auth @rbac(roles: [CURRICULUM_REVIEWER, PLATFORM_ADMIN])
}

# =============================================================================
# Types
# =============================================================================

type User @key(fields: "id") {
  id: ID!
  email: String!
  displayName: String
  roles: [Role!]!
  tenantId: ID!
  createdAt: String!
  updatedAt: String!
}

type Tenant @key(fields: "id") {
  id: ID!
  name: String!
  slug: String!
  plan: String!
  settings: TenantSettings
  createdAt: String!
  updatedAt: String!
}

type TenantSettings {
  maxUsers: Int
  maxLearners: Int
  features: [String!]!
}

type Learner @key(fields: "id") {
  id: ID!
  userId: ID!
  displayName: String!
  gradeLevel: Int
  tenantId: ID!
  classrooms: [Classroom!]!
  """Virtual brain state (AI learning model)"""
  virtualBrain: VirtualBrain @consent(type: AI_TUTOR)
  """Baseline assessment results"""
  baselineResults: BaselineResults @consent(type: BASELINE_ASSESSMENT)
  createdAt: String!
}

type Classroom @key(fields: "id") {
  id: ID!
  name: String!
  teacherId: ID!
  learners: [Learner!]!
  tenantId: ID!
}

type LearningObject @key(fields: "id") {
  id: ID!
  title: String!
  description: String
  type: String!
  gradeLevel: Int
  subject: String
  status: String!
  content: JSON
  createdAt: String!
  updatedAt: String!
}

type LearningSession @key(fields: "id") {
  id: ID!
  learnerId: ID!
  learningObjectId: ID
  status: String!
  startedAt: String!
  endedAt: String
  events: [SessionEvent!]!
}

type SessionEvent {
  id: ID!
  type: String!
  data: JSON
  timestamp: String!
}

type VirtualBrain {
  learnerId: ID!
  knowledgeState: JSON
  preferences: JSON
  lastUpdated: String!
}

type BaselineResults {
  learnerId: ID!
  assessmentDate: String!
  scores: JSON
  recommendations: [String!]!
}

type Assessment @key(fields: "id") {
  id: ID!
  title: String!
  type: String!
  questions: [Question!]!
}

type Question {
  id: ID!
  text: String!
  type: String!
  options: [String!]
}

type LearnerReport {
  learnerId: ID!
  period: ReportPeriod!
  progress: JSON
  recommendations: [String!]!
  generatedAt: String!
}

type ReportPeriod {
  startDate: String!
  endDate: String!
}

type ClassroomReport {
  classroomId: ID!
  period: ReportPeriod!
  summary: JSON
  learnerReports: [LearnerReport!]!
  generatedAt: String!
}

type Consent @key(fields: "id") {
  id: ID!
  learnerId: ID!
  consentType: ConsentType!
  status: ConsentStatus!
  grantedByParentId: ID
  grantedAt: String
  revokedAt: String
  expiresAt: String
}

type AiTutorResponse {
  message: String!
  suggestions: [String!]
  followUp: String
}

type AiHintResponse {
  hint: String!
  difficulty: Int!
}

# =============================================================================
# Input Types
# =============================================================================

input UpdateProfileInput {
  displayName: String
}

input StartSessionInput {
  learningObjectId: ID!
  metadata: JSON
}

input SessionEventInput {
  sessionId: ID!
  type: String!
  data: JSON
}

input AiTutorInput {
  learnerId: ID!
  sessionId: ID
  message: String!
  context: JSON
}

input AiHintInput {
  learnerId: ID!
  questionId: ID!
  attemptNumber: Int!
}

input GrantConsentInput {
  learnerId: ID!
  consentType: ConsentType!
  expiresAt: String
}

input RevokeConsentInput {
  consentId: ID!
  reason: String!
}

input CreateLearningObjectInput {
  title: String!
  description: String
  type: String!
  gradeLevel: Int
  subject: String
  content: JSON
}

# =============================================================================
# Connections (Relay-style Pagination)
# =============================================================================

type TenantConnection {
  edges: [TenantEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type TenantEdge {
  node: Tenant!
  cursor: String!
}

type LearnerConnection {
  edges: [LearnerEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type LearnerEdge {
  node: Learner!
  cursor: String!
}

type LearningObjectConnection {
  edges: [LearningObjectEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type LearningObjectEdge {
  node: LearningObject!
  cursor: String!
}

type LearningSessionConnection {
  edges: [LearningSessionEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type LearningSessionEdge {
  node: LearningSession!
  cursor: String!
}

type PageInfo {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

# =============================================================================
# Scalar Types
# =============================================================================

scalar JSON
