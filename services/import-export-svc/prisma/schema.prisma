// ══════════════════════════════════════════════════════════════════════════════
// IMPORT/EXPORT SERVICE - PRISMA SCHEMA
// Database models for content import/export, SCORM packages, and LTI integration
// ══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// IMPORT JOBS
// ─────────────────────────────────────────────────────────────────────────────

model ImportJob {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  userId          String    @map("user_id")
  sourceFile      String    @map("source_file")
  originalFileName String?  @map("original_file_name")
  format          String?   // scorm_1.2, scorm_2004, qti_2.1, qti_3.0, common_cartridge
  status          String    @default("pending") // pending, processing, completed, failed, cancelled
  progress        Int       @default(0)
  progressMessage String?   @map("progress_message")
  options         Json?
  result          Json?
  error           String?
  validationErrors Json?    @map("validation_errors")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  cancelledAt     DateTime? @map("cancelled_at")
  cancelledBy     String?   @map("cancelled_by")

  // Relations
  importedContents ImportedContent[]

  @@index([tenantId, status])
  @@index([userId])
  @@index([createdAt])
  @@map("import_jobs")
}

model ImportedContent {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  importJobId   String   @map("import_job_id")
  externalId    String   @map("external_id")
  type          String   // lesson, assessment, question, folder, resource
  title         String
  description   String?
  contentData   Json     @map("content_data")
  sourceFormat  String   @map("source_format")
  mappedTo      String?  @map("mapped_to") // ID of the created internal content
  mappedType    String?  @map("mapped_type") // Type of internal content created
  
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  importJob     ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([importJobId])
  @@index([externalId])
  @@map("imported_contents")
}

// ─────────────────────────────────────────────────────────────────────────────
// EXPORT JOBS
// ─────────────────────────────────────────────────────────────────────────────

model ExportJob {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  userId        String    @map("user_id")
  contentType   String    @map("content_type") // lesson, assessment, course
  contentIds    String[]  @map("content_ids")
  format        String    // scorm_1.2, scorm_2004, qti_2.1, qti_3.0, common_cartridge, xapi
  status        String    @default("pending") // pending, processing, completed, failed
  progress      Int       @default(0)
  options       Json?
  result        Json?
  error         String?
  
  // Output file info
  fileName      String?   @map("file_name")
  fileSize      Int?      @map("file_size")
  s3Key         String?   @map("s3_key")
  downloadUrl   String?   @map("download_url")
  expiresAt     DateTime? @map("expires_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")

  @@index([tenantId, status])
  @@index([userId])
  @@index([createdAt])
  @@map("export_jobs")
}

// ─────────────────────────────────────────────────────────────────────────────
// SCORM PACKAGES
// ─────────────────────────────────────────────────────────────────────────────

model ScormPackage {
  id                  String   @id @default(uuid())
  tenantId            String   @map("tenant_id")
  createdBy           String   @map("created_by")
  title               String
  description         String?
  version             String   // 1.2, 2004
  edition             String?  // For SCORM 2004: 2nd, 3rd, 4th
  manifestIdentifier  String?  @map("manifest_identifier")
  originalFileName    String   @map("original_file_name")
  s3Prefix            String?  @map("s3_prefix")
  status              String   @default("processing") // processing, ready, error
  itemCount           Int      @default(0) @map("item_count")
  structure           Json?    // Cached organization structure
  metadata            Json?    // LOM metadata
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  items               ScormItem[]
  attempts            ScormAttempt[]

  @@index([tenantId])
  @@index([createdBy])
  @@map("scorm_packages")
}

model ScormItem {
  id                  String   @id @default(uuid())
  packageId           String   @map("package_id")
  identifier          String?
  title               String
  parentId            String?  @map("parent_id")
  orderIndex          Int      @default(0) @map("order_index")
  depth               Int      @default(0)
  
  // Resource info
  resourceIdentifier  String?  @map("resource_identifier")
  isSCO               Boolean  @default(false) @map("is_sco")
  launchUrl           String?  @map("launch_url")
  parameters          String?
  
  // SCORM 1.2 specific
  prerequisites       String?
  masteryScore        Float?   @map("mastery_score")
  maxTimeAllowed      String?  @map("max_time_allowed")
  timeLimitAction     String?  @map("time_limit_action")
  
  // SCORM 2004 sequencing
  sequencingRules     Json?    @map("sequencing_rules")
  
  // Mapping to internal content
  mappedLessonId      String?  @map("mapped_lesson_id")
  
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  package             ScormPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  parent              ScormItem?   @relation("ScormItemHierarchy", fields: [parentId], references: [id])
  children            ScormItem[]  @relation("ScormItemHierarchy")
  attempts            ScormAttempt[]

  @@index([packageId])
  @@index([parentId])
  @@index([identifier])
  @@map("scorm_items")
}

model ScormAttempt {
  id              String    @id @default(uuid())
  studentId       String    @map("student_id")
  scormItemId     String    @map("scorm_item_id")
  packageId       String    @map("package_id")
  version         String    // 1.2, 2004
  attemptNumber   Int       @default(1) @map("attempt_number")
  
  status          String    @default("not_attempted") // not_attempted, incomplete, completed, passed, failed
  suspendData     String?   @map("suspend_data") @db.Text
  location        String?
  
  // CMI data model
  cmiData         Json      @map("cmi_data")
  
  // Score
  scoreRaw        Float?    @map("score_raw")
  scoreMin        Float?    @map("score_min")
  scoreMax        Float?    @map("score_max")
  scoreScaled     Float?    @map("score_scaled")
  
  // Time tracking
  totalTime       String?   @map("total_time")
  sessionTime     String?   @map("session_time")
  
  startedAt       DateTime  @default(now()) @map("started_at")
  lastAccessedAt  DateTime  @default(now()) @map("last_accessed_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  scormItem       ScormItem    @relation(fields: [scormItemId], references: [id], onDelete: Cascade)
  package         ScormPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([studentId, scormItemId, attemptNumber])
  @@index([studentId])
  @@index([scormItemId])
  @@index([packageId])
  @@index([status])
  @@map("scorm_attempts")
}

// ─────────────────────────────────────────────────────────────────────────────
// LTI INTEGRATION
// ─────────────────────────────────────────────────────────────────────────────

model LtiTool {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  name              String
  description       String?
  
  // LTI 1.3 Configuration
  clientId          String   @unique @map("client_id")
  deploymentId      String   @map("deployment_id")
  issuer            String
  authLoginUrl      String   @map("auth_login_url")
  authTokenUrl      String   @map("auth_token_url")
  keysetUrl         String   @map("keyset_url")
  launchUrl         String   @map("launch_url")
  redirectUris      String[] @map("redirect_uris")
  
  // Keys
  publicKey         String   @map("public_key") @db.Text
  privateKey        String   @map("private_key") @db.Text
  
  // Settings
  customParameters  Json?    @map("custom_parameters")
  capabilities      String[] @default([])
  
  status            String   @default("active") // active, inactive, pending
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  launches          LtiLaunch[]
  resourceLinks     LtiResourceLink[]

  @@index([tenantId])
  @@index([clientId])
  @@map("lti_tools")
}

model LtiResourceLink {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  toolId          String   @map("tool_id")
  resourceLinkId  String   @map("resource_link_id")
  title           String
  description     String?
  
  // Link to internal content
  contentType     String?  @map("content_type")
  contentId       String?  @map("content_id")
  
  customParameters Json?   @map("custom_parameters")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tool            LtiTool   @relation(fields: [toolId], references: [id], onDelete: Cascade)
  launches        LtiLaunch[]

  @@unique([toolId, resourceLinkId])
  @@index([tenantId])
  @@map("lti_resource_links")
}

model LtiLaunch {
  id                String   @id @default(uuid())
  toolId            String   @map("tool_id")
  resourceLinkId    String?  @map("resource_link_id")
  userId            String   @map("user_id")
  
  // Launch data
  messageType       String   @map("message_type") // LtiResourceLinkRequest, LtiDeepLinkingRequest
  launchData        Json     @map("launch_data")
  
  // State
  state             String   @unique
  nonce             String
  
  createdAt         DateTime @default(now()) @map("created_at")
  expiresAt         DateTime @map("expires_at")

  // Relations
  tool              LtiTool          @relation(fields: [toolId], references: [id], onDelete: Cascade)
  resourceLink      LtiResourceLink? @relation(fields: [resourceLinkId], references: [id])

  @@index([toolId])
  @@index([state])
  @@index([expiresAt])
  @@map("lti_launches")
}

// ─────────────────────────────────────────────────────────────────────────────
// xAPI STATEMENTS
// ─────────────────────────────────────────────────────────────────────────────

model XapiStatement {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  statementId     String   @unique @map("statement_id")
  
  // Actor
  actorType       String   @map("actor_type") // Agent, Group
  actorMbox       String?  @map("actor_mbox")
  actorAccount    Json?    @map("actor_account")
  
  // Verb
  verbId          String   @map("verb_id")
  verbDisplay     Json     @map("verb_display")
  
  // Object
  objectType      String   @map("object_type") // Activity, Agent, StatementRef, SubStatement
  objectId        String   @map("object_id")
  objectDefinition Json?   @map("object_definition")
  
  // Result
  result          Json?
  
  // Context
  context         Json?
  
  // Timestamps
  timestamp       DateTime
  stored          DateTime @default(now())
  
  // Raw statement
  rawStatement    Json     @map("raw_statement")
  
  // Export tracking
  exported        Boolean  @default(false)
  exportedAt      DateTime? @map("exported_at")

  @@index([tenantId])
  @@index([actorMbox])
  @@index([verbId])
  @@index([objectId])
  @@index([timestamp])
  @@map("xapi_statements")
}

// ─────────────────────────────────────────────────────────────────────────────
// CONTENT MAPPING RULES
// ─────────────────────────────────────────────────────────────────────────────

model ContentMappingRule {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  description     String?
  
  // Source format
  sourceFormat    String   @map("source_format") // scorm, qti, common_cartridge
  sourceType      String   @map("source_type")   // sco, assessment_item, web_content
  
  // Target mapping
  targetType      String   @map("target_type")   // lesson, assessment, question
  mappingRules    Json     @map("mapping_rules") // Field mapping configuration
  
  // Conditions
  conditions      Json?    // When to apply this rule
  priority        Int      @default(0)
  
  isDefault       Boolean  @default(false) @map("is_default")
  isActive        Boolean  @default(true) @map("is_active")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([sourceFormat, sourceType])
  @@map("content_mapping_rules")
}
