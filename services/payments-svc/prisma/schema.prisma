// ══════════════════════════════════════════════════════════════════════════════
// PAYMENTS SERVICE PRISMA SCHEMA
// ══════════════════════════════════════════════════════════════════════════════
// 
// Production-ready schema for payment persistence:
// - Customer records synced with Stripe
// - Subscription lifecycle tracking
// - Invoice and payment history
// - Refund and dispute management
// - Audit trail for compliance
// ══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Subscription plan types
enum Plan {
  FREE
  PRO
  PREMIUM
  SCHOOL
  DISTRICT

  @@map("plan")
}

/// Tax exemption status
enum TaxExempt {
  NONE
  EXEMPT
  REVERSE

  @@map("tax_exempt")
}

/// Subscription status aligned with Stripe
enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  UNPAID
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  PAUSED

  @@map("subscription_status")
}

/// Invoice status aligned with Stripe
enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE

  @@map("invoice_status")
}

/// Payment status
enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED

  @@map("payment_status")
}

/// Refund status
enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED

  @@map("refund_status")
}

/// Refund reason
enum RefundReason {
  DUPLICATE
  FRAUDULENT
  REQUESTED_BY_CUSTOMER
  OTHER

  @@map("refund_reason")
}

/// Dispute status aligned with Stripe
enum DisputeStatus {
  NEEDS_RESPONSE
  UNDER_REVIEW
  WON
  LOST
  WARNING_CLOSED
  WARNING_NEEDS_RESPONSE
  WARNING_UNDER_REVIEW
  CHARGE_REFUNDED

  @@map("dispute_status")
}

/// Billing interval
enum BillingInterval {
  MONTHLY
  ANNUAL

  @@map("billing_interval")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Customer record synced with Stripe
model Customer {
  id                     String    @id @default(uuid()) @db.Uuid
  tenantId               String    @map("tenant_id") @db.Uuid
  userId                 String    @unique @map("user_id") @db.Uuid
  stripeCustomerId       String    @unique @map("stripe_customer_id")
  email                  String
  name                   String?
  phone                  String?
  defaultPaymentMethodId String?   @map("default_payment_method_id")
  balance                Decimal   @default(0) @db.Decimal(12, 2)
  currency               String    @default("usd") @db.VarChar(3)
  taxExempt              TaxExempt @default(NONE) @map("tax_exempt")
  
  // Address
  addressLine1           String?   @map("address_line1")
  addressLine2           String?   @map("address_line2")
  city                   String?
  state                  String?
  postalCode             String?   @map("postal_code")
  country                String?   @db.VarChar(2)
  
  // Metadata
  metadata               Json?
  deletedAt              DateTime? @map("deleted_at") @db.Timestamptz
  
  // Timestamps
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  subscriptions          Subscription[]
  invoices               Invoice[]
  payments               Payment[]
  paymentMethods         PaymentMethod[]
  
  @@index([tenantId])
  @@index([stripeCustomerId])
  @@index([email])
  @@map("customers")
}

/// Subscription record synced with Stripe
model Subscription {
  id                     String             @id @default(uuid()) @db.Uuid
  customerId             String             @map("customer_id") @db.Uuid
  customer               Customer           @relation(fields: [customerId], references: [id])
  stripeSubscriptionId   String             @unique @map("stripe_subscription_id")
  stripePriceId          String             @map("stripe_price_id")
  stripeProductId        String?            @map("stripe_product_id")
  
  // Plan details
  plan                   Plan
  billingInterval        BillingInterval    @default(MONTHLY) @map("billing_interval")
  status                 SubscriptionStatus
  quantity               Int                @default(1)
  
  // Billing cycle
  currentPeriodStart     DateTime           @map("current_period_start") @db.Timestamptz
  currentPeriodEnd       DateTime           @map("current_period_end") @db.Timestamptz
  billingCycleAnchor     DateTime?          @map("billing_cycle_anchor") @db.Timestamptz
  
  // Cancellation
  cancelAt               DateTime?          @map("cancel_at") @db.Timestamptz
  canceledAt             DateTime?          @map("canceled_at") @db.Timestamptz
  cancelAtPeriodEnd      Boolean            @default(false) @map("cancel_at_period_end")
  cancelReason           String?            @map("cancel_reason")
  
  // Trial
  trialStart             DateTime?          @map("trial_start") @db.Timestamptz
  trialEnd               DateTime?          @map("trial_end") @db.Timestamptz
  
  // Pause
  pausedAt               DateTime?          @map("paused_at") @db.Timestamptz
  resumesAt              DateTime?          @map("resumes_at") @db.Timestamptz
  
  // Metadata
  metadata               Json?
  
  // Timestamps
  createdAt              DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime           @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  items                  SubscriptionItem[]
  
  @@index([customerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

/// Subscription item (for multi-item subscriptions)
model SubscriptionItem {
  id                       String       @id @default(uuid()) @db.Uuid
  subscriptionId           String       @map("subscription_id") @db.Uuid
  subscription             Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  stripeSubscriptionItemId String       @unique @map("stripe_subscription_item_id")
  stripePriceId            String       @map("stripe_price_id")
  quantity                 Int          @default(1)
  
  // Timestamps
  createdAt                DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  
  @@index([subscriptionId])
  @@map("subscription_items")
}

/// Invoice record synced with Stripe
model Invoice {
  id                  String          @id @default(uuid()) @db.Uuid
  customerId          String          @map("customer_id") @db.Uuid
  customer            Customer        @relation(fields: [customerId], references: [id])
  stripeInvoiceId     String          @unique @map("stripe_invoice_id")
  subscriptionId      String?         @map("subscription_id") @db.Uuid
  
  // Invoice details
  number              String?
  status              InvoiceStatus
  collectionMethod    String?         @map("collection_method")
  
  // Amounts
  currency            String          @db.VarChar(3)
  subtotal            Decimal         @db.Decimal(12, 2)
  subtotalExcludingTax Decimal?       @map("subtotal_excluding_tax") @db.Decimal(12, 2)
  tax                 Decimal         @default(0) @db.Decimal(12, 2)
  total               Decimal         @db.Decimal(12, 2)
  totalExcludingTax   Decimal?        @map("total_excluding_tax") @db.Decimal(12, 2)
  amountPaid          Decimal         @default(0) @map("amount_paid") @db.Decimal(12, 2)
  amountDue           Decimal         @map("amount_due") @db.Decimal(12, 2)
  amountRemaining     Decimal         @default(0) @map("amount_remaining") @db.Decimal(12, 2)
  
  // Discounts
  discountAmount      Decimal?        @map("discount_amount") @db.Decimal(12, 2)
  couponId            String?         @map("coupon_id")
  
  // Links
  pdfUrl              String?         @map("pdf_url")
  hostedInvoiceUrl    String?         @map("hosted_invoice_url")
  
  // Dates
  periodStart         DateTime        @map("period_start") @db.Timestamptz
  periodEnd           DateTime        @map("period_end") @db.Timestamptz
  dueDate             DateTime?       @map("due_date") @db.Timestamptz
  paidAt              DateTime?       @map("paid_at") @db.Timestamptz
  voidedAt            DateTime?       @map("voided_at") @db.Timestamptz
  markedUncollectibleAt DateTime?     @map("marked_uncollectible_at") @db.Timestamptz
  
  // Attempt tracking
  attemptCount        Int             @default(0) @map("attempt_count")
  nextPaymentAttempt  DateTime?       @map("next_payment_attempt") @db.Timestamptz
  
  // Metadata
  metadata            Json?
  
  // Timestamps
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  lineItems           InvoiceLineItem[]
  payments            Payment[]
  
  @@index([customerId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([subscriptionId])
  @@map("invoices")
}

/// Invoice line item
model InvoiceLineItem {
  id              String    @id @default(uuid()) @db.Uuid
  invoiceId       String    @map("invoice_id") @db.Uuid
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  stripeLineItemId String?  @map("stripe_line_item_id")
  
  // Item details
  type            String?   // 'subscription', 'invoiceitem'
  description     String
  quantity        Int       @default(1)
  unitAmount      Decimal   @map("unit_amount") @db.Decimal(12, 2)
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @db.VarChar(3)
  
  // Period
  periodStart     DateTime? @map("period_start") @db.Timestamptz
  periodEnd       DateTime? @map("period_end") @db.Timestamptz
  
  // Proration
  proration       Boolean   @default(false)
  
  // Related price/product
  stripePriceId   String?   @map("stripe_price_id")
  stripeProductId String?   @map("stripe_product_id")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  
  @@index([invoiceId])
  @@map("invoice_line_items")
}

/// Payment record
model Payment {
  id                    String         @id @default(uuid()) @db.Uuid
  customerId            String         @map("customer_id") @db.Uuid
  customer              Customer       @relation(fields: [customerId], references: [id])
  invoiceId             String?        @map("invoice_id") @db.Uuid
  invoice               Invoice?       @relation(fields: [invoiceId], references: [id])
  
  // Stripe IDs
  stripePaymentIntentId String?        @unique @map("stripe_payment_intent_id")
  stripeChargeId        String?        @unique @map("stripe_charge_id")
  
  // Amount
  amount                Decimal        @db.Decimal(12, 2)
  amountReceived        Decimal?       @map("amount_received") @db.Decimal(12, 2)
  currency              String         @db.VarChar(3)
  
  // Status
  status                PaymentStatus
  
  // Payment method
  paymentMethodId       String?        @map("payment_method_id")
  paymentMethodType     String?        @map("payment_method_type")
  cardBrand             String?        @map("card_brand")
  cardLast4             String?        @map("card_last4")
  
  // Failure details
  failureCode           String?        @map("failure_code")
  failureMessage        String?        @map("failure_message")
  
  // Receipt
  receiptUrl            String?        @map("receipt_url")
  receiptNumber         String?        @map("receipt_number")
  
  // Refunds
  refundedAmount        Decimal        @default(0) @map("refunded_amount") @db.Decimal(12, 2)
  
  // Metadata
  metadata              Json?
  
  // Timestamps
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  refunds               Refund[]
  disputes              Dispute[]
  
  @@index([customerId])
  @@index([invoiceId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([status])
  @@map("payments")
}

/// Payment method record
model PaymentMethod {
  id                    String    @id @default(uuid()) @db.Uuid
  customerId            String    @map("customer_id") @db.Uuid
  customer              Customer  @relation(fields: [customerId], references: [id])
  stripePaymentMethodId String    @unique @map("stripe_payment_method_id")
  
  // Type and details
  type                  String    // 'card', 'bank_account', etc.
  
  // Card details (if type = 'card')
  cardBrand             String?   @map("card_brand")
  cardLast4             String?   @map("card_last4")
  cardExpMonth          Int?      @map("card_exp_month")
  cardExpYear           Int?      @map("card_exp_year")
  cardCountry           String?   @map("card_country")
  cardFunding           String?   @map("card_funding") // 'credit', 'debit', 'prepaid'
  
  // Status
  isDefault             Boolean   @default(false) @map("is_default")
  
  // Billing details
  billingName           String?   @map("billing_name")
  billingEmail          String?   @map("billing_email")
  billingPhone          String?   @map("billing_phone")
  billingAddressLine1   String?   @map("billing_address_line1")
  billingAddressLine2   String?   @map("billing_address_line2")
  billingCity           String?   @map("billing_city")
  billingState          String?   @map("billing_state")
  billingPostalCode     String?   @map("billing_postal_code")
  billingCountry        String?   @map("billing_country")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  
  @@index([customerId])
  @@index([stripePaymentMethodId])
  @@map("payment_methods")
}

/// Refund record
model Refund {
  id              String        @id @default(uuid()) @db.Uuid
  paymentId       String        @map("payment_id") @db.Uuid
  payment         Payment       @relation(fields: [paymentId], references: [id])
  stripeRefundId  String        @unique @map("stripe_refund_id")
  
  // Amount
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @db.VarChar(3)
  
  // Status
  status          RefundStatus
  reason          RefundReason?
  
  // Failure
  failureReason   String?       @map("failure_reason")
  failureBalanceTransaction String? @map("failure_balance_transaction")
  
  // Metadata
  description     String?
  metadata        Json?
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  
  @@index([paymentId])
  @@index([stripeRefundId])
  @@map("refunds")
}

/// Dispute/chargeback record
model Dispute {
  id                String         @id @default(uuid()) @db.Uuid
  paymentId         String         @map("payment_id") @db.Uuid
  payment           Payment        @relation(fields: [paymentId], references: [id])
  stripeDisputeId   String         @unique @map("stripe_dispute_id")
  stripeChargeId    String         @map("stripe_charge_id")
  
  // Amount
  amount            Decimal        @db.Decimal(12, 2)
  currency          String         @db.VarChar(3)
  
  // Status and reason
  status            DisputeStatus
  reason            String
  
  // Evidence
  evidenceDueBy     DateTime?      @map("evidence_due_by") @db.Timestamptz
  hasEvidence       Boolean        @default(false) @map("has_evidence")
  pastDue           Boolean        @default(false) @map("past_due")
  
  // Resolution
  resolvedAt        DateTime?      @map("resolved_at") @db.Timestamptz
  isChargeRefundable Boolean       @default(false) @map("is_charge_refundable")
  
  // Network details
  networkReasonCode String?        @map("network_reason_code")
  
  // Metadata
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  
  @@index([paymentId])
  @@index([stripeDisputeId])
  @@index([status])
  @@map("disputes")
}

/// Webhook event log for idempotency and debugging
model WebhookEvent {
  id              String    @id @default(uuid()) @db.Uuid
  stripeEventId   String    @unique @map("stripe_event_id")
  eventType       String    @map("event_type")
  
  // Processing status
  processed       Boolean   @default(false)
  processedAt     DateTime? @map("processed_at") @db.Timestamptz
  
  // Error tracking
  errorMessage    String?   @map("error_message")
  retryCount      Int       @default(0) @map("retry_count")
  
  // Raw payload (for debugging)
  payload         Json?
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  
  @@index([stripeEventId])
  @@index([eventType])
  @@index([processed, createdAt])
  @@map("webhook_events")
}

/// Usage record for usage-based billing
model UsageRecord {
  id                     String    @id @default(uuid()) @db.Uuid
  subscriptionItemId     String    @map("subscription_item_id") @db.Uuid
  stripeSubscriptionItemId String  @map("stripe_subscription_item_id")
  
  // Usage
  quantity               Int
  action                 String    @default("increment") // 'increment' or 'set'
  
  // Stripe response
  stripeUsageRecordId    String?   @map("stripe_usage_record_id")
  
  // Timestamps
  timestamp              DateTime  @db.Timestamptz
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  
  @@index([subscriptionItemId])
  @@index([stripeSubscriptionItemId])
  @@index([timestamp])
  @@map("usage_records")
}

/// Coupon/promotion tracking
model AppliedCoupon {
  id              String    @id @default(uuid()) @db.Uuid
  customerId      String    @map("customer_id") @db.Uuid
  subscriptionId  String?   @map("subscription_id") @db.Uuid
  stripeCouponId  String    @map("stripe_coupon_id")
  promoCode       String?   @map("promo_code")
  
  // Discount details
  amountOff       Decimal?  @map("amount_off") @db.Decimal(12, 2)
  percentOff      Decimal?  @map("percent_off") @db.Decimal(5, 2)
  currency        String?   @db.VarChar(3)
  
  // Duration
  duration        String    // 'once', 'repeating', 'forever'
  durationMonths  Int?      @map("duration_months")
  
  // Application dates
  appliedAt       DateTime  @default(now()) @map("applied_at") @db.Timestamptz
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz
  redeemedAt      DateTime? @map("redeemed_at") @db.Timestamptz
  
  @@index([customerId])
  @@index([subscriptionId])
  @@index([stripeCouponId])
  @@map("applied_coupons")
}
