generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INVITED
  DISABLED
}

enum UserRoleEnum {
  PARENT
  LEARNER
  TEACHER
  THERAPIST
  DISTRICT_ADMIN
  PLATFORM_ADMIN
  SUPPORT
}

enum IdpProtocol {
  SAML
  OIDC
}

model User {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  email         String
  phone         String?
  passwordHash  String
  externalId    String?    // IdP subject/nameId for federated users
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  roles         UserRole[]

  @@unique([tenantId, email])
  @@unique([tenantId, externalId])
  @@index([tenantId])
}

model UserRole {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @db.Uuid
  role        UserRoleEnum
  contextJson Json?
  createdAt   DateTime     @default(now())

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// SSO / IDENTITY FEDERATION
// ============================================================================

/// IdP configuration for tenant SSO
model IdpConfig {
  id                    String      @id @default(uuid()) @db.Uuid
  tenantId              String      @db.Uuid
  protocol              IdpProtocol

  // Display name for the IdP (e.g., "District Google Workspace")
  name                  String
  
  // Common
  issuer                String      // IdP entity ID (SAML) or issuer URL (OIDC)
  enabled               Boolean     @default(false)
  
  // SAML-specific
  ssoUrl                String?     // IdP's SingleSignOnService URL
  sloUrl                String?     // IdP's SingleLogoutService URL (optional)
  x509Certificate       String?     @db.Text // IdP's public certificate for signature validation
  metadataXml           String?     @db.Text // Raw SAML metadata XML
  
  // OIDC-specific
  clientId              String?
  clientSecretRef       String?     // Reference to secret in KMS/Vault (not the actual secret)
  authorizationEndpoint String?
  tokenEndpoint         String?
  userinfoEndpoint      String?
  jwksUri               String?
  scopes                String[]    @default(["openid", "profile", "email"])
  
  // Claims mapping
  emailClaim            String      @default("email")
  nameClaim             String      @default("name")
  firstNameClaim        String      @default("given_name")
  lastNameClaim         String      @default("family_name")
  roleClaim             String      @default("role")
  externalIdClaim       String      @default("sub") // OIDC: sub, SAML: NameID
  
  // Role mapping configuration (JSON)
  // Example: { "Teacher": "TEACHER", "Admin": "DISTRICT_ADMIN", "Staff": "TEACHER" }
  roleMapping           Json        @default("{}")
  
  // Auto-provisioning settings
  autoProvisionUsers    Boolean     @default(false)
  defaultRole           UserRoleEnum @default(TEACHER)
  
  // Login hint template (optional, for pre-filling email domain)
  // Example: "{email}" or "{username}@district.edu"
  loginHintTemplate     String?
  
  // Allow specific user types to use this IdP
  allowedUserTypes      UserRoleEnum[] @default([TEACHER, THERAPIST, DISTRICT_ADMIN])
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // SSO attempt logs
  ssoAttempts           SsoAttempt[]
  
  @@unique([tenantId, protocol]) // One IdP config per protocol per tenant
  @@index([tenantId])
  @@index([enabled])
}

/// SSO attempt audit log
model SsoAttempt {
  id              String    @id @default(uuid()) @db.Uuid
  idpConfigId     String    @db.Uuid
  tenantId        String    @db.Uuid
  
  // Request details
  userIdentifier  String?   // Email or external ID from IdP
  ipAddress       String?
  userAgent       String?
  
  // Result
  success         Boolean
  userId          String?   @db.Uuid // If successful, the Aivo user ID
  errorCode       String?   // e.g., "INVALID_SIGNATURE", "USER_NOT_FOUND", "ASSERTION_EXPIRED"
  errorMessage    String?
  
  // Timestamps
  initiatedAt     DateTime  @default(now())
  completedAt     DateTime?
  
  idpConfig       IdpConfig @relation(fields: [idpConfigId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([idpConfigId])
  @@index([initiatedAt])
  @@index([success])
}

/// Tenant configuration (basic tenant info for SSO routing)
model Tenant {
  id              String    @id @default(uuid()) @db.Uuid
  slug            String    @unique // URL-friendly identifier, e.g., "springfield-usd"
  name            String
  domain          String?   // Primary email domain, e.g., "springfield.k12.us"
  
  // SSO settings
  ssoEnabled      Boolean   @default(false)
  ssoRequired     Boolean   @default(false) // If true, password login is disabled
  
  // Fallback admin emails (can always use password login)
  fallbackAdminEmails String[] @default([])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([slug])
  @@index([domain])
}
