generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

enum LearningObjectSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  OTHER

  @@map("learning_object_subject")
}

enum LearningObjectGradeBand {
  K_2
  G3_5
  G6_8
  G9_12

  @@map("learning_object_grade_band")
}

enum LearningObjectVersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED

  @@map("learning_object_version_state")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Logical identity of a learning content unit.
model LearningObject {
  id               String                   @id @default(uuid()) @db.Uuid
  tenantId         String?                  @map("tenant_id") @db.Uuid
  slug             String
  title            String
  subject          LearningObjectSubject
  gradeBand        LearningObjectGradeBand  @map("grade_band")
  primarySkillId   String?                  @map("primary_skill_id") @db.Uuid
  isActive         Boolean                  @default(true) @map("is_active")
  createdByUserId  String                   @map("created_by_user_id") @db.Uuid
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  versions      LearningObjectVersion[]
  tags          LearningObjectTag[]
  contentShares ContentShare[]
  forks         ContentFork[]

  @@unique([tenantId, slug])
  @@index([tenantId, subject, gradeBand])
  @@index([primarySkillId])
  @@map("learning_objects")
}

/// Versioned content with review workflow.
model LearningObjectVersion {
  id                 String                      @id @default(uuid()) @db.Uuid
  learningObjectId   String                      @map("learning_object_id") @db.Uuid
  versionNumber      Int                         @map("version_number")
  state              LearningObjectVersionState  @default(DRAFT)
  createdByUserId    String                      @map("created_by_user_id") @db.Uuid
  reviewedByUserId   String?                     @map("reviewed_by_user_id") @db.Uuid
  approvedByUserId   String?                     @map("approved_by_user_id") @db.Uuid
  changeSummary      String?                     @map("change_summary")
  legacyReviewNotes  String?                     @map("review_notes") // Deprecated: use reviewNotesList
  contentJson        Json                        @map("content_json")
  accessibilityJson  Json                        @default("{}") @map("accessibility_json")
  standardsJson      Json                        @default("{}") @map("standards_json")
  metadataJson       Json                        @default("{}") @map("metadata_json")
  createdAt          DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                    @updatedAt @map("updated_at") @db.Timestamptz
  publishedAt        DateTime?                   @map("published_at") @db.Timestamptz
  retiredAt          DateTime?                   @map("retired_at") @db.Timestamptz

  learningObject    LearningObject                   @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  skills            LearningObjectSkill[]
  transitions       LearningObjectVersionTransition[]
  qaChecks          LearningObjectVersionCheck[]
  reviewNotesList   LearningObjectVersionReviewNote[]
  translations      LearningObjectTranslation[]

  @@unique([learningObjectId, versionNumber])
  @@index([learningObjectId, state, versionNumber(sort: Desc)])
  @@index([state])
  @@map("learning_object_versions")
}

/// Flexible tags for content discovery and filtering.
model LearningObjectTag {
  id               String   @id @default(uuid()) @db.Uuid
  learningObjectId String   @map("learning_object_id") @db.Uuid
  tag              String
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObject LearningObject @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)

  @@unique([learningObjectId, tag])
  @@index([tag])
  @@map("learning_object_tags")
}

/// Version-specific skill alignments.
model LearningObjectSkill {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  skillId                  String   @map("skill_id") @db.Uuid
  isPrimary                Boolean  @default(false) @map("is_primary")
  weight                   Decimal? @db.Decimal(4, 3)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, skillId])
  @@index([skillId])
  @@map("learning_object_skills")
}

/// Audit trail for workflow state changes.
model LearningObjectVersionTransition {
  id                    String                      @id @default(uuid()) @db.Uuid
  versionId             String                      @map("version_id") @db.Uuid
  fromState             LearningObjectVersionState  @map("from_state")
  toState               LearningObjectVersionState  @map("to_state")
  transitionedByUserId  String                      @map("transitioned_by_user_id") @db.Uuid
  reason                String?
  transitionedAt        DateTime                    @default(now()) @map("transitioned_at") @db.Timestamptz

  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("learning_object_version_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// QA CHECKS & REVIEW NOTES
// ══════════════════════════════════════════════════════════════════════════════

enum QaCheckType {
  ACCESSIBILITY
  METADATA_COMPLETENESS
  POLICY_LANGUAGE
  CONTENT_STRUCTURE
  SKILL_ALIGNMENT

  @@map("qa_check_type")
}

enum QaCheckStatus {
  PASSED
  WARNING
  FAILED

  @@map("qa_check_status")
}

/// Automated QA check results for a version.
model LearningObjectVersionCheck {
  id                       String                @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String                @map("learning_object_version_id") @db.Uuid
  checkType                QaCheckType           @map("check_type")
  status                   QaCheckStatus
  message                  String
  details                  Json?                 @default("{}")
  createdAt                DateTime              @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@index([learningObjectVersionId, checkType])
  @@index([status])
  @@map("learning_object_version_checks")
}

/// Reviewer notes attached to a version during review.
model LearningObjectVersionReviewNote {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  authorUserId             String   @map("author_user_id") @db.Uuid
  noteText                 String   @map("note_text")
  noteType                 String   @default("GENERAL") @map("note_type") // GENERAL, APPROVAL, REJECTION, FEEDBACK
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@index([learningObjectVersionId, createdAt(sort: Desc)])
  @@map("learning_object_version_review_notes")
}

// ══════════════════════════════════════════════════════════════════════════════
// INTERNATIONALIZATION & ACCESSIBILITY
// ══════════════════════════════════════════════════════════════════════════════

enum CognitiveLoad {
  LOW
  MEDIUM
  HIGH

  @@map("cognitive_load")
}

enum TranslationStatus {
  DRAFT
  READY
  NEEDS_UPDATE

  @@map("translation_status")
}

/// Localized content for a Learning Object version.
/// Each version can have multiple translations, one per locale.
model LearningObjectTranslation {
  id                       String             @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String             @map("learning_object_version_id") @db.Uuid
  locale                   String             @db.VarChar(10) // e.g., "en", "es", "en-US", "es-MX"
  status                   TranslationStatus  @default(DRAFT)
  contentJson              Json               @map("content_json")       // Localized content
  accessibilityJson        Json               @default("{}") @map("accessibility_json") // Localized alt text, hints
  metadataJson             Json               @default("{}") @map("metadata_json")      // Locale-specific metadata
  translatedByUserId       String?            @map("translated_by_user_id") @db.Uuid
  reviewedByUserId         String?            @map("reviewed_by_user_id") @db.Uuid
  createdAt                DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, locale])
  @@index([locale])
  @@index([status])
  @@map("learning_object_translations")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT SHARING & MARKETPLACE
// ══════════════════════════════════════════════════════════════════════════════

enum ContentVisibility {
  PRIVATE
  SCHOOL
  DISTRICT
  PUBLIC

  @@map("content_visibility")
}

/// Shared content from teachers to the marketplace
model ContentShare {
  id                   String             @id @default(uuid()) @db.Uuid
  learningObjectId     String             @map("learning_object_id") @db.Uuid
  sharedByUserId       String             @map("shared_by_user_id") @db.Uuid
  tenantId             String?            @map("tenant_id") @db.Uuid
  schoolId             String?            @map("school_id") @db.Uuid
  visibility           ContentVisibility  @default(PRIVATE)
  description          String?
  license              String?
  requiresAttribution  Boolean            @default(false) @map("requires_attribution")
  downloadCount        Int                @default(0) @map("download_count")
  viewCount            Int                @default(0) @map("view_count")
  forkCount            Int                @default(0) @map("fork_count")
  averageRating        Decimal?           @db.Decimal(3, 2) @map("average_rating")
  isActive             Boolean            @default(true) @map("is_active")
  createdAt            DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  learningObject LearningObject          @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  sharedBy       TeacherProfile          @relation(fields: [sharedByUserId], references: [userId], onDelete: Cascade)
  tags           ContentShareTag[]
  reviews        ContentReview[]
  ratings        ContentRating[]
  forks          ContentFork[]
  collectionItems CollectionItem[]

  @@unique([learningObjectId, sharedByUserId])
  @@index([visibility, isActive])
  @@index([sharedByUserId])
  @@index([tenantId])
  @@index([schoolId])
  @@index([averageRating])
  @@map("content_shares")
}

/// Tags for shared content
model ContentShareTag {
  id             String   @id @default(uuid()) @db.Uuid
  contentShareId String   @map("content_share_id") @db.Uuid
  tag            String
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  contentShare ContentShare @relation(fields: [contentShareId], references: [id], onDelete: Cascade)

  @@unique([contentShareId, tag])
  @@index([tag])
  @@map("content_share_tags")
}

/// User ratings for shared content
model ContentRating {
  id             String   @id @default(uuid()) @db.Uuid
  contentShareId String   @map("content_share_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  rating         Int      // 1-5 stars
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  contentShare ContentShare @relation(fields: [contentShareId], references: [id], onDelete: Cascade)

  @@unique([contentShareId, userId])
  @@index([contentShareId])
  @@map("content_ratings")
}

/// Detailed reviews for shared content
model ContentReview {
  id             String   @id @default(uuid()) @db.Uuid
  contentShareId String   @map("content_share_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  rating         Int      // 1-5 stars
  title          String
  comment        String
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  contentShare ContentShare @relation(fields: [contentShareId], references: [id], onDelete: Cascade)

  @@unique([contentShareId, userId])
  @@index([contentShareId, createdAt(sort: Desc)])
  @@map("content_reviews")
}

/// Track forked/remixed content
model ContentFork {
  id                     String   @id @default(uuid()) @db.Uuid
  originalContentShareId String   @map("original_content_share_id") @db.Uuid
  forkedLearningObjectId String   @map("forked_learning_object_id") @db.Uuid
  forkedByUserId         String   @map("forked_by_user_id") @db.Uuid
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz

  originalContentShare ContentShare   @relation(fields: [originalContentShareId], references: [id], onDelete: Cascade)
  forkedLearningObject LearningObject @relation(fields: [forkedLearningObjectId], references: [id], onDelete: Cascade)

  @@index([originalContentShareId])
  @@index([forkedLearningObjectId])
  @@index([forkedByUserId])
  @@map("content_forks")
}

// ══════════════════════════════════════════════════════════════════════════════
// TEACHER COMMUNITY
// ══════════════════════════════════════════════════════════════════════════════

/// Teacher profile with community features
model TeacherProfile {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  displayName    String?  @map("display_name")
  bio            String?
  school         String?
  district       String?
  subjects       String[] // Array of subjects they teach
  gradeBands     String[] @map("grade_bands") // Array of grade bands
  avatarUrl      String?  @map("avatar_url")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  sharedContent ContentShare[]
  followers     TeacherFollow[] @relation("Following")
  following     TeacherFollow[] @relation("Follower")
  collections   ContentCollection[]

  @@index([school])
  @@index([district])
  @@map("teacher_profiles")
}

/// Teacher following relationships
model TeacherFollow {
  id          String   @id @default(uuid()) @db.Uuid
  followerId  String   @map("follower_id") @db.Uuid
  followingId String   @map("following_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  follower  TeacherProfile @relation("Follower", fields: [followerId], references: [userId], onDelete: Cascade)
  following TeacherProfile @relation("Following", fields: [followingId], references: [userId], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("teacher_follows")
}

/// Content collections/playlists created by teachers
model ContentCollection {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  teacher TeacherProfile   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  items   CollectionItem[]
  tags    CollectionTag[]

  @@index([userId])
  @@index([isPublic])
  @@map("content_collections")
}

/// Items in a content collection
model CollectionItem {
  id             String   @id @default(uuid()) @db.Uuid
  collectionId   String   @map("collection_id") @db.Uuid
  contentShareId String   @map("content_share_id") @db.Uuid
  notes          String?
  addedAt        DateTime @default(now()) @map("added_at") @db.Timestamptz

  collection   ContentCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  contentShare ContentShare      @relation(fields: [contentShareId], references: [id], onDelete: Cascade)

  @@unique([collectionId, contentShareId])
  @@index([collectionId])
  @@map("collection_items")
}

/// Tags for collections
model CollectionTag {
  id           String   @id @default(uuid()) @db.Uuid
  collectionId String   @map("collection_id") @db.Uuid
  tag          String
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  collection ContentCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, tag])
  @@index([tag])
  @@map("collection_tags")
}
