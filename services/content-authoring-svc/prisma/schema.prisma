generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

enum LearningObjectSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  OTHER

  @@map("learning_object_subject")
}

enum LearningObjectGradeBand {
  K_2
  G3_5
  G6_8
  G9_12

  @@map("learning_object_grade_band")
}

enum LearningObjectVersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED

  @@map("learning_object_version_state")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Logical identity of a learning content unit.
model LearningObject {
  id               String                   @id @default(uuid()) @db.Uuid
  tenantId         String?                  @map("tenant_id") @db.Uuid
  slug             String
  title            String
  subject          LearningObjectSubject
  gradeBand        LearningObjectGradeBand  @map("grade_band")
  primarySkillId   String?                  @map("primary_skill_id") @db.Uuid
  isActive         Boolean                  @default(true) @map("is_active")
  createdByUserId  String                   @map("created_by_user_id") @db.Uuid
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  versions LearningObjectVersion[]
  tags     LearningObjectTag[]

  @@unique([tenantId, slug])
  @@index([tenantId, subject, gradeBand])
  @@index([primarySkillId])
  @@map("learning_objects")
}

/// Versioned content with review workflow.
model LearningObjectVersion {
  id                 String                      @id @default(uuid()) @db.Uuid
  learningObjectId   String                      @map("learning_object_id") @db.Uuid
  versionNumber      Int                         @map("version_number")
  state              LearningObjectVersionState  @default(DRAFT)
  createdByUserId    String                      @map("created_by_user_id") @db.Uuid
  reviewedByUserId   String?                     @map("reviewed_by_user_id") @db.Uuid
  approvedByUserId   String?                     @map("approved_by_user_id") @db.Uuid
  changeSummary      String?                     @map("change_summary")
  legacyReviewNotes  String?                     @map("review_notes") // Deprecated: use reviewNotesList
  contentJson        Json                        @map("content_json")
  accessibilityJson  Json                        @default("{}") @map("accessibility_json")
  standardsJson      Json                        @default("{}") @map("standards_json")
  metadataJson       Json                        @default("{}") @map("metadata_json")
  createdAt          DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                    @updatedAt @map("updated_at") @db.Timestamptz
  publishedAt        DateTime?                   @map("published_at") @db.Timestamptz
  retiredAt          DateTime?                   @map("retired_at") @db.Timestamptz

  learningObject    LearningObject                   @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  skills            LearningObjectSkill[]
  transitions       LearningObjectVersionTransition[]
  qaChecks          LearningObjectVersionCheck[]
  reviewNotesList   LearningObjectVersionReviewNote[]

  @@unique([learningObjectId, versionNumber])
  @@index([learningObjectId, state, versionNumber(sort: Desc)])
  @@index([state])
  @@map("learning_object_versions")
}

/// Flexible tags for content discovery and filtering.
model LearningObjectTag {
  id               String   @id @default(uuid()) @db.Uuid
  learningObjectId String   @map("learning_object_id") @db.Uuid
  tag              String
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObject LearningObject @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)

  @@unique([learningObjectId, tag])
  @@index([tag])
  @@map("learning_object_tags")
}

/// Version-specific skill alignments.
model LearningObjectSkill {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  skillId                  String   @map("skill_id") @db.Uuid
  isPrimary                Boolean  @default(false) @map("is_primary")
  weight                   Decimal? @db.Decimal(4, 3)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, skillId])
  @@index([skillId])
  @@map("learning_object_skills")
}

/// Audit trail for workflow state changes.
model LearningObjectVersionTransition {
  id                    String                      @id @default(uuid()) @db.Uuid
  versionId             String                      @map("version_id") @db.Uuid
  fromState             LearningObjectVersionState  @map("from_state")
  toState               LearningObjectVersionState  @map("to_state")
  transitionedByUserId  String                      @map("transitioned_by_user_id") @db.Uuid
  reason                String?
  transitionedAt        DateTime                    @default(now()) @map("transitioned_at") @db.Timestamptz

  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("learning_object_version_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// QA CHECKS & REVIEW NOTES
// ══════════════════════════════════════════════════════════════════════════════

enum QaCheckType {
  ACCESSIBILITY
  METADATA_COMPLETENESS
  POLICY_LANGUAGE
  CONTENT_STRUCTURE
  SKILL_ALIGNMENT

  @@map("qa_check_type")
}

enum QaCheckStatus {
  PASSED
  WARNING
  FAILED

  @@map("qa_check_status")
}

/// Automated QA check results for a version.
model LearningObjectVersionCheck {
  id                       String                @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String                @map("learning_object_version_id") @db.Uuid
  checkType                QaCheckType           @map("check_type")
  status                   QaCheckStatus
  message                  String
  details                  Json?                 @default("{}")
  createdAt                DateTime              @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@index([learningObjectVersionId, checkType])
  @@index([status])
  @@map("learning_object_version_checks")
}

/// Reviewer notes attached to a version during review.
model LearningObjectVersionReviewNote {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  authorUserId             String   @map("author_user_id") @db.Uuid
  noteText                 String   @map("note_text")
  noteType                 String   @default("GENERAL") @map("note_type") // GENERAL, APPROVAL, REJECTION, FEEDBACK
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@index([learningObjectVersionId, createdAt(sort: Desc)])
  @@map("learning_object_version_review_notes")
}
