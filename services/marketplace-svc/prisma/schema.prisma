// ══════════════════════════════════════════════════════════════════════════════
// MARKETPLACE SERVICE - PRISMA SCHEMA
// ══════════════════════════════════════════════════════════════════════════════
//
// This schema defines the Marketplace & Catalog domain model for the Aivo platform.
// It supports:
//   - Vendors (Aivo internal or third-party publishers)
//   - Marketplace Items (content packs, embedded tools)
//   - Versioned releases with review workflow
//   - Tenant/school/classroom-level installations
//   - Approval governance for both items and installations
//
// ══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Vendor type - Aivo internal or external third-party
enum VendorType {
  AIVO         // Aivo-authored content
  THIRD_PARTY  // External publisher/developer

  @@map("vendor_type")
}

/// Type of marketplace item
enum MarketplaceItemType {
  CONTENT_PACK   // Set of Learning Objects (LOs) or LO families
  EMBEDDED_TOOL  // Third-party app/tool integration

  @@map("marketplace_item_type")
}

/// Subject areas (aligned with LearningObjectSubject)
enum MarketplaceSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  STEM
  SOCIAL_STUDIES
  ARTS
  FOREIGN_LANGUAGE
  OTHER

  @@map("marketplace_subject")
}

/// Grade bands (aligned with LearningObjectGradeBand)
enum MarketplaceGradeBand {
  PRE_K
  K_2
  G3_5
  G6_8
  G9_12
  ALL_GRADES

  @@map("marketplace_grade_band")
}

/// Content/tool modalities
enum MarketplaceModality {
  GAME           // Interactive game-based learning
  DRILL          // Practice/drill activities
  PROJECT        // Project-based learning
  SEL_ACTIVITY   // Social-emotional learning
  ASSESSMENT     // Formative/summative assessment
  SIMULATION     // Interactive simulation
  VIDEO          // Video-based content
  READING        // Reading/text-based content
  AUDIO          // Audio/podcast content
  MIXED          // Multiple modalities

  @@map("marketplace_modality")
}

/// Version review status for Aivo internal review
enum MarketplaceVersionStatus {
  DRAFT           // Being prepared by vendor
  PENDING_REVIEW  // Submitted for Aivo review
  IN_REVIEW       // Being reviewed by Aivo team
  APPROVED        // Approved and ready for publishing
  REJECTED        // Rejected with feedback
  PUBLISHED       // Live in marketplace
  DEPRECATED      // No longer available for new installs

  @@map("marketplace_version_status")
}

/// Installation status for tenant/school/classroom
enum InstallationStatus {
  PENDING_APPROVAL  // Awaiting admin approval
  ACTIVE            // Installed and enabled
  DISABLED          // Temporarily disabled by admin
  REVOKED           // Permanently removed

  @@map("installation_status")
}

/// Launch type for embedded tools
enum EmbeddedToolLaunchType {
  IFRAME_WEB       // Web iframe embed
  NATIVE_DEEPLINK  // Mobile deep link
  LTI_LIKE         // LTI-style launch with signed params

  @@map("embedded_tool_launch_type")
}

/// Pricing model for marketplace items (display/marketing)
enum PricingModel {
  FREE              // Completely free
  FREE_TRIAL        // Free trial, then paid
  PAID_PER_SEAT     // Per-student pricing
  PAID_FLAT_RATE    // Flat rate per tenant/school
  FREEMIUM          // Free with premium features
  CUSTOM            // Contact for pricing

  @@map("pricing_model")
}

/// Billing model for marketplace items (actual billing logic)
enum MarketplaceBillingModel {
  FREE              // No charge, included with core license
  TENANT_FLAT       // Flat fee per tenant/organization
  PER_SEAT          // Per-seat/per-learner pricing

  @@map("marketplace_billing_model")
}

/// Billing status for marketplace installations
enum MarketplaceBillingStatus {
  PENDING           // Awaiting billing setup
  ACTIVE            // Billing active
  CANCELED          // Billing canceled
  EXPIRED           // Billing expired (contract ended)

  @@map("marketplace_billing_status")
}

/// Safety certification level
enum SafetyCertification {
  AIVO_CERTIFIED    // Fully vetted by Aivo safety team
  VENDOR_ATTESTED   // Vendor self-certification
  PENDING_REVIEW    // Under safety review
  NOT_REVIEWED      // No safety review yet

  @@map("safety_certification")
}

/// Safety rating for marketplace item versions
enum SafetyRating {
  PENDING           // Awaiting safety review
  APPROVED_K12      // Approved for K-12 use
  RESTRICTED        // Approved with restrictions
  REJECTED          // Not approved for use

  @@map("safety_rating")
}

/// Data access profile for embedded tools
enum DataAccessProfile {
  MINIMAL           // Pseudonymous learner ID only
  MODERATE          // Pseudonymous ID + progress data
  HIGH              // Extended profile access (with consent)

  @@map("data_access_profile")
}

/// Safety review action types
enum SafetyReviewAction {
  SUBMITTED         // Version submitted for safety review
  STARTED           // Safety review started
  DATA_TAGGED       // Data access categories tagged
  CHECKS_COMPLETED  // Automated checks completed
  APPROVED          // Safety reviewer approved
  REJECTED          // Safety reviewer rejected
  ESCALATED         // Escalated for further review

  @@map("safety_review_action")
}

// ══════════════════════════════════════════════════════════════════════════════
// VENDORS
// ══════════════════════════════════════════════════════════════════════════════
//
// Publishers and developers who provide content or tools in the marketplace.
// Aivo is also a vendor for first-party content packs.
//

/// Vendor entity - content/tool publisher
model Vendor {
  id            String      @id @default(uuid()) @db.Uuid
  
  /// Unique slug identifier (e.g., "aivo", "math-blasters-inc")
  slug          String      @unique
  
  /// Display name
  name          String
  
  /// Vendor type
  type          VendorType
  
  /// Primary contact email
  contactEmail  String      @map("contact_email")
  
  /// Public website URL
  websiteUrl    String?     @map("website_url")
  
  /// Logo image URL
  logoUrl       String?     @map("logo_url")
  
  /// Short description/tagline
  description   String?
  
  /// Whether vendor is verified/approved by Aivo
  isVerified    Boolean     @default(false) @map("is_verified")
  
  /// Whether vendor is active (can publish items)
  isActive      Boolean     @default(true) @map("is_active")
  
  /// Metadata: legal info, compliance certs, etc.
  metadataJson  Json?       @map("metadata_json")
  
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketplaceItems    MarketplaceItem[]
  revenueShares       VendorRevenueShare[]
  allowedDomains      EmbeddedToolDomainAllowlist[]

  @@index([type, isActive])
  @@index([isVerified])
  @@map("vendors")
}

// ══════════════════════════════════════════════════════════════════════════════
// VENDOR REVENUE SHARES
// ══════════════════════════════════════════════════════════════════════════════
//
// Revenue sharing configuration for third-party vendors.
// Tracks what percentage of revenue goes to the vendor for each SKU.
//

/// Revenue share configuration for a vendor's SKU
model VendorRevenueShare {
  id                  String    @id @default(uuid()) @db.Uuid
  
  /// Vendor receiving the revenue share
  vendorId            String    @map("vendor_id") @db.Uuid
  
  /// SKU this share agreement applies to
  sku                 String
  
  /// Vendor's share percentage (e.g., 30.00 = 30%)
  sharePercent        Decimal   @map("share_percent") @db.Decimal(5, 2)
  
  /// When this share agreement becomes effective
  effectiveStartDate  DateTime  @default(now()) @map("effective_start_date") @db.Date
  
  /// When this share agreement ends (null = ongoing)
  effectiveEndDate    DateTime? @map("effective_end_date") @db.Date
  
  /// User who created this agreement
  createdByUserId     String?   @map("created_by_user_id") @db.Uuid
  
  /// Notes about this agreement
  notes               String?
  
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([sku])
  @@index([effectiveStartDate, effectiveEndDate])
  @@map("vendor_revenue_shares")
}

// ══════════════════════════════════════════════════════════════════════════════
// MARKETPLACE ITEMS
// ══════════════════════════════════════════════════════════════════════════════
//
// The catalog listing for a content pack or embedded tool.
// This is the discoverable entity in the marketplace.
//

/// Marketplace item (content pack or embedded tool)
model MarketplaceItem {
  id               String                @id @default(uuid()) @db.Uuid
  
  /// Reference to the vendor
  vendorId         String                @map("vendor_id") @db.Uuid
  
  /// Unique URL-friendly identifier
  slug             String                @unique
  
  /// Type of item
  itemType         MarketplaceItemType   @map("item_type")
  
  /// Display title
  title            String
  
  /// Short description (for cards/lists)
  shortDescription String                @map("short_description")
  
  /// Full marketing description (supports markdown)
  longDescription  String                @map("long_description")
  
  /// Applicable subjects
  subjects         MarketplaceSubject[]
  
  /// Applicable grade bands
  gradeBands       MarketplaceGradeBand[] @map("grade_bands")
  
  /// Content modalities
  modalities       MarketplaceModality[]
  
  /// Icon/thumbnail URL
  iconUrl          String?               @map("icon_url")
  
  /// Screenshot gallery (array of {url, caption, order})
  screenshotsJson  Json?                 @map("screenshots_json")
  
  /// Whether item is active in marketplace
  isActive         Boolean               @default(true) @map("is_active")
  
  /// Whether item is featured/promoted
  isFeatured       Boolean               @default(false) @map("is_featured")
  
  /// Pricing model (display/marketing)
  pricingModel     PricingModel          @default(FREE) @map("pricing_model")
  
  /// Price in cents (for simple pricing; null if complex/custom)
  priceCents       Int?                  @map("price_cents")
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Billing Configuration
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// Whether the item is free (no billing required)
  isFree           Boolean               @default(true) @map("is_free")
  
  /// Billing model for actual billing logic
  billingModel     MarketplaceBillingModel @default(FREE) @map("billing_model")
  
  /// Reference to billing SKU in billing-svc (e.g., MPK_FRACTIONS_G3_5)
  billingSku       String?               @map("sku")
  
  /// Additional billing config: { "trialDays": 30, "minSeats": 10, "pricePerSeatCents": 500 }
  billingMetadataJson Json?              @map("billing_metadata_json")
  
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// Safety certification level
  safetyCert       SafetyCertification   @default(NOT_REVIEWED) @map("safety_cert")
  
  /// Additional metadata (alignment standards, languages, etc.)
  /// Example: { "standards": ["CCSS.MATH.K.OA"], "languages": ["en", "es"] }
  metadataJson     Json?                 @map("metadata_json")
  
  /// Search optimization keywords
  searchKeywords   String[]              @default([]) @map("search_keywords")
  
  /// Average rating (0-5, updated by trigger/job)
  avgRating        Decimal?              @map("avg_rating") @db.Decimal(3, 2)
  
  /// Total number of installations
  totalInstalls    Int                   @default(0) @map("total_installs")
  
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  vendor       Vendor                     @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  versions     MarketplaceItemVersion[]
  installations MarketplaceInstallation[]
  reviews      MarketplaceReview[]
  licenses     TenantContentLicense[]

  @@index([vendorId])
  @@index([itemType, isActive])
  @@index([isActive, isFeatured])
  @@index([subjects])
  @@index([gradeBands])
  @@index([pricingModel])
  @@index([safetyCert])
  @@index([isFree, billingModel])
  @@index([billingSku])
  @@map("marketplace_items")
}

// ══════════════════════════════════════════════════════════════════════════════
// MARKETPLACE ITEM VERSIONS
// ══════════════════════════════════════════════════════════════════════════════
//
// Versioned releases of marketplace items with review workflow.
// Each version goes through approval before publishing.
//

/// Versioned release of a marketplace item
model MarketplaceItemVersion {
  id                   String                    @id @default(uuid()) @db.Uuid
  
  /// Parent marketplace item
  marketplaceItemId    String                    @map("marketplace_item_id") @db.Uuid
  
  /// Semantic version string (e.g., "1.0.0", "2.1.3")
  version              String
  
  /// Version status in review workflow
  status               MarketplaceVersionStatus  @default(DRAFT)
  
  /// Changelog/release notes for this version
  changelog            String?
  
  /// Internal review notes (from Aivo reviewers)
  reviewNotes          String?                   @map("review_notes")
  
  /// User who submitted this version
  submittedByUserId    String?                   @map("submitted_by_user_id") @db.Uuid
  
  /// User who reviewed this version
  reviewedByUserId     String?                   @map("reviewed_by_user_id") @db.Uuid
  
  /// User who approved/rejected this version
  approvedByUserId     String?                   @map("approved_by_user_id") @db.Uuid
  
  /// Timestamp when submitted for review
  submittedAt          DateTime?                 @map("submitted_at") @db.Timestamptz
  
  /// Timestamp when review completed
  reviewedAt           DateTime?                 @map("reviewed_at") @db.Timestamptz
  
  /// Timestamp when published
  publishedAt          DateTime?                 @map("published_at") @db.Timestamptz
  
  /// Timestamp when deprecated
  deprecatedAt         DateTime?                 @map("deprecated_at") @db.Timestamptz
  
  /// Reason for deprecation
  deprecationReason    String?                   @map("deprecation_reason")
  
  /// Display name for the version (optional marketing name)
  displayName          String?                   @map("display_name")
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Safety & Moderation Fields
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// Safety rating classification
  safetyRating               SafetyRating              @default(PENDING) @map("safety_rating")
  
  /// Data access level categorization
  dataAccessProfile          DataAccessProfile         @default(MINIMAL) @map("data_access_profile")
  
  /// Safety reviewer's notes
  safetyNotes                String?                   @map("safety_notes")
  
  /// Policy tags (e.g., ["NO_CHAT", "NO_VIDEO", "NO_USER_GENERATED_CONTENT"])
  policyTags                 String[]                  @default([]) @map("policy_tags")
  
  /// Data categories accessed (e.g., ["pseudonymous_learner_id", "progress_data"])
  dataCategoriesAccessed     String[]                  @default([]) @map("data_categories_accessed")
  
  /// User who performed safety review
  safetyReviewedByUserId     String?                   @map("safety_reviewed_by_user_id") @db.Uuid
  
  /// Timestamp when safety review completed
  safetyReviewedAt           DateTime?                 @map("safety_reviewed_at") @db.Timestamptz
  
  /// Results from automated safety checks
  automatedChecksJson        Json?                     @map("automated_checks_json")
  
  /// Whether automated checks passed
  automatedChecksPassed      Boolean?                  @map("automated_checks_passed")
  
  // ─────────────────────────────────────────────────────────────────────────────
  
  createdAt            DateTime                  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime                  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketplaceItem       MarketplaceItem           @relation(fields: [marketplaceItemId], references: [id], onDelete: Cascade)
  contentPackItems      ContentPackItem[]
  embeddedToolConfig    EmbeddedToolConfig?
  installations         MarketplaceInstallation[]
  statusTransitions     VersionStatusTransition[]
  safetyReviewLogs      SafetyReviewLog[]
  licenses              TenantContentLicense[]

  @@unique([marketplaceItemId, version])
  @@index([marketplaceItemId, status])
  @@index([status, publishedAt(sort: Desc)])
  @@index([safetyRating])
  @@index([policyTags])
  @@map("marketplace_item_versions")
}

/// Audit trail for version status changes
model VersionStatusTransition {
  id                   String                    @id @default(uuid()) @db.Uuid
  
  /// Version that transitioned
  versionId            String                    @map("version_id") @db.Uuid
  
  /// Previous status
  fromStatus           MarketplaceVersionStatus  @map("from_status")
  
  /// New status
  toStatus             MarketplaceVersionStatus  @map("to_status")
  
  /// User who performed the transition
  transitionedByUserId String                    @map("transitioned_by_user_id") @db.Uuid
  
  /// Reason/notes for transition
  reason               String?
  
  transitionedAt       DateTime                  @default(now()) @map("transitioned_at") @db.Timestamptz

  // Relations
  version MarketplaceItemVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("version_status_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT PACK SPECIFICS
// ══════════════════════════════════════════════════════════════════════════════
//
// Content packs contain references to Learning Object versions.
// This links the marketplace to the content-svc domain.
//

/// Learning Object reference within a content pack version
model ContentPackItem {
  id                        String   @id @default(uuid()) @db.Uuid
  
  /// Parent version
  marketplaceItemVersionId  String   @map("marketplace_item_version_id") @db.Uuid
  
  /// Reference to LO version in content-svc (cross-service FK)
  loVersionId               String   @map("lo_version_id") @db.Uuid
  
  /// Optional: Reference to the LO family/parent
  loId                      String?  @map("lo_id") @db.Uuid
  
  /// Display order within the pack
  position                  Int      @default(0)
  
  /// Whether this is a "highlight" or featured item in the pack
  isHighlight               Boolean  @default(false) @map("is_highlight")
  
  /// Optional metadata for this specific item in the pack
  metadataJson              Json?    @map("metadata_json")
  
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  version MarketplaceItemVersion @relation(fields: [marketplaceItemVersionId], references: [id], onDelete: Cascade)

  @@unique([marketplaceItemVersionId, loVersionId])
  @@index([marketplaceItemVersionId, position])
  @@index([loVersionId])
  @@map("content_pack_items")
}

// ══════════════════════════════════════════════════════════════════════════════
// EMBEDDED TOOL SPECIFICS
// ══════════════════════════════════════════════════════════════════════════════
//
// Configuration for third-party tool integrations.
// Defines how tools are launched and what data they can access.
//

/// Configuration for an embedded tool version
model EmbeddedToolConfig {
  id                        String                  @id @default(uuid()) @db.Uuid
  
  /// Parent version (1:1 relationship)
  marketplaceItemVersionId  String                  @unique @map("marketplace_item_version_id") @db.Uuid
  
  /// Launch URL template (may include placeholders)
  launchUrl                 String                  @map("launch_url")
  
  /// How the tool is launched
  launchType                EmbeddedToolLaunchType  @map("launch_type")
  
  /// Required data scopes for this tool
  /// Example: ["LEARNER_PROFILE_MIN", "SESSION_EVENTS_WRITE", "PROGRESS_READ"]
  requiredScopes            String[]                @default([]) @map("required_scopes")
  
  /// Optional scopes that enhance functionality
  optionalScopes            String[]                @default([]) @map("optional_scopes")
  
  /// JSON Schema for tool-specific configuration
  /// Defines what settings tenants can customize
  configSchemaJson          Json?                   @map("config_schema_json")
  
  /// Default configuration values
  defaultConfigJson         Json?                   @map("default_config_json")
  
  /// Webhook URL for receiving events from Aivo
  webhookUrl                String?                 @map("webhook_url")
  
  /// Shared secret for webhook signing
  webhookSecret             String?                 @map("webhook_secret")
  
  /// OAuth client ID (if tool uses OAuth)
  oauthClientId             String?                 @map("oauth_client_id")
  
  /// OAuth callback URL
  oauthCallbackUrl          String?                 @map("oauth_callback_url")
  
  /// Content Security Policy additions for iframe
  cspDirectives             String?                 @map("csp_directives")
  
  /// Sandbox attributes for iframe
  sandboxAttributes         String[]                @default([]) @map("sandbox_attributes")
  
  createdAt                 DateTime                @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime                @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  version MarketplaceItemVersion @relation(fields: [marketplaceItemVersionId], references: [id], onDelete: Cascade)

  @@map("embedded_tool_configs")
}

// ══════════════════════════════════════════════════════════════════════════════
// INSTALLATIONS
// ══════════════════════════════════════════════════════════════════════════════
//
// Records of items installed at tenant/school/classroom level.
// Supports hierarchical enablement with admin approval workflow.
//

/// Installation of a marketplace item for a tenant/school/classroom
model MarketplaceInstallation {
  id                        String              @id @default(uuid()) @db.Uuid
  
  /// The installed item
  marketplaceItemId         String              @map("marketplace_item_id") @db.Uuid
  
  /// Specific version installed
  marketplaceItemVersionId  String              @map("marketplace_item_version_id") @db.Uuid
  
  /// Tenant where installed (always required)
  tenantId                  String              @map("tenant_id") @db.Uuid
  
  /// Optional: Specific school (null = tenant-wide)
  schoolId                  String?             @map("school_id") @db.Uuid
  
  /// Optional: Specific classroom (null = school-wide or tenant-wide)
  classroomId               String?             @map("classroom_id") @db.Uuid
  
  /// User who initiated the installation
  installedByUserId         String              @map("installed_by_user_id") @db.Uuid
  
  /// User who approved (if different from installer)
  approvedByUserId          String?             @map("approved_by_user_id") @db.Uuid
  
  /// Installation status
  status                    InstallationStatus  @default(PENDING_APPROVAL)
  
  /// Tenant/school/classroom-specific configuration
  /// Merged with tool's default config on launch
  configJson                Json?               @map("config_json")
  
  /// Why this item was installed (for auditing)
  installReason             String?             @map("install_reason")
  
  /// Notes from approver (e.g., "Approved for pilot program")
  approvalNotes             String?             @map("approval_notes")
  
  /// When installation was requested
  installedAt               DateTime            @default(now()) @map("installed_at") @db.Timestamptz
  
  /// When installation was approved
  approvedAt                DateTime?           @map("approved_at") @db.Timestamptz
  
  /// When installation was disabled/revoked
  disabledAt                DateTime?           @map("disabled_at") @db.Timestamptz
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Billing Linkage
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// FK to billing-svc contract_line_items (cross-service reference)
  contractLineItemId        String?             @map("contract_line_item_id") @db.Uuid
  
  /// Billing status for this installation
  billingStatus             MarketplaceBillingStatus @default(PENDING) @map("billing_status")
  
  /// When billing started for this installation
  billingStartedAt          DateTime?           @map("billing_started_at") @db.Timestamptz
  
  /// When billing ended (cancellation/expiry)
  billingEndedAt            DateTime?           @map("billing_ended_at") @db.Timestamptz
  
  /// Number of seats for PER_SEAT billing model
  seatQuantity              Int?                @map("seat_quantity")
  
  /// Additional billing info: { "priceAtInstall": 1000, "contractId": "..." }
  billingMetadataJson       Json?               @map("billing_metadata_json")
  
  // ─────────────────────────────────────────────────────────────────────────────
  
  updatedAt                 DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketplaceItem    MarketplaceItem        @relation(fields: [marketplaceItemId], references: [id], onDelete: Restrict)
  version            MarketplaceItemVersion @relation(fields: [marketplaceItemVersionId], references: [id], onDelete: Restrict)
  statusTransitions  InstallationStatusTransition[]

  // Ensure unique installation per scope level
  @@unique([marketplaceItemId, tenantId, schoolId, classroomId])
  @@index([tenantId, status])
  @@index([schoolId, status])
  @@index([classroomId, status])
  @@index([marketplaceItemId, status])
  @@index([installedByUserId])
  @@index([billingStatus, billingStartedAt])
  @@index([contractLineItemId])
  @@map("marketplace_installations")
}

/// Audit trail for installation status changes
model InstallationStatusTransition {
  id                   String              @id @default(uuid()) @db.Uuid
  
  /// Installation that transitioned
  installationId       String              @map("installation_id") @db.Uuid
  
  /// Previous status
  fromStatus           InstallationStatus  @map("from_status")
  
  /// New status
  toStatus             InstallationStatus  @map("to_status")
  
  /// User who performed the transition
  transitionedByUserId String              @map("transitioned_by_user_id") @db.Uuid
  
  /// Reason/notes for transition
  reason               String?
  
  transitionedAt       DateTime            @default(now()) @map("transitioned_at") @db.Timestamptz

  // Relations
  installation MarketplaceInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@index([installationId, transitionedAt(sort: Desc)])
  @@map("installation_status_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// REVIEWS & RATINGS
// ══════════════════════════════════════════════════════════════════════════════
//
// User reviews and ratings for marketplace items.
//

/// User review of a marketplace item
model MarketplaceReview {
  id                  String   @id @default(uuid()) @db.Uuid
  
  /// Item being reviewed
  marketplaceItemId   String   @map("marketplace_item_id") @db.Uuid
  
  /// User who wrote the review
  reviewerUserId      String   @map("reviewer_user_id") @db.Uuid
  
  /// Reviewer's tenant (for filtering reviews by similar tenants)
  reviewerTenantId    String   @map("reviewer_tenant_id") @db.Uuid
  
  /// Rating (1-5 stars)
  rating              Int
  
  /// Review title
  title               String?
  
  /// Review body (markdown supported)
  body                String?
  
  /// Whether review is from verified installation
  isVerifiedInstall   Boolean  @default(false) @map("is_verified_install")
  
  /// Whether review is approved for public display
  isApproved          Boolean  @default(true) @map("is_approved")
  
  /// Whether review is flagged for moderation
  isFlagged           Boolean  @default(false) @map("is_flagged")
  
  /// Helpful vote count
  helpfulCount        Int      @default(0) @map("helpful_count")
  
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketplaceItem MarketplaceItem @relation(fields: [marketplaceItemId], references: [id], onDelete: Cascade)

  @@unique([marketplaceItemId, reviewerUserId])
  @@index([marketplaceItemId, isApproved, rating])
  @@index([reviewerTenantId])
  @@map("marketplace_reviews")
}

// ══════════════════════════════════════════════════════════════════════════════
// FEATURED COLLECTIONS
// ══════════════════════════════════════════════════════════════════════════════
//
// Curated collections of marketplace items for discovery.
//

/// Curated collection of marketplace items
model MarketplaceCollection {
  id            String   @id @default(uuid()) @db.Uuid
  
  /// URL-friendly identifier
  slug          String   @unique
  
  /// Collection title
  title         String
  
  /// Collection description
  description   String?
  
  /// Cover image URL
  coverImageUrl String?  @map("cover_image_url")
  
  /// Whether collection is active/visible
  isActive      Boolean  @default(true) @map("is_active")
  
  /// Display order (lower = higher priority)
  displayOrder  Int      @default(0) @map("display_order")
  
  /// Target audience (e.g., "teachers", "district_admins")
  targetAudience String[] @default([]) @map("target_audience")
  
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  items MarketplaceCollectionItem[]

  @@index([isActive, displayOrder])
  @@map("marketplace_collections")
}

/// Item within a collection
model MarketplaceCollectionItem {
  id                  String   @id @default(uuid()) @db.Uuid
  
  /// Parent collection
  collectionId        String   @map("collection_id") @db.Uuid
  
  /// Marketplace item
  marketplaceItemId   String   @map("marketplace_item_id") @db.Uuid
  
  /// Display order within collection
  position            Int      @default(0)
  
  /// Optional custom headline for this item in this collection
  customHeadline      String?  @map("custom_headline")
  
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  collection MarketplaceCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, marketplaceItemId])
  @@index([collectionId, position])
  @@map("marketplace_collection_items")
}

// ══════════════════════════════════════════════════════════════════════════════
// SAFETY & MODERATION
// ══════════════════════════════════════════════════════════════════════════════
//
// Safety review audit trails, tenant policies, and tool launch logging.
//

/// Audit trail for safety review actions
model SafetyReviewLog {
  id                        String              @id @default(uuid()) @db.Uuid
  
  /// Version being reviewed
  marketplaceItemVersionId  String              @map("marketplace_item_version_id") @db.Uuid
  
  /// Review action performed
  action                    SafetyReviewAction
  
  /// User who performed the action
  performedByUserId         String              @map("performed_by_user_id") @db.Uuid
  
  /// Previous rating (for rating changes)
  previousRating            SafetyRating?       @map("previous_rating")
  
  /// New rating (for rating changes)
  newRating                 SafetyRating?       @map("new_rating")
  
  /// Notes/comments from reviewer
  notes                     String?
  
  /// Detailed metadata (e.g., automated check results)
  metadataJson              Json?               @map("metadata_json")
  
  performedAt               DateTime            @default(now()) @map("performed_at") @db.Timestamptz

  // Relations
  version MarketplaceItemVersion @relation(fields: [marketplaceItemVersionId], references: [id], onDelete: Cascade)

  @@index([marketplaceItemVersionId, performedAt(sort: Desc)])
  @@index([action, performedAt(sort: Desc)])
  @@map("safety_review_logs")
}

/// Per-tenant marketplace policy configuration
model TenantMarketplacePolicy {
  id                          String    @id @default(uuid()) @db.Uuid
  
  /// Tenant this policy applies to
  tenantId                    String    @unique @map("tenant_id") @db.Uuid
  
  /// Allowed safety ratings (e.g., ["APPROVED_K12"])
  allowedSafetyRatings        String[]  @default(["APPROVED_K12"]) @map("allowed_safety_ratings")
  
  /// Allowed data access profiles (e.g., ["MINIMAL", "MODERATE"])
  allowedDataAccessProfiles   String[]  @default(["MINIMAL", "MODERATE"]) @map("allowed_data_access_profiles")
  
  /// Policy tags that are blocked (e.g., ["NO_CHAT", "NO_VIDEO"])
  blockedPolicyTags           String[]  @default([]) @map("blocked_policy_tags")
  
  /// Policy tags that are required (e.g., ["COPPA_VERIFIED"])
  requiredPolicyTags          String[]  @default([]) @map("required_policy_tags")
  
  /// Blocked vendors (by vendor ID)
  blockedVendors              String[]  @default([]) @map("blocked_vendors") @db.Uuid
  
  /// Blocked specific items (by marketplace_item ID)
  blockedItemIds              String[]  @default([]) @map("blocked_item_ids") @db.Uuid
  
  /// Allowed domains for embedded tools (empty = use global allowlist)
  allowedToolDomains          String[]  @default([]) @map("allowed_tool_domains")
  
  /// Blocked scopes for embedded tools
  blockedToolScopes           String[]  @default([]) @map("blocked_tool_scopes")
  
  /// Whether to require approval for all marketplace installs
  requireInstallApproval      Boolean   @default(true) @map("require_install_approval")
  
  /// Whether to allow third-party vendors
  allowThirdPartyVendors      Boolean   @default(true) @map("allow_third_party_vendors")
  
  /// Who created this policy
  createdByUserId             String?   @map("created_by_user_id") @db.Uuid
  
  /// Who last updated this policy
  updatedByUserId             String?   @map("updated_by_user_id") @db.Uuid
  
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId])
  @@map("tenant_marketplace_policies")
}

/// Global allowlist of approved domains for embedded tools
model EmbeddedToolDomainAllowlist {
  id                  String    @id @default(uuid()) @db.Uuid
  
  /// Domain pattern (e.g., "mathgames.com", "*.trusted-vendor.edu")
  domainPattern       String    @unique @map("domain_pattern")
  
  /// Whether this domain is currently allowed
  isActive            Boolean   @default(true) @map("is_active")
  
  /// Vendor this domain belongs to (optional)
  vendorId            String?   @map("vendor_id") @db.Uuid
  
  /// Notes about this domain
  notes               String?
  
  /// Who approved this domain
  approvedByUserId    String?   @map("approved_by_user_id") @db.Uuid
  
  /// When domain was approved
  approvedAt          DateTime? @map("approved_at") @db.Timestamptz
  
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  vendor Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  @@index([isActive, domainPattern])
  @@map("embedded_tool_domain_allowlist")
}

/// Configuration and metadata for embedded tool data scopes
model EmbeddedToolScopeConfig {
  id                      String            @id @default(uuid()) @db.Uuid
  
  /// Scope identifier (e.g., "LEARNER_PROFILE_MIN")
  scope                   String            @unique
  
  /// Human-readable name
  displayName             String            @map("display_name")
  
  /// Description of what this scope allows
  description             String?
  
  /// Data access level this scope implies
  dataAccessLevel         DataAccessProfile @default(MINIMAL) @map("data_access_level")
  
  /// Whether this scope is allowed globally
  isAllowed               Boolean           @default(true) @map("is_allowed")
  
  /// Whether this scope requires explicit tenant approval
  requiresTenantApproval  Boolean           @default(false) @map("requires_tenant_approval")
  
  /// Whether this scope is considered PII-sensitive
  isPiiSensitive          Boolean           @default(false) @map("is_pii_sensitive")
  
  /// Category for grouping (e.g., "learner_data", "analytics")
  category                String?
  
  createdAt               DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  @@map("embedded_tool_scope_config")
}

/// Audit log of embedded tool launches
model EmbeddedToolLaunchLog {
  id                        String        @id @default(uuid()) @db.Uuid
  
  /// Session identifier for this tool launch
  toolSessionId             String        @map("tool_session_id") @db.Uuid
  
  /// Tenant where launch occurred
  tenantId                  String        @map("tenant_id") @db.Uuid
  
  /// Marketplace item launched
  marketplaceItemId         String        @map("marketplace_item_id") @db.Uuid
  
  /// Specific version launched
  marketplaceItemVersionId  String        @map("marketplace_item_version_id") @db.Uuid
  
  /// Installation record
  installationId            String        @map("installation_id") @db.Uuid
  
  /// User who initiated the launch
  launchedByUserId          String        @map("launched_by_user_id") @db.Uuid
  
  /// Learner ID if in learner context
  learnerId                 String?       @map("learner_id") @db.Uuid
  
  /// Scopes granted for this launch
  scopesGranted             String[]      @default([]) @map("scopes_granted")
  
  /// School context (if applicable)
  schoolId                  String?       @map("school_id") @db.Uuid
  
  /// Classroom context (if applicable)
  classroomId               String?       @map("classroom_id") @db.Uuid
  
  /// Learning session (if applicable)
  sessionId                 String?       @map("session_id") @db.Uuid
  
  /// Safety rating at time of launch
  safetyRatingAtLaunch      SafetyRating  @map("safety_rating_at_launch")
  
  /// Whether launch was successful
  launchSuccessful          Boolean       @default(true) @map("launch_successful")
  
  /// Error message if launch failed
  launchError               String?       @map("launch_error")
  
  /// The launch URL used
  launchUrl                 String?       @map("launch_url")
  
  /// Client user agent
  userAgent                 String?       @map("user_agent")
  
  /// Client IP address
  ipAddress                 String?       @map("ip_address")
  
  launchedAt                DateTime      @default(now()) @map("launched_at") @db.Timestamptz

  @@index([tenantId, launchedAt(sort: Desc)])
  @@index([marketplaceItemId, launchedAt(sort: Desc)])
  @@index([toolSessionId])
  @@index([learnerId, launchedAt(sort: Desc)])
  @@map("embedded_tool_launch_logs")
}

// ══════════════════════════════════════════════════════════════════════════════
// TENANT CONTENT LICENSES
// ══════════════════════════════════════════════════════════════════════════════
//
// Formal license agreements linking tenants to marketplace items.
// Supports seat limits, grade restrictions, expiry dates, and billing integration.
// This is the source-of-truth for what a tenant has purchased/licensed.
//

/// License status
enum LicenseStatus {
  PENDING     // License created but not yet active
  ACTIVE      // License is currently valid
  SUSPENDED   // Temporarily suspended (e.g., payment issue)
  EXPIRED     // License has passed its expiry date
  CANCELED    // Administratively canceled

  @@map("license_status")
}

/// License scope type
enum LicenseScopeType {
  TENANT      // Entire tenant has access
  SCHOOL      // Specific schools have access
  GRADE_BAND  // Specific grade bands have access
  CLASSROOM   // Specific classrooms have access

  @@map("license_scope_type")
}

/// A tenant's license to access a marketplace item (content pack or tool)
model TenantContentLicense {
  id                        String              @id @default(uuid()) @db.Uuid
  
  /// Tenant that holds this license
  tenantId                  String              @map("tenant_id") @db.Uuid
  
  /// The marketplace item being licensed
  marketplaceItemId         String              @map("marketplace_item_id") @db.Uuid
  
  /// Specific version licensed (null = always use latest published)
  marketplaceItemVersionId  String?             @map("marketplace_item_version_id") @db.Uuid
  
  /// Current license status
  status                    LicenseStatus       @default(PENDING)
  
  /// How the license scope is defined
  scopeType                 LicenseScopeType    @default(TENANT)
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Scope Restrictions
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// Allowed school IDs (for SCHOOL scope type)
  allowedSchoolIds          String[]            @default([]) @map("allowed_school_ids") @db.Uuid
  
  /// Allowed grade bands (for GRADE_BAND scope type)
  allowedGradeBands         MarketplaceGradeBand[] @default([]) @map("allowed_grade_bands")
  
  /// Allowed classroom IDs (for CLASSROOM scope type)
  allowedClassroomIds       String[]            @default([]) @map("allowed_classroom_ids") @db.Uuid
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Seat Limits
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// Maximum number of concurrent seats (null = unlimited)
  seatLimit                 Int?                @map("seat_limit")
  
  /// Current seat usage (denormalized for fast queries)
  seatsUsed                 Int                 @default(0) @map("seats_used")
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Validity Period
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// When the license becomes active
  validFrom                 DateTime            @default(now()) @map("valid_from") @db.Timestamptz
  
  /// When the license expires (null = perpetual)
  validUntil                DateTime?           @map("valid_until") @db.Timestamptz
  
  /// Grace period after expiry (allows renewal without access loss)
  gracePeriodDays           Int                 @default(0) @map("grace_period_days")
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Billing Integration
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// FK to billing-svc subscription (for subscription-based licenses)
  billingSubscriptionId     String?             @map("billing_subscription_id") @db.Uuid
  
  /// FK to billing-svc contract line item (for contract-based licenses)
  billingContractLineId     String?             @map("billing_contract_line_id") @db.Uuid
  
  /// External reference (e.g., PO number, contract ID)
  externalReference         String?             @map("external_reference")
  
  /// Additional billing metadata
  billingMetadataJson       Json?               @map("billing_metadata_json")
  
  // ─────────────────────────────────────────────────────────────────────────────
  // D2C Parent License Fields
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// For D2C: Parent user who purchased (null = B2B license)
  purchaserParentUserId     String?             @map("purchaser_parent_user_id") @db.Uuid
  
  /// For D2C: Learner IDs this license covers
  learnerIds                String[]            @default([]) @map("learner_ids") @db.Uuid
  
  // ─────────────────────────────────────────────────────────────────────────────
  // Audit Fields
  // ─────────────────────────────────────────────────────────────────────────────
  
  /// User who created/provisioned this license
  createdByUserId           String?             @map("created_by_user_id") @db.Uuid
  
  /// Notes about the license
  notes                     String?
  
  createdAt                 DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketplaceItem           MarketplaceItem     @relation(fields: [marketplaceItemId], references: [id], onDelete: Restrict)
  version                   MarketplaceItemVersion? @relation(fields: [marketplaceItemVersionId], references: [id], onDelete: SetNull)
  entitlements              TenantContentEntitlement[]
  statusHistory             LicenseStatusHistory[]

  @@unique([tenantId, marketplaceItemId, purchaserParentUserId])
  @@index([tenantId, status])
  @@index([marketplaceItemId, status])
  @@index([status, validUntil])
  @@index([billingSubscriptionId])
  @@index([billingContractLineId])
  @@index([purchaserParentUserId])
  @@map("tenant_content_licenses")
}

/// Audit trail for license status changes
model LicenseStatusHistory {
  id                  String              @id @default(uuid()) @db.Uuid
  
  /// License that transitioned
  licenseId           String              @map("license_id") @db.Uuid
  
  /// Previous status
  fromStatus          LicenseStatus       @map("from_status")
  
  /// New status
  toStatus            LicenseStatus       @map("to_status")
  
  /// User who performed the transition
  changedByUserId     String?             @map("changed_by_user_id") @db.Uuid
  
  /// Reason/notes for transition
  reason              String?
  
  /// Source of change (e.g., "billing_webhook", "admin_action", "expiry_job")
  changeSource        String?             @map("change_source")
  
  changedAt           DateTime            @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  license TenantContentLicense @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId, changedAt(sort: Desc)])
  @@map("license_status_history")
}

// ══════════════════════════════════════════════════════════════════════════════
// TENANT CONTENT ENTITLEMENTS
// ══════════════════════════════════════════════════════════════════════════════
//
// Computed/materialized entitlements linking licenses to specific Learning Objects.
// These are derived from licenses + content pack items for fast entitlement checks.
// This table is the hot-path lookup for "can this teacher assign this LO?"
//

/// A specific entitlement to a Learning Object, derived from a license
model TenantContentEntitlement {
  id                        String              @id @default(uuid()) @db.Uuid
  
  /// Tenant that has this entitlement
  tenantId                  String              @map("tenant_id") @db.Uuid
  
  /// The license granting this entitlement
  licenseId                 String              @map("license_id") @db.Uuid
  
  /// Reference to LO family in content-svc (cross-service FK)
  loId                      String              @map("lo_id") @db.Uuid
  
  /// Reference to specific LO version in content-svc (null = latest)
  loVersionId               String?             @map("lo_version_id") @db.Uuid
  
  /// Inherited from license: allowed grade bands
  allowedGradeBands         MarketplaceGradeBand[] @default([]) @map("allowed_grade_bands")
  
  /// Inherited from license: allowed school IDs
  allowedSchoolIds          String[]            @default([]) @map("allowed_school_ids") @db.Uuid
  
  /// Whether entitlement is currently active (denormalized from license)
  isActive                  Boolean             @default(true) @map("is_active")
  
  /// When this entitlement expires (denormalized from license)
  expiresAt                 DateTime?           @map("expires_at") @db.Timestamptz
  
  createdAt                 DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  license TenantContentLicense @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([tenantId, licenseId, loId])
  @@index([tenantId, loId, isActive])
  @@index([tenantId, isActive, expiresAt])
  @@index([licenseId])
  @@index([loId])
  @@map("tenant_content_entitlements")
}

// ══════════════════════════════════════════════════════════════════════════════
// LEARNER SEAT ASSIGNMENTS
// ══════════════════════════════════════════════════════════════════════════════
//
// Tracks which learners are consuming seats from a license.
// Used for PER_SEAT billing and seat limit enforcement.
//

/// A learner's seat assignment to a licensed marketplace item
model LearnerSeatAssignment {
  id                        String              @id @default(uuid()) @db.Uuid
  
  /// The license providing the seat
  licenseId                 String              @map("license_id") @db.Uuid
  
  /// Tenant context
  tenantId                  String              @map("tenant_id") @db.Uuid
  
  /// Learner consuming the seat
  learnerId                 String              @map("learner_id") @db.Uuid
  
  /// Who assigned this seat (teacher/admin user ID)
  assignedByUserId          String              @map("assigned_by_user_id") @db.Uuid
  
  /// School context (if applicable)
  schoolId                  String?             @map("school_id") @db.Uuid
  
  /// Classroom context (if applicable)
  classroomId               String?             @map("classroom_id") @db.Uuid
  
  /// When the seat was assigned
  assignedAt                DateTime            @default(now()) @map("assigned_at") @db.Timestamptz
  
  /// When the seat was released (null = still active)
  releasedAt                DateTime?           @map("released_at") @db.Timestamptz
  
  /// Who released the seat
  releasedByUserId          String?             @map("released_by_user_id") @db.Uuid
  
  /// Reason for release
  releaseReason             String?             @map("release_reason")
  
  /// Last activity timestamp (for auto-release of inactive seats)
  lastActivityAt            DateTime            @default(now()) @map("last_activity_at") @db.Timestamptz

  @@unique([licenseId, learnerId, releasedAt])
  @@index([licenseId, releasedAt])
  @@index([tenantId, learnerId])
  @@index([schoolId])
  @@index([classroomId])
  @@index([lastActivityAt])
  @@map("learner_seat_assignments")
}
