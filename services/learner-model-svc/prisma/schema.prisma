generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── Enums ────────────────────────────────────────────────────────────────────

enum SkillDomain {
  ELA
  MATH
  SCIENCE
  SPEECH
  SEL

  @@map("skill_domain")
}

enum GradeBand {
  K5
  G6_8
  G9_12

  @@map("grade_band")
}

// ── Models ───────────────────────────────────────────────────────────────────

// ── Virtual Brain Templates ───────────────────────────────────────────────────

/// Pre-configured Virtual Brain templates for each grade band.
/// These templates serve as the "Main AIVO Brain" that gets cloned and personalized
/// for each learner after baseline assessment.
model VirtualBrainTemplate {
  id               String    @id @default(uuid()) @db.Uuid
  gradeBand        GradeBand @unique @map("grade_band")
  name             String
  description      String?
  version          String    @default("1.0")
  isActive         Boolean   @default(true) @map("is_active")

  // Default curriculum standards for this grade band
  defaultCurriculumStandards String[] @default([]) @map("default_curriculum_standards")

  // Default reading level ranges for grade band
  defaultLexileMin Int?      @map("default_lexile_min")
  defaultLexileMax Int?      @map("default_lexile_max")

  // Template skill states
  templateSkillStates TemplateSkillState[]

  // Template BKT parameters (domain-level defaults)
  templateBktDefaults Json?   @map("template_bkt_defaults")

  // Metadata for template tuning
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  createdBy        String?   @map("created_by") @db.Uuid

  @@map("virtual_brain_templates")
}

/// Default skill states in a template.
/// When cloning, these values are copied and then personalized with baseline results.
model TemplateSkillState {
  id               String   @id @default(uuid()) @db.Uuid
  templateId       String   @map("template_id") @db.Uuid
  skillCode        String   @map("skill_code")
  domain           SkillDomain

  // Default mastery level for this grade band (0-10 scale)
  defaultMastery   Decimal  @default(0) @map("default_mastery") @db.Decimal(6, 3)

  // Default BKT parameters for this skill
  defaultPLearn    Decimal  @default(0.1) @map("default_p_learn") @db.Decimal(6, 5)
  defaultPTransit  Decimal  @default(0.1) @map("default_p_transit") @db.Decimal(6, 5)
  defaultPGuess    Decimal  @default(0.2) @map("default_p_guess") @db.Decimal(6, 5)
  defaultPSlip     Decimal  @default(0.1) @map("default_p_slip") @db.Decimal(6, 5)

  // Difficulty progression parameters
  difficultyMultiplier Decimal @default(1.0) @map("difficulty_multiplier") @db.Decimal(4, 2)

  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  template         VirtualBrainTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, skillCode])
  @@index([templateId, domain])
  @@map("template_skill_states")
}

/// Master catalog of skills in the learning graph.
/// Seeded from skills library; rarely changes at runtime.
model Skill {
  id          String      @id @default(uuid()) @db.Uuid
  skillCode   String      @unique @map("skill_code")
  domain      SkillDomain
  gradeBand   GradeBand   @map("grade_band")
  displayName String      @map("display_name")
  description String?
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Prerequisites (skills that must be mastered before this one)
  prerequisiteFor SkillPrerequisite[] @relation("PrerequisiteSkill")
  hasPrerequisite SkillPrerequisite[] @relation("DependentSkill")

  // Learner states for this skill
  learnerStates LearnerSkillState[]

  @@index([domain, gradeBand])
  @@map("skills")
}

/// Edge in the skill prerequisite graph.
/// prerequisiteSkill must be mastered before dependentSkill.
model SkillPrerequisite {
  id                  String @id @default(uuid()) @db.Uuid
  prerequisiteSkillId String @map("prerequisite_skill_id") @db.Uuid
  dependentSkillId    String @map("dependent_skill_id") @db.Uuid

  prerequisiteSkill Skill @relation("PrerequisiteSkill", fields: [prerequisiteSkillId], references: [id], onDelete: Cascade)
  dependentSkill    Skill @relation("DependentSkill", fields: [dependentSkillId], references: [id], onDelete: Cascade)

  @@unique([prerequisiteSkillId, dependentSkillId])
  @@index([dependentSkillId])
  @@map("skill_prerequisites")
}

/// A learner's mastery state for a specific skill.
/// Updated as the learner progresses through learning activities.
model LearnerSkillState {
  id               String   @id @default(uuid()) @db.Uuid
  virtualBrainId   String   @map("virtual_brain_id") @db.Uuid
  skillId          String   @map("skill_id") @db.Uuid
  masteryLevel     Decimal  @map("mastery_level") @db.Decimal(6, 3)
  confidence       Decimal  @db.Decimal(5, 3)
  lastAssessedAt   DateTime @map("last_assessed_at") @db.Timestamptz
  practiceCount    Int      @default(0) @map("practice_count")
  correctStreak    Int      @default(0) @map("correct_streak")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  virtualBrain VirtualBrain @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)
  skill        Skill        @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([virtualBrainId, skillId])
  @@index([virtualBrainId, masteryLevel])
  @@map("learner_skill_states")
}

/// A learner's Virtual Brain - their personalized learning model.
/// Cloned from a grade-band template and personalized with baseline assessment results.
model VirtualBrain {
  id                 String   @id @default(uuid()) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  learnerId          String   @map("learner_id") @db.Uuid
  baselineProfileId  String?  @map("baseline_profile_id") @db.Uuid
  baselineAttemptId  String?  @map("baseline_attempt_id") @db.Uuid
  gradeBand          GradeBand @map("grade_band")

  // Reference to the template this Virtual Brain was cloned from
  sourceTemplateId   String?  @map("source_template_id") @db.Uuid
  templateVersion    String?  @map("template_version")

  initializationJson Json?    @map("initialization_json")

  // Geographic location for curriculum alignment
  stateCode          String?  @map("state_code") @db.VarChar(2)
  zipCode            String?  @map("zip_code") @db.VarChar(10)
  ncesDistrictId     String?  @map("nces_district_id")

  // Curriculum standards applied to this virtual brain
  curriculumStandards String[] @default([]) @map("curriculum_standards")
  curriculumVersion   String?  @map("curriculum_version")  // For tracking updates

  // ── Reading Level & Language Adaptation ───────────────────────────────────
  // Lexile measure: typically 0-2000 (BR for Beginning Reader = negative values)
  // Common ranges: K-1: BR-300L, 2-3: 300-600L, 4-5: 600-900L, 6-8: 900-1100L, 9-12: 1100-1400L
  lexileLevel        Int?     @map("lexile_level")                // Current estimated Lexile level
  lexileLevelLow     Int?     @map("lexile_level_low")            // Lower bound of comfort range
  lexileLevelHigh    Int?     @map("lexile_level_high")           // Upper bound (stretch level)
  lexileConfidence   Decimal? @map("lexile_confidence") @db.Decimal(4, 3) // Confidence in estimate (0-1)
  lexileLastAssessed DateTime? @map("lexile_last_assessed") @db.Timestamptz

  // Grade-equivalent reading level (e.g., 5.3 = 5th grade, 3rd month)
  readingGradeLevel  Decimal? @map("reading_grade_level") @db.Decimal(3, 1)

  // Content delivery preferences
  preferSimplifiedLanguage Boolean @default(false) @map("prefer_simplified_language")
  targetContentLexile      Int?    @map("target_content_lexile")  // Override for content delivery

  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz

  skillStates        LearnerSkillState[]
  bktSkillStates     BKTSkillState[]
  engagements        LearnerEngagement[]
  neurodiverseProfile NeurodiverseProfile?
  learningSessions   LearningSession[]
  readingAssessments ReadingLevelAssessment[]

  @@unique([tenantId, learnerId])
  @@index([tenantId, learnerId])
  @@index([stateCode])
  @@index([ncesDistrictId])
  @@map("virtual_brains")
}

/// Reading level assessment history for tracking progress.
/// Each assessment provides a point-in-time measurement of reading ability.
model ReadingLevelAssessment {
  id               String   @id @default(uuid()) @db.Uuid
  virtualBrainId   String   @map("virtual_brain_id") @db.Uuid

  // Assessment type
  assessmentType   ReadingAssessmentType @map("assessment_type")

  // Measured levels
  lexileLevel      Int      @map("lexile_level")
  gradeEquivalent  Decimal  @map("grade_equivalent") @db.Decimal(3, 1)
  confidence       Decimal  @db.Decimal(4, 3)

  // Assessment details
  wordsAssessed    Int?     @map("words_assessed")
  passagesRead     Int?     @map("passages_read")
  comprehensionScore Decimal? @map("comprehension_score") @db.Decimal(4, 3)
  fluencyWpm       Int?     @map("fluency_wpm")  // Words per minute for oral reading

  // Source data
  sourceJson       Json?    @map("source_json")  // Raw assessment data

  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  virtualBrain     VirtualBrain @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)

  @@index([virtualBrainId, createdAt(sort: Desc)])
  @@map("reading_level_assessments")
}

enum ReadingAssessmentType {
  BASELINE           // Initial assessment from onboarding
  ADAPTIVE           // Ongoing adaptive assessment during learning
  COMPREHENSION_CHECK // After reading passage
  ORAL_READING       // Oral fluency assessment (via speech recognition)
  VOCABULARY_PROBE   // Vocabulary-focused assessment

  @@map("reading_assessment_type")
}

// ── Learning Objects ─────────────────────────────────────────────────────────

/// Learning content catalog - activities, lessons, exercises.
/// Each object targets a specific skill and difficulty level.
model LearningObject {
  id               String      @id @default(uuid()) @db.Uuid
  tenantId         String?     @map("tenant_id") @db.Uuid // null = global/shared
  skillCode        String      @map("skill_code")
  domain           SkillDomain
  gradeBand        GradeBand   @map("grade_band")
  difficultyLevel  Int         @map("difficulty_level") @db.SmallInt // 1-5 scale
  objectType       LearningObjectType @map("object_type")
  title            String
  description      String?
  estimatedMinutes Int         @map("estimated_minutes") @db.SmallInt
  contentUrl       String?     @map("content_url")
  metadataJson     Json?       @map("metadata_json")
  isActive         Boolean     @default(true) @map("is_active")
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  @@index([skillCode, difficultyLevel])
  @@index([domain, gradeBand, difficultyLevel])
  @@map("learning_objects")
}

enum LearningObjectType {
  LESSON
  EXERCISE
  GAME
  VIDEO
  READING
  ASSESSMENT

  @@map("learning_object_type")
}

// ── Engagement State ─────────────────────────────────────────────────────────

enum EngagementState {
  FLOW
  ENGAGED
  BORED
  FRUSTRATED
  DISENGAGED

  @@map("engagement_state")
}

// ── BKT State & Practice History ─────────────────────────────────────────────

/// BKT parameters fitted for a learner's specific skill.
/// These parameters are learned over time from practice outcomes.
model BKTSkillState {
  id               String   @id @default(uuid()) @db.Uuid
  virtualBrainId   String   @map("virtual_brain_id") @db.Uuid
  skillId          String   @map("skill_id") @db.Uuid
  
  // Core BKT parameters
  pLearn           Decimal  @map("p_learn") @db.Decimal(6, 5)     // P(L₀) - initial knowledge probability
  pTransit         Decimal  @map("p_transit") @db.Decimal(6, 5)   // P(T) - learning rate
  pGuess           Decimal  @map("p_guess") @db.Decimal(6, 5)     // P(G) - guess probability
  pSlip            Decimal  @map("p_slip") @db.Decimal(6, 5)      // P(S) - slip probability
  
  // Current knowledge state
  pKnow            Decimal  @map("p_know") @db.Decimal(6, 5)      // P(L_n) - current knowledge probability
  
  // Performance Factor Analysis (PFA) state
  pfaSuccesses     Int      @default(0) @map("pfa_successes")
  pfaFailures      Int      @default(0) @map("pfa_failures")
  pfaBeta          Decimal  @default(0) @map("pfa_beta") @db.Decimal(8, 4)
  pfaGamma         Decimal  @default(0.1) @map("pfa_gamma") @db.Decimal(8, 4)
  pfaRho           Decimal  @default(-0.1) @map("pfa_rho") @db.Decimal(8, 4)
  
  // Learning analytics
  learningVelocity Decimal  @default(0) @map("learning_velocity") @db.Decimal(6, 4)
  lastPracticeAt   DateTime? @map("last_practice_at") @db.Timestamptz
  parametersVersion Int     @default(1) @map("parameters_version")
  
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  virtualBrain     VirtualBrain @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)
  practiceOutcomes PracticeOutcome[]

  @@unique([virtualBrainId, skillId])
  @@index([virtualBrainId])
  @@map("bkt_skill_states")
}

/// Individual practice outcome for BKT updates.
/// Each practice item creates one record; used for parameter fitting.
model PracticeOutcome {
  id               String   @id @default(uuid()) @db.Uuid
  bktSkillStateId  String   @map("bkt_skill_state_id") @db.Uuid
  learningObjectId String?  @map("learning_object_id") @db.Uuid
  
  // Outcome data
  isCorrect        Boolean  @map("is_correct")
  responseTimeMs   Int?     @map("response_time_ms")
  hintsUsed        Int      @default(0) @map("hints_used")
  attemptNumber    Int      @default(1) @map("attempt_number")
  difficultyLevel  Int?     @map("difficulty_level") @db.SmallInt
  
  // Knowledge state at time of practice
  priorPKnow       Decimal  @map("prior_p_know") @db.Decimal(6, 5)
  posteriorPKnow   Decimal  @map("posterior_p_know") @db.Decimal(6, 5)
  
  // Contextual data
  contextJson      Json?    @map("context_json")  // e.g., scaffolding level, time of day
  
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  bktSkillState    BKTSkillState @relation(fields: [bktSkillStateId], references: [id], onDelete: Cascade)

  @@index([bktSkillStateId, createdAt])
  @@map("practice_outcomes")
}

/// Learner engagement and affective state tracking.
/// Captures moment-to-moment engagement for interventions.
model LearnerEngagement {
  id               String          @id @default(uuid()) @db.Uuid
  virtualBrainId   String          @map("virtual_brain_id") @db.Uuid
  sessionId        String?         @map("session_id") @db.Uuid
  
  // Engagement scores (0-1)
  frustrationScore Decimal         @map("frustration_score") @db.Decimal(4, 3)
  boredomScore     Decimal         @map("boredom_score") @db.Decimal(4, 3)
  engagementScore  Decimal         @map("engagement_score") @db.Decimal(4, 3)
  flowScore        Decimal         @map("flow_score") @db.Decimal(4, 3)
  
  // Detected state
  state            EngagementState
  confidence       Decimal         @db.Decimal(4, 3)
  
  // Calibration data for neurodiverse learners
  baselineResponseTimeMs  Int?     @map("baseline_response_time_ms")
  responseTimeVarianceMs  Int?     @map("response_time_variance_ms")
  
  // Session context
  activitiesCompleted Int          @default(0) @map("activities_completed")
  sessionDurationMs   Int?         @map("session_duration_ms")
  
  createdAt        DateTime        @default(now()) @map("created_at") @db.Timestamptz

  virtualBrain     VirtualBrain    @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)

  @@index([virtualBrainId, createdAt])
  @@index([virtualBrainId, sessionId])
  @@map("learner_engagements")
}

/// Neurodiverse learner profile for personalized thresholds.
/// Stores calibrated parameters for BKT and engagement detection.
model NeurodiverseProfile {
  id                   String   @id @default(uuid()) @db.Uuid
  virtualBrainId       String   @unique @map("virtual_brain_id") @db.Uuid
  
  // Condition indicators (from IEP or assessment)
  hasAdhd              Boolean  @default(false) @map("has_adhd")
  hasDyslexia          Boolean  @default(false) @map("has_dyslexia")
  hasDyscalculia       Boolean  @default(false) @map("has_dyscalculia")
  hasAsd               Boolean  @default(false) @map("has_asd")
  hasProcessingDelay   Boolean  @default(false) @map("has_processing_delay")
  
  // Calibrated thresholds
  masteryThreshold     Decimal  @default(0.95) @map("mastery_threshold") @db.Decimal(4, 3)
  slipRateMultiplier   Decimal  @default(1.0) @map("slip_rate_multiplier") @db.Decimal(4, 2)
  responseTimeMultiplier Decimal @default(1.0) @map("response_time_multiplier") @db.Decimal(4, 2)
  
  // Session preferences
  maxSessionMinutes    Int      @default(45) @map("max_session_minutes")
  breakFrequencyMinutes Int     @default(15) @map("break_frequency_minutes")
  preferredInterleaving Boolean @default(true) @map("preferred_interleaving")
  
  // IEP goal tracking
  iepGoalsJson         Json?    @map("iep_goals_json")
  
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz

  virtualBrain         VirtualBrain @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)

  @@map("neurodiverse_profiles")
}

/// Learning session record for session-based analytics.
model LearningSession {
  id               String   @id @default(uuid()) @db.Uuid
  virtualBrainId   String   @map("virtual_brain_id") @db.Uuid
  
  // Session timing
  startedAt        DateTime @map("started_at") @db.Timestamptz
  endedAt          DateTime? @map("ended_at") @db.Timestamptz
  
  // Session outcomes
  activitiesPlanned   Int   @default(0) @map("activities_planned")
  activitiesCompleted Int   @default(0) @map("activities_completed")
  correctResponses    Int   @default(0) @map("correct_responses")
  totalResponses      Int   @default(0) @map("total_responses")
  
  // Engagement summary
  avgEngagementScore  Decimal? @map("avg_engagement_score") @db.Decimal(4, 3)
  frustrationEvents   Int      @default(0) @map("frustration_events")
  breaksTaken         Int      @default(0) @map("breaks_taken")
  
  // Session plan (from activity sequencer)
  sessionPlanJson     Json?    @map("session_plan_json")
  
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz

  virtualBrain        VirtualBrain @relation(fields: [virtualBrainId], references: [id], onDelete: Cascade)

  @@index([virtualBrainId, startedAt])
  @@map("learning_sessions")
}

// ── Risk Predictions & Interventions ─────────────────────────────────────────

/// Risk levels for at-risk student predictions
enum RiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL

  @@map("risk_level")
}

/// Risk trend direction
enum RiskTrend {
  INCREASING
  STABLE
  DECREASING

  @@map("risk_trend")
}

/// Intervention status
enum InterventionStatus {
  PENDING_APPROVAL
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DECLINED

  @@map("intervention_status")
}

/// Intervention type
enum InterventionType {
  ACADEMIC
  ENGAGEMENT
  BEHAVIORAL
  SOCIAL_EMOTIONAL
  PARENT_INVOLVEMENT
  PEER_SUPPORT
  TEACHER_CONTACT

  @@map("intervention_type")
}

/// Risk predictions for students - stored for historical tracking and analytics.
/// Each prediction represents a point-in-time assessment of student risk.
model RiskPrediction {
  id               String    @id @default(uuid()) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  learnerId        String    @map("learner_id") @db.Uuid
  virtualBrainId   String?   @map("virtual_brain_id") @db.Uuid
  
  // Prediction results
  riskScore        Decimal   @map("risk_score") @db.Decimal(4, 3)   // 0.000 to 1.000
  riskLevel        RiskLevel @map("risk_level")
  confidence       Decimal   @db.Decimal(4, 3)                      // 0.000 to 1.000
  
  // Category breakdown
  academicScore    Decimal   @map("academic_score") @db.Decimal(4, 3)
  engagementScore  Decimal   @map("engagement_score") @db.Decimal(4, 3)
  behavioralScore  Decimal   @map("behavioral_score") @db.Decimal(4, 3)
  temporalScore    Decimal   @map("temporal_score") @db.Decimal(4, 3)
  
  // Trend analysis
  riskTrend        RiskTrend @map("risk_trend")
  previousScore    Decimal?  @map("previous_score") @db.Decimal(4, 3)
  scoreChange      Decimal?  @map("score_change") @db.Decimal(5, 4)
  
  // Explainability - JSON arrays of risk/protective factors
  riskFactorsJson       Json @map("risk_factors_json")
  protectiveFactorsJson Json @map("protective_factors_json")
  
  // Model metadata
  modelVersion     String    @map("model_version")
  featureVersion   String    @default("1.0") @map("feature_version")
  
  // Audit
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  
  // Associated interventions
  interventions    Intervention[]

  @@index([tenantId, learnerId, createdAt(sort: Desc)])
  @@index([tenantId, riskLevel, createdAt(sort: Desc)])
  @@index([virtualBrainId, createdAt(sort: Desc)])
  @@map("risk_predictions")
}

/// Intervention assignments for at-risk students.
/// Tracks the full lifecycle from recommendation to outcome.
model Intervention {
  id                  String            @id @default(uuid()) @db.Uuid
  tenantId            String            @map("tenant_id") @db.Uuid
  learnerId           String            @map("learner_id") @db.Uuid
  riskPredictionId    String?           @map("risk_prediction_id") @db.Uuid
  
  // Intervention details
  interventionCode    String            @map("intervention_code")
  interventionType    InterventionType  @map("intervention_type")
  name                String
  description         String?
  
  // Status tracking
  status              InterventionStatus
  recommendedAt       DateTime          @map("recommended_at") @db.Timestamptz
  approvedAt          DateTime?         @map("approved_at") @db.Timestamptz
  approvedBy          String?           @map("approved_by") @db.Uuid
  startedAt           DateTime?         @map("started_at") @db.Timestamptz
  completedAt         DateTime?         @map("completed_at") @db.Timestamptz
  
  // Expected outcomes
  targetRiskFactors   String[]          @map("target_risk_factors")
  successIndicators   String[]          @map("success_indicators")
  estimatedDurationDays Int             @map("estimated_duration_days")
  
  // Consent tracking (FERPA compliance)
  requiresParentConsent Boolean         @default(false) @map("requires_parent_consent")
  parentConsentGiven   Boolean?         @map("parent_consent_given")
  parentConsentAt      DateTime?        @map("parent_consent_at") @db.Timestamptz
  
  // Outcome tracking
  initialRiskScore    Decimal           @map("initial_risk_score") @db.Decimal(4, 3)
  finalRiskScore      Decimal?          @map("final_risk_score") @db.Decimal(4, 3)
  effectivenessRating Decimal?          @map("effectiveness_rating") @db.Decimal(3, 2) // 0.00 to 1.00
  educatorNotes       String?           @map("educator_notes")
  outcomeDetailsJson  Json?             @map("outcome_details_json")
  
  // A/B testing
  experimentGroup     String?           @map("experiment_group")
  
  // Audit
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  riskPrediction      RiskPrediction?   @relation(fields: [riskPredictionId], references: [id])

  @@index([tenantId, learnerId, status])
  @@index([tenantId, status, recommendedAt(sort: Desc)])
  @@index([interventionCode, status])
  @@index([experimentGroup, status])
  @@map("interventions")
}

/// Bias severity levels
enum BiasSeverity {
  NONE
  LOW
  MODERATE
  HIGH
  CRITICAL

  @@map("bias_severity")
}

/// Bias analysis reports for fairness monitoring.
/// Aggregated results - no individual student data.
model BiasReport {
  id                  String        @id @default(uuid()) @db.Uuid
  tenantId            String        @map("tenant_id") @db.Uuid
  
  // Analysis period
  periodStart         DateTime      @map("period_start") @db.Timestamptz
  periodEnd           DateTime      @map("period_end") @db.Timestamptz
  
  // Summary
  totalPredictions    Int           @map("total_predictions")
  overallSeverity     BiasSeverity  @map("overall_severity")
  confidenceScore     Decimal       @map("confidence_score") @db.Decimal(4, 3)
  requiresReview      Boolean       @map("requires_review")
  
  // Model info
  modelVersion        String        @map("model_version")
  
  // Detailed results (JSON for flexibility)
  demographicCoverage Json          @map("demographic_coverage")
  fairnessResultsJson Json          @map("fairness_results_json")
  groupStatisticsJson Json          @map("group_statistics_json")
  recommendationsJson Json          @map("recommendations_json")
  
  // Review tracking
  reviewedAt          DateTime?     @map("reviewed_at") @db.Timestamptz
  reviewedBy          String?       @map("reviewed_by") @db.Uuid
  reviewNotes         String?       @map("review_notes")
  
  // Audit
  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamptz

  alerts              BiasAlert[]

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, overallSeverity])
  @@map("bias_reports")
}

// ── Difficulty Recommendations & Parent Approval ─────────────────────────────

/// Status of a difficulty recommendation
enum DifficultyRecommendationStatus {
  PENDING           // Awaiting parent review
  APPROVED          // Parent approved as-is
  MODIFIED          // Parent approved with modifications
  DENIED            // Parent denied the change
  AUTO_APPLIED      // Auto-applied (parent opted for auto-approval)
  EXPIRED           // Expired without action

  @@map("difficulty_recommendation_status")
}

/// Type of difficulty adjustment
enum DifficultyAdjustmentType {
  INCREASE          // Learner is ready for harder content
  DECREASE          // Learner needs easier content
  DOMAIN_SPECIFIC   // Adjustment for specific domain only
  OVERALL           // Overall difficulty adjustment

  @@map("difficulty_adjustment_type")
}

/// Difficulty recommendations requiring parent approval.
/// Generated when the system detects a learner is ready for a difficulty change.
model DifficultyRecommendation {
  id                  String                        @id @default(uuid()) @db.Uuid
  tenantId            String                        @map("tenant_id") @db.Uuid
  learnerId           String                        @map("learner_id") @db.Uuid
  virtualBrainId      String                        @map("virtual_brain_id") @db.Uuid

  // Recommendation details
  adjustmentType      DifficultyAdjustmentType      @map("adjustment_type")
  domain              SkillDomain?                  // Null if overall adjustment

  // Current and proposed levels (1-5 scale matching LearningObject.difficultyLevel)
  currentLevel        Int                           @map("current_level") @db.SmallInt
  recommendedLevel    Int                           @map("recommended_level") @db.SmallInt
  parentSetLevel      Int?                          @map("parent_set_level") @db.SmallInt  // If parent modifies

  // Evidence for the recommendation
  masteryScore        Decimal                       @map("mastery_score") @db.Decimal(4, 3)
  recentAccuracy      Decimal                       @map("recent_accuracy") @db.Decimal(4, 3)
  practiceCount       Int                           @map("practice_count")
  consecutiveSuccesses Int                          @map("consecutive_successes")

  // AI-generated explanation for the parent
  reasonTitle         String                        @map("reason_title")
  reasonDescription   String                        @map("reason_description")
  evidenceSummary     Json?                         @map("evidence_summary")

  // Status tracking
  status              DifficultyRecommendationStatus
  notificationSentAt  DateTime?                     @map("notification_sent_at") @db.Timestamptz
  viewedAt            DateTime?                     @map("viewed_at") @db.Timestamptz
  respondedAt         DateTime?                     @map("responded_at") @db.Timestamptz
  respondedBy         String?                       @map("responded_by") @db.Uuid  // Parent ID
  parentNotes         String?                       @map("parent_notes")  // Parent's reason for modification/denial

  // Expiration
  expiresAt           DateTime                      @map("expires_at") @db.Timestamptz

  // Audit
  createdAt           DateTime                      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime                      @updatedAt @map("updated_at") @db.Timestamptz
  appliedAt           DateTime?                     @map("applied_at") @db.Timestamptz

  @@index([tenantId, learnerId, status])
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([virtualBrainId, domain])
  @@index([expiresAt, status])
  @@map("difficulty_recommendations")
}

/// Parent's difficulty preferences for a learner.
/// Allows parents to set baseline preferences and auto-approval rules.
model ParentDifficultyPreference {
  id                    String      @id @default(uuid()) @db.Uuid
  tenantId              String      @map("tenant_id") @db.Uuid
  learnerId             String      @map("learner_id") @db.Uuid
  parentId              String      @map("parent_id") @db.Uuid

  // Global settings
  autoApproveIncreases  Boolean     @default(false) @map("auto_approve_increases")  // Auto-approve when going harder
  autoApproveDecreases  Boolean     @default(false) @map("auto_approve_decreases")  // Auto-approve when going easier
  notifyOnRecommendation Boolean    @default(true) @map("notify_on_recommendation")

  // Per-domain overrides (parent can lock a domain to a specific level)
  domainOverrides       Json?       @map("domain_overrides")  // { "MATH": { "lockedLevel": 3, "reason": "..." } }

  // Maximum difficulty parent allows (safety cap)
  maxDifficultyLevel    Int?        @map("max_difficulty_level") @db.SmallInt  // 1-5, null = no cap
  minDifficultyLevel    Int?        @map("min_difficulty_level") @db.SmallInt  // 1-5, null = no floor

  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, learnerId, parentId])
  @@index([tenantId, learnerId])
  @@map("parent_difficulty_preferences")
}

/// History of difficulty changes applied to a learner.
/// Tracks all changes for analytics and parent visibility.
model DifficultyChangeHistory {
  id                    String      @id @default(uuid()) @db.Uuid
  tenantId              String      @map("tenant_id") @db.Uuid
  learnerId             String      @map("learner_id") @db.Uuid
  virtualBrainId        String      @map("virtual_brain_id") @db.Uuid
  recommendationId      String?     @map("recommendation_id") @db.Uuid  // Link to original recommendation

  // Change details
  domain                SkillDomain?
  previousLevel         Int         @map("previous_level") @db.SmallInt
  newLevel              Int         @map("new_level") @db.SmallInt
  changeSource          String      @map("change_source")  // "system_recommendation", "parent_override", "baseline_assessment"

  // Who made the change
  changedBy             String?     @map("changed_by") @db.Uuid  // Parent/Admin ID, null if system
  changedByType         String      @map("changed_by_type")  // "system", "parent", "admin"

  // Outcome tracking (filled in later)
  outcomeTrackedAt      DateTime?   @map("outcome_tracked_at") @db.Timestamptz
  postChangeMastery     Decimal?    @map("post_change_mastery") @db.Decimal(4, 3)
  postChangeAccuracy    Decimal?    @map("post_change_accuracy") @db.Decimal(4, 3)
  wasEffective          Boolean?    @map("was_effective")  // Did this change help the learner?

  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamptz

  @@index([tenantId, learnerId, createdAt(sort: Desc)])
  @@index([virtualBrainId, domain])
  @@index([recommendationId])
  @@map("difficulty_change_history")
}

/// Bias alerts requiring attention.
/// Created when significant bias is detected in predictions.
model BiasAlert {
  id               String       @id @default(uuid()) @db.Uuid
  tenantId         String       @map("tenant_id") @db.Uuid
  biasReportId     String       @map("bias_report_id") @db.Uuid
  
  // Alert details
  metric           String       // e.g., "statistical_parity", "disparate_impact"
  attribute        String       // e.g., "race_ethnicity", "gender"
  affectedGroup    String       @map("affected_group")
  severity         BiasSeverity
  description      String
  impactEstimate   String       @map("impact_estimate")
  
  // Recommended actions (JSON array)
  actionsJson      Json         @map("actions_json")
  
  // Resolution tracking
  acknowledged     Boolean      @default(false)
  acknowledgedAt   DateTime?    @map("acknowledged_at") @db.Timestamptz
  acknowledgedBy   String?      @map("acknowledged_by") @db.Uuid
  
  resolved         Boolean      @default(false)
  resolvedAt       DateTime?    @map("resolved_at") @db.Timestamptz
  resolvedBy       String?      @map("resolved_by") @db.Uuid
  resolutionNotes  String?      @map("resolution_notes")
  
  // Audit
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  biasReport       BiasReport   @relation(fields: [biasReportId], references: [id], onDelete: Cascade)

  @@index([tenantId, resolved, severity])
  @@index([biasReportId])
  @@map("bias_alerts")
}
