// ============================================================================
// ENHANCED ASSESSMENT SCHEMA EXTENSIONS
// These models extend the base assessment schema with advanced features
// ============================================================================

// ============================================================================
// ADDITIONAL ENUMS
// ============================================================================

enum RubricType {
  HOLISTIC   // Single overall score
  ANALYTIC   // Multiple criteria scored separately
  SINGLE_POINT // Single criteria with meets/does not meet

  @@map("rubric_type")
}

enum GradeReleasePolicy {
  IMMEDIATELY      // Show grades right after submission
  AFTER_DUE_DATE   // Show after assignment due date
  AFTER_ALL_GRADED // Show after all submissions graded
  MANUAL           // Teacher manually releases grades

  @@map("grade_release_policy")
}

enum AccommodationType {
  EXTENDED_TIME    // Extra time percentage
  READ_ALOUD       // Text-to-speech enabled
  LARGE_TEXT       // Enlarged font size
  HIGH_CONTRAST    // High contrast mode
  REDUCED_DISTRACTION // Simplified UI
  BREAKS_ALLOWED   // Pause timer for breaks
  SEPARATE_SETTING // Proctored separately

  @@map("accommodation_type")
}

enum SecurityViolationType {
  TAB_SWITCH       // Switched browser tabs
  WINDOW_BLUR      // Left browser window
  COPY_ATTEMPT     // Tried to copy content
  PASTE_ATTEMPT    // Tried to paste content
  SCREENSHOT       // Screenshot attempt detected
  RIGHT_CLICK      // Right-click context menu
  DEV_TOOLS        // Developer tools opened
  FULLSCREEN_EXIT  // Exited fullscreen mode
  SECOND_DEVICE    // Multiple device detected
  OTHER            // Other suspicious activity

  @@map("security_violation_type")
}

// ============================================================================
// RUBRIC MODELS
// ============================================================================

/// Rubric for subjective grading
model Rubric {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  name        String      @db.VarChar(200)
  description String?     @db.Text
  type        RubricType  @default(ANALYTIC)
  maxPoints   Int         @map("max_points")
  isPublic    Boolean     @default(false) @map("is_public")

  /// Relationships
  criteria    RubricCriterion[]
  questions   Question[]        @relation("QuestionRubric")

  /// Audit
  createdBy   String      @map("created_by") @db.Uuid
  clonedFrom  String?     @map("cloned_from") @db.Uuid
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId])
  @@index([createdBy])
  @@index([isPublic])
  @@map("rubrics")
}

/// Rubric Criterion (row in rubric)
model RubricCriterion {
  id          String   @id @default(uuid()) @db.Uuid
  rubricId    String   @map("rubric_id") @db.Uuid
  name        String   @db.VarChar(200)
  description String?  @db.Text
  orderIndex  Int      @map("order_index") @db.SmallInt
  maxPoints   Int      @map("max_points")
  weight      Float    @default(1.0) // For weighted scoring

  /// Relationships
  rubric      Rubric   @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  levels      RubricLevel[]

  @@index([rubricId])
  @@map("rubric_criteria")
}

/// Rubric Level (column/performance level)
model RubricLevel {
  id          String   @id @default(uuid()) @db.Uuid
  criterionId String   @map("criterion_id") @db.Uuid
  name        String   @db.VarChar(100) // e.g., "Excellent", "Proficient", "Developing", "Beginning"
  description String   @db.Text // Description of what this level looks like
  points      Int      // Points awarded for this level
  orderIndex  Int      @map("order_index") @db.SmallInt
  feedback    String?  @db.Text // Default feedback for this level

  /// Relationships
  criterion   RubricCriterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)

  @@index([criterionId])
  @@map("rubric_levels")
}

// ============================================================================
// ENHANCED ASSESSMENT SETTINGS
// ============================================================================

/// Assessment Settings (detailed configuration)
model AssessmentSettings {
  id                     String              @id @default(uuid()) @db.Uuid
  assessmentId           String              @unique @map("assessment_id") @db.Uuid

  // Timing
  timeLimit              Int?                @map("time_limit") // Minutes
  timeLimitEnforced      Boolean             @default(true) @map("time_limit_enforced")
  lateSubmissionPolicy   String              @default("prevent") @map("late_submission_policy") // prevent, deduct, allow
  lateDeductionPercent   Int?                @map("late_deduction_percent") // Per day/hour deduction

  // Attempts
  attemptsAllowed        Int                 @default(1) @map("attempts_allowed")
  scoringMethod          String              @default("highest") @map("scoring_method") // highest, latest, average

  // Randomization
  shuffleQuestions       Boolean             @default(false) @map("shuffle_questions")
  shuffleAnswers         Boolean             @default(false) @map("shuffle_answers")
  questionPoolEnabled    Boolean             @default(false) @map("question_pool_enabled")

  // Display
  questionsPerPage       String              @default("all") @map("questions_per_page") // all, one, number
  allowBackNavigation    Boolean             @default(true) @map("allow_back_navigation")
  showQuestionNumbers    Boolean             @default(true) @map("show_question_numbers")
  showProgressBar        Boolean             @default(true) @map("show_progress_bar")

  // Feedback & Results
  showResults            String              @default("after_submission") @map("show_results") // immediately, after_submission, after_due_date, never
  showCorrectAnswers     Boolean             @default(true) @map("show_correct_answers")
  showFeedback           Boolean             @default(true) @map("show_feedback")
  showPointsPerQuestion  Boolean             @default(true) @map("show_points_per_question")
  gradeReleasePolicy     GradeReleasePolicy  @default(IMMEDIATELY) @map("grade_release_policy")
  gradeReleaseDate       DateTime?           @map("grade_release_date") @db.Timestamptz

  // Security
  requireLockdownBrowser Boolean             @default(false) @map("require_lockdown_browser")
  lockdownBrowserPassword String?            @map("lockdown_browser_password")
  webcamRequired         Boolean             @default(false) @map("webcam_required")
  preventCopyPaste       Boolean             @default(true) @map("prevent_copy_paste")
  preventRightClick      Boolean             @default(true) @map("prevent_right_click")
  detectTabSwitch        Boolean             @default(true) @map("detect_tab_switch")
  requireFullscreen      Boolean             @default(false) @map("require_fullscreen")
  maxViolationsAllowed   Int                 @default(3) @map("max_violations_allowed")
  ipRestriction          String[]            @default([]) @map("ip_restriction")

  // Proctoring
  proctoringEnabled      Boolean             @default(false) @map("proctoring_enabled")
  proctoringProvider     String?             @map("proctoring_provider") // proctorio, honorlock, examity
  proctoringSettings     Json?               @map("proctoring_settings")

  // Availability
  availableFrom          DateTime?           @map("available_from") @db.Timestamptz
  availableUntil         DateTime?           @map("available_until") @db.Timestamptz
  password               String?             @db.VarChar(100)

  createdAt              DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  @@map("assessment_settings")
}

// ============================================================================
// QUESTION POOL FOR RANDOMIZATION
// ============================================================================

/// Assessment Question Pool Configuration
model AssessmentQuestionPool {
  id                String   @id @default(uuid()) @db.Uuid
  assessmentId      String   @map("assessment_id") @db.Uuid
  name              String   @db.VarChar(200)
  orderIndex        Int      @map("order_index") @db.SmallInt
  pickCount         Int      @map("pick_count") // Number of questions to pick
  pointsPerQuestion Int      @map("points_per_question")

  /// Filter criteria (if not using specific questionIds)
  questionIds       String[] @map("question_ids") @db.Uuid // Specific questions to pick from
  tags              String[] @default([])
  difficulty        String?  // Filter by difficulty
  topicIds          String[] @default([]) @map("topic_ids") @db.Uuid

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([assessmentId])
  @@map("assessment_question_pools")
}

// ============================================================================
// ENHANCED ATTEMPT TRACKING
// ============================================================================

/// Security violations during attempt
model AttemptSecurityViolation {
  id          String                @id @default(uuid()) @db.Uuid
  attemptId   String                @map("attempt_id") @db.Uuid
  type        SecurityViolationType
  details     Json?                 // Additional details about the violation
  timestamp   DateTime              @default(now()) @db.Timestamptz
  ipAddress   String?               @map("ip_address") @db.VarChar(45)
  userAgent   String?               @map("user_agent") @db.Text

  attempt     Attempt               @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([type])
  @@map("attempt_security_violations")
}

/// Attempt accommodations granted
model AttemptAccommodation {
  id              String            @id @default(uuid()) @db.Uuid
  attemptId       String            @map("attempt_id") @db.Uuid
  type            AccommodationType
  value           String?           // e.g., "50" for 50% extra time
  grantedBy       String            @map("granted_by") @db.Uuid
  grantedAt       DateTime          @default(now()) @map("granted_at") @db.Timestamptz
  reason          String?           @db.Text

  attempt         Attempt           @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@map("attempt_accommodations")
}

/// Session tracking for attempt
model AttemptSession {
  id          String   @id @default(uuid()) @db.Uuid
  attemptId   String   @map("attempt_id") @db.Uuid
  startedAt   DateTime @default(now()) @map("started_at") @db.Timestamptz
  endedAt     DateTime? @map("ended_at") @db.Timestamptz
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.Text
  deviceInfo  Json?    @map("device_info")

  attempt     Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@map("attempt_sessions")
}

// ============================================================================
// GRADING RECORDS
// ============================================================================

/// Manual grading record for a response
model GradingRecord {
  id            String   @id @default(uuid()) @db.Uuid
  responseId    String   @map("response_id") @db.Uuid
  graderId      String   @map("grader_id") @db.Uuid
  score         Float
  maxPoints     Float    @map("max_points")
  feedback      String?  @db.Text
  rubricScores  Json?    @map("rubric_scores") // { criterionId: { levelId, points, comment } }
  isOverride    Boolean  @default(false) @map("is_override")
  gradedAt      DateTime @default(now()) @map("graded_at") @db.Timestamptz

  response      QuestionResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@index([graderId])
  @@map("grading_records")
}

// ============================================================================
// STANDARDS ALIGNMENT
// ============================================================================

/// Educational Standard
model Standard {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @db.VarChar(50) // e.g., "CCSS.MATH.CONTENT.3.OA.A.1"
  name        String   @db.VarChar(200)
  description String?  @db.Text
  framework   String   @db.VarChar(100) // e.g., "Common Core", "NGSS", "State Standards"
  subject     String   @db.VarChar(50)
  gradeLevel  String   @map("grade_level") @db.VarChar(20)
  domain      String?  @db.VarChar(100)
  cluster     String?  @db.VarChar(200)
  parentId    String?  @map("parent_id") @db.Uuid

  /// Relationships
  parent      Standard?  @relation("StandardHierarchy", fields: [parentId], references: [id])
  children    Standard[] @relation("StandardHierarchy")
  questions   QuestionStandard[]
  assessments AssessmentStandard[]

  @@unique([framework, code])
  @@index([framework])
  @@index([subject])
  @@index([gradeLevel])
  @@map("standards")
}

/// Question-Standard alignment
model QuestionStandard {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  standardId String   @map("standard_id") @db.Uuid
  alignment  String   @default("primary") // primary, secondary

  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  standard   Standard @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@unique([questionId, standardId])
  @@map("question_standards")
}

/// Assessment-Standard alignment
model AssessmentStandard {
  id           String     @id @default(uuid()) @db.Uuid
  assessmentId String     @map("assessment_id") @db.Uuid
  standardId   String     @map("standard_id") @db.Uuid

  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  standard     Standard   @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, standardId])
  @@map("assessment_standards")
}

// ============================================================================
// ANALYTICS & ITEM ANALYSIS
// ============================================================================

/// Aggregated question statistics
model QuestionAnalytics {
  id                   String   @id @default(uuid()) @db.Uuid
  questionId           String   @unique @map("question_id") @db.Uuid
  
  // Usage stats
  timesUsed            Int      @default(0) @map("times_used")
  timesAnswered        Int      @default(0) @map("times_answered")
  timesSkipped         Int      @default(0) @map("times_skipped")
  
  // Performance stats
  averageScore         Float?   @map("average_score")
  averageTimeSeconds   Int?     @map("average_time_seconds")
  correctRate          Float?   @map("correct_rate") // p-value (0-1)
  
  // Item analysis
  difficultyIndex      Float?   @map("difficulty_index") // 0-1, higher = easier
  discriminationIndex  Float?   @map("discrimination_index") // -1 to 1, higher = better
  pointBiserial        Float?   @map("point_biserial") // Correlation with total score
  
  // Distractor analysis (for multiple choice)
  distractorAnalysis   Json?    @map("distractor_analysis") // { optionId: { selectedCount, topQuartileRate, bottomQuartileRate } }
  
  // Answer distribution
  answerDistribution   Json?    @map("answer_distribution") // { answer: count }
  
  // Last calculated
  lastCalculated       DateTime @default(now()) @map("last_calculated") @db.Timestamptz

  question             Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_analytics")
}

/// Assessment-level analytics
model AssessmentAnalytics {
  id                  String     @id @default(uuid()) @db.Uuid
  assessmentId        String     @unique @map("assessment_id") @db.Uuid
  
  // Attempt stats
  totalAttempts       Int        @default(0) @map("total_attempts")
  completedAttempts   Int        @default(0) @map("completed_attempts")
  averageTimeMinutes  Float?     @map("average_time_minutes")
  completionRate      Float?     @map("completion_rate")
  
  // Score stats
  averageScore        Float?     @map("average_score")
  medianScore         Float?     @map("median_score")
  highestScore        Float?     @map("highest_score")
  lowestScore         Float?     @map("lowest_score")
  standardDeviation   Float?     @map("standard_deviation")
  passRate            Float?     @map("pass_rate")
  
  // Distribution
  scoreDistribution   Json?      @map("score_distribution") // { "0-10": count, "11-20": count, ... }
  gradeDistribution   Json?      @map("grade_distribution") // { "A": count, "B": count, ... }
  
  // Reliability
  cronbachAlpha       Float?     @map("cronbach_alpha") // Internal consistency (0-1)
  standardError       Float?     @map("standard_error") // Standard error of measurement
  
  // Last calculated
  lastCalculated      DateTime   @default(now()) @map("last_calculated") @db.Timestamptz

  assessment          Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_analytics")
}

// ============================================================================
// EXTEND EXISTING MODELS (Add new fields)
// Note: These need to be added to the original models in schema.prisma
// ============================================================================

// Add to Question model:
// rubricId       String?  @map("rubric_id") @db.Uuid
// rubric         Rubric?  @relation("QuestionRubric", fields: [rubricId], references: [id])
// partialCredit  Boolean  @default(false) @map("partial_credit")
// isPublic       Boolean  @default(false) @map("is_public")
// status         String   @default("active")
// version        Int      @default(1)
// previousVersionId String? @map("previous_version_id") @db.Uuid
// standards      QuestionStandard[]
// analytics      QuestionAnalytics?

// Add to Attempt model:
// securityViolations AttemptSecurityViolation[]
// accommodations     AttemptAccommodation[]
// sessions           AttemptSession[]
// questionOrder      String[] @map("question_order") @db.Uuid // For shuffled questions
// answerOrders       Json?    @map("answer_orders") // { questionId: [shuffled option order] }
// securityToken      String?  @map("security_token") @db.VarChar(100)
// expiresAt          DateTime? @map("expires_at") @db.Timestamptz

// Add to QuestionResponse model:
// gradingRecords     GradingRecord[]
// flagged            Boolean @default(false)
// autoGraded         Boolean @default(false) @map("auto_graded")

// Add to Assessment model:
// settings           AssessmentSettings?
// questionPools      AssessmentQuestionPool[]
// standards          AssessmentStandard[]
// analytics          AssessmentAnalytics?
// version            Int      @default(1)
// clonedFrom         String?  @map("cloned_from") @db.Uuid
// passingScore       Float?   @map("passing_score") // Percentage to pass
