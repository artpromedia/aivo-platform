generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Academic subject area for the homework
enum Subject {
  ELA       // English Language Arts
  MATH
  SCIENCE
  OTHER

  @@map("subject")
}

/// Grade band for age-appropriate scaffolding
enum GradeBand {
  K5       // Kindergarten through 5th grade
  G6_8     // 6th through 8th grade
  G9_12    // 9th through 12th grade

  @@map("grade_band")
}

/// How the homework was captured/submitted
enum SourceType {
  IMAGE    // Photo of homework
  TEXT     // Typed text input
  PDF      // PDF document upload

  @@map("source_type")
}

/// Processing status of the homework submission
enum SubmissionStatus {
  RECEIVED    // Initial submission received
  PARSED      // OCR/parsing complete
  SCAFFOLDED  // AI has generated step-by-step guidance
  COMPLETED   // Student has completed all steps
  FAILED      // Processing failed

  @@map("submission_status")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// A homework submission from a learner.
/// Contains the original problem text/image and links to the scaffolded steps.
model HomeworkSubmission {
  id            String           @id @default(uuid()) @db.Uuid
  tenantId      String           @map("tenant_id") @db.Uuid
  learnerId     String           @map("learner_id") @db.Uuid
  sessionId     String?          @map("session_id") @db.Uuid

  /// The academic subject area
  subject       Subject

  /// The grade band for age-appropriate scaffolding
  gradeBand     GradeBand        @map("grade_band")

  /// How the homework was captured
  sourceType    SourceType       @map("source_type")

  /// URL/path to the original uploaded file (if IMAGE or PDF)
  sourceUrl     String?          @map("source_url")

  /// The raw text extracted from OCR or direct input
  rawText       String           @map("raw_text") @db.Text

  /// Current processing status
  status        SubmissionStatus @default(RECEIVED)

  /// Number of steps generated for this homework
  stepCount     Int              @default(0) @map("step_count")

  /// Number of steps completed by the learner
  stepsCompleted Int             @default(0) @map("steps_completed")

  /// AI orchestrator request correlation ID for tracing
  aiCorrelationId String?        @map("ai_correlation_id")

  /// Error message if status is FAILED
  errorMessage  String?          @map("error_message") @db.Text

  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  /// Child steps generated by the AI
  steps         HomeworkStep[]

  @@index([tenantId, learnerId])
  @@index([sessionId])
  @@index([status])
  @@map("homework_submissions")
}

/// A single step in the scaffolded homework guidance.
/// Each step presents a leading question or hint without revealing the answer.
model HomeworkStep {
  id            String           @id @default(uuid()) @db.Uuid
  submissionId  String           @map("submission_id") @db.Uuid

  /// Order of this step in the sequence (1-based)
  stepOrder     Int              @map("step_order")

  /// The scaffolding prompt presented to the learner
  /// e.g., "What operation would you use to find the total?"
  promptText    String           @map("prompt_text") @db.Text

  /// Optional hint that can be revealed if learner requests help
  hintText      String?          @map("hint_text") @db.Text

  /// The expected concept or approach (not shown to learner)
  /// Used for validation and teacher review
  expectedConcept String?        @map("expected_concept") @db.Text

  /// Whether the learner has started working on this step
  isStarted     Boolean          @default(false) @map("is_started")

  /// Whether the step is complete
  isCompleted   Boolean          @default(false) @map("is_completed")

  /// Whether the hint was requested/revealed
  hintRevealed  Boolean          @default(false) @map("hint_revealed")

  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  /// Parent submission
  submission    HomeworkSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  /// Learner responses to this step
  responses     HomeworkStepResponse[]

  @@unique([submissionId, stepOrder])
  @@index([submissionId])
  @@map("homework_steps")
}

/// A learner's response to a homework step.
/// Tracks what the learner submitted and any AI feedback.
model HomeworkStepResponse {
  id            String           @id @default(uuid()) @db.Uuid
  stepId        String           @map("step_id") @db.Uuid

  /// The learner's answer/response text
  responseText  String           @map("response_text") @db.Text

  /// AI-generated feedback (scaffolding, not answers)
  aiFeedback    String?          @map("ai_feedback") @db.Text

  /// Whether this response demonstrated understanding
  isCorrect     Boolean?         @map("is_correct")

  /// AI orchestrator request correlation ID for feedback call
  aiCorrelationId String?        @map("ai_correlation_id")

  createdAt     DateTime         @default(now()) @map("created_at")

  /// Parent step
  step          HomeworkStep     @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@map("homework_step_responses")
}
