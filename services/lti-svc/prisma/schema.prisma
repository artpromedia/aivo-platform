generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Supported LMS platforms for LTI integration
enum LtiPlatformType {
  CANVAS
  SCHOOLOGY
  GOOGLE_CLASSROOM
  BLACKBOARD
  BRIGHTSPACE
  MOODLE
  GENERIC  // Generic LTI 1.3 platform

  @@map("lti_platform_type")
}

/// User role in LTI context
enum LtiUserRole {
  INSTRUCTOR
  LEARNER
  TEACHING_ASSISTANT
  CONTENT_DEVELOPER
  ADMINISTRATOR
  MENTOR

  @@map("lti_user_role")
}

/// Status of an LTI launch
enum LtiLaunchStatus {
  PENDING      // Launch initiated, awaiting validation
  ACTIVE       // Successfully validated, session active
  COMPLETED    // Activity completed
  EXPIRED      // Launch expired (nonce timeout)
  FAILED       // Validation failed

  @@map("lti_launch_status")
}

/// Status of grade passback
enum LtiGradeStatus {
  PENDING
  SENT
  FAILED
  NOT_APPLICABLE

  @@map("lti_grade_status")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// LTI Tool configuration - represents Aivo's registration with an LMS platform.
/// This stores the OAuth 2.0 credentials and endpoints needed for LTI 1.3 communication.
///
/// Each tenant can have multiple LTI tool registrations (one per LMS platform).
/// The tool_private_key_ref points to KMS/Vault for secure key storage.
model LtiTool {
  id                  String          @id @default(uuid()) @db.Uuid
  tenantId            String          @map("tenant_id") @db.Uuid
  platformType        LtiPlatformType @map("platform_type")
  platformName        String          @map("platform_name")  // Display name, e.g., "Springfield District Canvas"
  
  // LTI 1.3 Core Configuration
  clientId            String          @map("client_id")       // OAuth 2.0 client_id assigned by LMS
  deploymentId        String          @map("deployment_id")   // LTI deployment ID within platform
  issuer              String                                   // Platform issuer URL (iss claim)
  
  // OAuth 2.0 / OIDC Endpoints
  authLoginUrl        String          @map("auth_login_url")  // OIDC authorization endpoint
  authTokenUrl        String          @map("auth_token_url")  // Token endpoint for access tokens
  jwksUrl             String          @map("jwks_url")        // Platform's JWKS endpoint for signature verification
  
  // Tool's Key Pair (for signing messages to platform)
  toolPrivateKeyRef   String          @map("tool_private_key_ref")  // Reference to KMS/Vault key
  toolPublicKeyId     String?         @map("tool_public_key_id")    // Key ID in tool's JWKS
  
  // Optional Endpoints for LTI Advantage services
  // Assignment and Grade Services (AGS)
  lineItemsUrl        String?         @map("line_items_url")
  // Names and Roles Provisioning Services (NRPS)  
  membershipsUrl      String?         @map("memberships_url")
  // Deep Linking Service
  deepLinkingUrl      String?         @map("deep_linking_url")
  
  // Configuration
  enabled             Boolean         @default(true)
  configJson          Json            @default("{}") @map("config_json") @db.JsonB  // Platform-specific settings
  
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  links               LtiLink[]
  launches            LtiLaunch[]
  nonces              LtiNonce[]
  userMappings        LtiUserMapping[]

  @@unique([tenantId, issuer, clientId, deploymentId])
  @@index([tenantId])
  @@index([issuer, clientId])
  @@map("lti_tools")
}

/// LTI Link - represents a deep link from LMS to a specific Aivo activity.
/// Teachers create these when setting up assignments in their LMS.
/// 
/// A link can target:
/// - A specific LearningObjectVersion (lo_version_id)
/// - An activity template (activity_template_id)  
/// - Dynamic content based on subject/grade (for flexible assignments)
model LtiLink {
  id                   String    @id @default(uuid()) @db.Uuid
  tenantId             String    @map("tenant_id") @db.Uuid
  ltiToolId            String    @map("lti_tool_id") @db.Uuid
  
  // LMS Context
  lmsContextId         String?   @map("lms_context_id")         // LMS course/class ID
  lmsResourceLinkId    String?   @map("lms_resource_link_id")   // LMS assignment ID
  
  // Aivo Target (one of these should be set)
  classroomId          String?   @map("classroom_id") @db.Uuid  // Optional: specific Aivo classroom
  loVersionId          String?   @map("lo_version_id") @db.Uuid // Specific learning object version
  activityTemplateId   String?   @map("activity_template_id") @db.Uuid // Activity template
  subject              String?                                    // Dynamic: filter by subject
  gradeBand            String?   @map("grade_band")              // Dynamic: filter by grade band
  
  // Display Info
  title                String
  description          String?
  
  // Grading Configuration
  maxPoints            Decimal?  @map("max_points") @db.Decimal(10, 2)
  gradingEnabled       Boolean   @default(false) @map("grading_enabled")
  lineItemId           String?   @map("line_item_id")  // AGS line item for grade passback
  
  // Metadata
  configJson           Json      @default("{}") @map("config_json") @db.JsonB
  
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  createdByUserId      String    @map("created_by_user_id") @db.Uuid

  // Relations
  tool                 LtiTool   @relation(fields: [ltiToolId], references: [id], onDelete: Cascade)
  launches             LtiLaunch[]

  @@index([tenantId])
  @@index([ltiToolId])
  @@index([lmsContextId, lmsResourceLinkId])
  @@map("lti_links")
}

/// LTI Launch - records each launch from LMS to Aivo.
/// Used for:
/// - Audit trail of all launches
/// - Mapping LMS users to Aivo users
/// - Supporting grade passback
/// - Session correlation
model LtiLaunch {
  id                 String           @id @default(uuid()) @db.Uuid
  tenantId           String           @map("tenant_id") @db.Uuid
  ltiToolId          String           @map("lti_tool_id") @db.Uuid
  ltiLinkId          String?          @map("lti_link_id") @db.Uuid
  
  // User Context
  lmsUserId          String           @map("lms_user_id")         // User ID from LMS
  lmsUserEmail       String?          @map("lms_user_email")
  lmsUserName        String?          @map("lms_user_name")
  userRole           LtiUserRole      @map("user_role")
  
  // Mapped Aivo User (resolved after launch)
  aivoUserId         String?          @map("aivo_user_id") @db.Uuid
  aivoLearnerId      String?          @map("aivo_learner_id") @db.Uuid  // If role is LEARNER
  
  // LMS Context
  lmsContextId       String?          @map("lms_context_id")      // Course/class ID
  lmsContextTitle    String?          @map("lms_context_title")
  lmsResourceLinkId  String?          @map("lms_resource_link_id")
  
  // Launch State
  status             LtiLaunchStatus  @default(PENDING)
  nonce              String           @unique                      // Replay protection
  state              String?                                       // OIDC state parameter
  
  // Session Linking
  aivoSessionId      String?          @map("aivo_session_id") @db.Uuid  // Created session
  
  // Grade Passback State
  gradeStatus        LtiGradeStatus   @default(NOT_APPLICABLE) @map("grade_status")
  scoreGiven         Decimal?         @map("score_given") @db.Decimal(10, 4)
  scoreMaximum       Decimal?         @map("score_maximum") @db.Decimal(10, 4)
  gradeSentAt        DateTime?        @map("grade_sent_at") @db.Timestamptz
  gradeError         String?          @map("grade_error")
  
  // Full Launch Payload (for debugging/audit)
  launchParamsJson   Json             @map("launch_params_json") @db.JsonB
  
  // Timestamps
  launchedAt         DateTime         @default(now()) @map("launched_at") @db.Timestamptz
  expiresAt          DateTime         @map("expires_at") @db.Timestamptz
  completedAt        DateTime?        @map("completed_at") @db.Timestamptz

  // Relations
  tool               LtiTool          @relation(fields: [ltiToolId], references: [id], onDelete: Cascade)
  link               LtiLink?         @relation(fields: [ltiLinkId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([ltiToolId])
  @@index([ltiLinkId])
  @@index([lmsUserId])
  @@index([aivoUserId])
  @@index([aivoSessionId])
  @@index([status, expiresAt])
  @@map("lti_launches")
}

/// LTI Nonce - for replay attack protection.
/// Nonces are single-use tokens that prevent replay of launch requests.
/// Expired nonces are periodically cleaned up.
model LtiNonce {
  id          String   @id @default(uuid()) @db.Uuid
  ltiToolId   String   @map("lti_tool_id") @db.Uuid
  nonce       String
  usedAt      DateTime @default(now()) @map("used_at") @db.Timestamptz
  expiresAt   DateTime @map("expires_at") @db.Timestamptz

  // Relations
  tool        LtiTool  @relation(fields: [ltiToolId], references: [id], onDelete: Cascade)

  @@unique([ltiToolId, nonce])
  @@index([expiresAt])
  @@map("lti_nonces")
}

/// LTI User Mapping - links LMS users to Aivo users.
/// Cached to avoid repeated lookups and enable offline resolution.
model LtiUserMapping {
  id             String       @id @default(uuid()) @db.Uuid
  tenantId       String       @map("tenant_id") @db.Uuid
  ltiToolId      String       @map("lti_tool_id") @db.Uuid
  lmsUserId      String       @map("lms_user_id")
  aivoUserId     String       @map("aivo_user_id") @db.Uuid
  lmsEmail       String?      @map("lms_email")
  lmsName        String?      @map("lms_name")
  lmsRole        LtiUserRole? @map("lms_role")
  isNewUser      Boolean      @default(false) @map("is_new_user")  // True if user was created during LTI launch
  lastSeenAt     DateTime     @default(now()) @map("last_seen_at") @db.Timestamptz
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tool           LtiTool      @relation(fields: [ltiToolId], references: [id], onDelete: Cascade)
  gradeSyncs     LtiGradeSync[]

  @@unique([ltiToolId, lmsUserId])
  @@index([tenantId])
  @@index([aivoUserId])
  @@index([lmsEmail])
  @@map("lti_user_mappings")
}

/// LTI Grade Sync - tracks grade passback attempts and their status.
/// Provides audit trail and retry capability for failed grade sync.
model LtiGradeSync {
  id               String         @id @default(uuid()) @db.Uuid
  tenantId         String         @map("tenant_id") @db.Uuid
  ltiLaunchId      String         @map("lti_launch_id") @db.Uuid
  userMappingId    String         @map("user_mapping_id") @db.Uuid
  lineItemId       String         @map("line_item_id")          // AGS line item URL
  
  // Score details
  scoreGiven       Decimal        @map("score_given") @db.Decimal(10, 4)
  scoreMaximum     Decimal        @map("score_maximum") @db.Decimal(10, 4)
  activityProgress String         @map("activity_progress")      // Initialized, Started, InProgress, Submitted, Completed
  gradingProgress  String         @map("grading_progress")       // FullyGraded, Pending, PendingManual, Failed, NotReady
  comment          String?
  
  // Sync status
  status           LtiGradeStatus @default(PENDING)
  attemptCount     Int            @default(0) @map("attempt_count")
  lastAttemptAt    DateTime?      @map("last_attempt_at") @db.Timestamptz
  errorMessage     String?        @map("error_message")
  httpStatus       Int?           @map("http_status")
  
  // Timestamps
  scoredAt         DateTime       @map("scored_at") @db.Timestamptz  // When score was earned
  syncedAt         DateTime?      @map("synced_at") @db.Timestamptz  // When successfully sent
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userMapping      LtiUserMapping @relation(fields: [userMappingId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ltiLaunchId])
  @@index([userMappingId])
  @@index([status, attemptCount])
  @@map("lti_grade_syncs")
}

// ══════════════════════════════════════════════════════════════════════════════
// LTI 1.1 MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// LTI 1.1 Consumer (Tool Consumer) configuration
/// Stores OAuth 1.0a credentials for legacy LMS platforms
model Lti11Consumer {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  name          String                                    // Display name, e.g., "Springfield District Moodle"
  consumerKey   String   @unique @map("consumer_key")     // OAuth consumer key
  sharedSecret  String   @map("shared_secret")            // OAuth shared secret (should be encrypted at rest)
  instanceGuid  String?  @map("instance_guid")            // tool_consumer_instance_guid from launches
  isActive      Boolean  @default(true) @map("is_active")
  settings      Json     @default("{}") @db.JsonB         // Additional configuration
  
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  outcomeBindings Lti11OutcomeBinding[]
  launchLogs      Lti11LaunchLog[]
  nonces          Lti11Nonce[]
  sessions        Lti11Session[]

  @@index([tenantId])
  @@map("lti11_consumers")
}

/// LTI 1.1 Outcome Service Binding
/// Links a user's activity to the LMS gradebook for grade passback
model Lti11OutcomeBinding {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  consumerId      String   @map("consumer_id") @db.Uuid
  resourceLinkId  String   @map("resource_link_id")
  serviceUrl      String   @map("service_url")            // lis_outcome_service_url
  sourcedId       String   @map("sourced_id")             // lis_result_sourcedid
  
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  consumer        Lti11Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)
  outcomeLogs     Lti11OutcomeLog[]

  @@unique([userId, consumerId, resourceLinkId], name: "userId_consumerId_resourceLinkId")
  @@index([userId])
  @@index([resourceLinkId])
  @@map("lti11_outcome_bindings")
}

/// LTI 1.1 Outcome Log
/// Tracks grade passback attempts for debugging and retry
model Lti11OutcomeLog {
  id              String   @id @default(uuid()) @db.Uuid
  bindingId       String   @map("binding_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  resourceLinkId  String   @map("resource_link_id")
  operation       String                                   // replaceResult, readResult, deleteResult
  score           Float?                                   // Score submitted (0.0-1.0)
  success         Boolean
  messageId       String?  @map("message_id")
  description     String?
  errorCode       String?  @map("error_code")
  
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  binding         Lti11OutcomeBinding @relation(fields: [bindingId], references: [id], onDelete: Cascade)

  @@index([bindingId, createdAt])
  @@index([userId])
  @@map("lti11_outcome_logs")
}

/// LTI 1.1 Nonce tracking
/// Prevents OAuth replay attacks by tracking used nonces
model Lti11Nonce {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique                             // consumerId:nonce
  consumerId  String   @map("consumer_id") @db.Uuid
  timestamp   DateTime @db.Timestamptz
  expiresAt   DateTime @map("expires_at") @db.Timestamptz
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  consumer    Lti11Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("lti11_nonces")
}

/// LTI 1.1 Launch Log
/// Records all LTI 1.1 launches for audit and debugging
model Lti11LaunchLog {
  id                    String   @id @default(uuid()) @db.Uuid
  consumerId            String   @map("consumer_id") @db.Uuid
  tenantId              String   @map("tenant_id") @db.Uuid
  userId                String?  @map("user_id") @db.Uuid
  messageType           String   @map("message_type")
  resourceLinkId        String   @map("resource_link_id")
  contextId             String?  @map("context_id")
  contextTitle          String?  @map("context_title")
  roles                 String?
  outcomeServiceUrl     String?  @map("outcome_service_url")
  customParams          Json?    @map("custom_params") @db.JsonB
  launchData            Json     @map("launch_data") @db.JsonB  // Full launch payload
  consumerInstanceGuid  String?  @map("consumer_instance_guid")
  consumerInstanceName  String?  @map("consumer_instance_name")
  productFamily         String?  @map("product_family")
  productVersion        String?  @map("product_version")
  
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  consumer              Lti11Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([consumerId])
  @@index([userId])
  @@map("lti11_launch_logs")
}

/// LTI 1.1 Session
/// Active sessions from LTI 1.1 launches
model Lti11Session {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  consumerId      String   @map("consumer_id") @db.Uuid
  ltiVersion      String   @map("lti_version")
  contextId       String?  @map("context_id")
  resourceLinkId  String   @map("resource_link_id")
  metadata        Json?    @db.JsonB
  expiresAt       DateTime @map("expires_at") @db.Timestamptz
  
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  consumer        Lti11Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("lti11_sessions")
}

