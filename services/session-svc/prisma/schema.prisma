generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Type of learning session - represents the primary purpose of the activity block.
/// Designed to be extensible for future agent types (SEL, tutoring, etc.)
enum SessionType {
  LEARNING    // Today's Plan / daily practice
  HOMEWORK    // Homework Helper sessions
  BASELINE    // Baseline assessment sessions
  PRACTICE    // Free practice / skill drill
  SEL         // Social-emotional learning sessions
  ASSESSMENT  // Other assessments (not baseline)

  @@map("session_type")
}

/// Origin of the session - where/how it was initiated.
/// Important for analytics segmentation and UX research.
enum SessionOrigin {
  MOBILE_LEARNER   // Learner using mobile app
  WEB_LEARNER      // Learner using web app
  TEACHER_LED      // Teacher-initiated classroom session
  HOMEWORK_HELPER  // Triggered by Homework Helper agent
  PARENT_APP       // Parent-initiated session
  SYSTEM           // System-generated (e.g., scheduled practice)

  @@map("session_origin")
}

/// Event types that can occur within a session.
/// Organized by category for easier querying and analytics.
enum SessionEventType {
  // ─── Session Lifecycle ───────────────────────────────────────────────────────
  SESSION_STARTED
  SESSION_PAUSED
  SESSION_RESUMED
  SESSION_ENDED
  SESSION_ABANDONED  // Session ended without explicit completion

  // ─── Activity Events ─────────────────────────────────────────────────────────
  ACTIVITY_STARTED
  ACTIVITY_COMPLETED
  ACTIVITY_SKIPPED
  ACTIVITY_RESPONSE_SUBMITTED  // Single response within activity

  // ─── Homework Helper Events ──────────────────────────────────────────────────
  HOMEWORK_CAPTURED       // Photo/document captured
  HOMEWORK_PARSED         // OCR/parsing complete
  HOMEWORK_STEP_STARTED
  HOMEWORK_STEP_COMPLETED
  HOMEWORK_HINT_REQUESTED
  HOMEWORK_SOLUTION_SHOWN

  // ─── Focus & Regulation Events ───────────────────────────────────────────────
  FOCUS_LOSS_DETECTED     // Disengagement detected
  FOCUS_BREAK_STARTED     // Learner taking a break
  FOCUS_BREAK_ENDED       // Break concluded
  FOCUS_INTERVENTION_SHOWN // Regulation prompt displayed
  FOCUS_INTERVENTION_COMPLETED

  // ─── Skill & Mastery Events ──────────────────────────────────────────────────
  SKILL_MASTERY_UPDATED   // Virtual Brain state change
  SKILL_UNLOCKED          // New skill became available

  // ─── Engagement Events ───────────────────────────────────────────────────────
  REWARD_EARNED
  STREAK_MILESTONE
  ACHIEVEMENT_UNLOCKED

  @@map("session_event_type")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// A Session represents a coherent block of learner activity.
/// It serves as the top-level container for all learning events and is the
/// primary unit for analytics, progress tracking, and Virtual Brain updates.
///
/// Design notes:
/// - Sessions are immutable once ended (ended_at is set)
/// - duration_ms is computed on completion for query efficiency
/// - metadata_json allows flexible context without schema changes
model Session {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  learnerId   String        @map("learner_id") @db.Uuid
  sessionType SessionType   @map("session_type")
  origin      SessionOrigin

  startedAt   DateTime      @default(now()) @map("started_at") @db.Timestamptz
  endedAt     DateTime?     @map("ended_at") @db.Timestamptz
  durationMs  Int?          @map("duration_ms")  // Computed on completion

  /// Flexible metadata - examples:
  /// { "classroomId": "uuid", "assignedByTeacherId": "uuid" }
  /// { "planId": "uuid", "targetSkills": ["SKL001", "SKL002"] }
  /// { "homeworkSubject": "math", "grade": 5 }
  metadataJson Json?        @map("metadata_json") @db.JsonB

  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  events      SessionEvent[]

  // ─── Indexes ─────────────────────────────────────────────────────────────────
  // Primary lookup: sessions for a learner, most recent first
  @@index([tenantId, learnerId, startedAt(sort: Desc)], name: "idx_sessions_learner_recent")
  // Filter by type for analytics
  @@index([tenantId, sessionType, startedAt(sort: Desc)], name: "idx_sessions_type_recent")
  // Uncompleted sessions (for resume functionality)
  @@index([tenantId, learnerId, endedAt], name: "idx_sessions_incomplete")

  @@map("sessions")
}

/// SessionEvent represents a discrete occurrence within a session.
/// Events are append-only and immutable - they form the audit trail
/// for all learning activity and feed into analytics pipelines.
///
/// Design notes:
/// - event_time is the actual time of occurrence (may differ from created_at)
/// - metadata_json schema varies by event_type (see docs)
/// - tenant_id/learner_id denormalized for efficient queries without joins
model SessionEvent {
  id          String           @id @default(uuid()) @db.Uuid
  sessionId   String           @map("session_id") @db.Uuid
  tenantId    String           @map("tenant_id") @db.Uuid
  learnerId   String           @map("learner_id") @db.Uuid
  eventType   SessionEventType @map("event_type")
  eventTime   DateTime         @map("event_time") @db.Timestamptz

  /// Event-specific metadata - schema depends on event_type. Examples:
  ///
  /// ACTIVITY_COMPLETED:
  /// { "activityId": "uuid", "skillCode": "SKL001", "score": 0.85, "durationMs": 45000 }
  ///
  /// HOMEWORK_STEP_COMPLETED:
  /// { "stepIndex": 2, "correct": true, "hintUsed": false }
  ///
  /// FOCUS_LOSS_DETECTED:
  /// { "focusScore": 0.3, "idleSeconds": 45, "trigger": "gaze_away" }
  ///
  /// SKILL_MASTERY_UPDATED:
  /// { "skillCode": "SKL001", "previousMastery": 0.6, "newMastery": 0.72 }
  metadataJson Json?           @map("metadata_json") @db.JsonB

  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz

  session     Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // ─── Indexes ─────────────────────────────────────────────────────────────────
  // Timeline within a session
  @@index([sessionId, eventTime(sort: Asc)], name: "idx_events_session_timeline")
  // Learner event history (for analytics, Virtual Brain updates)
  @@index([tenantId, learnerId, eventTime(sort: Desc)], name: "idx_events_learner_history")
  // Filter by event type (for specific analytics queries)
  @@index([tenantId, eventType, eventTime(sort: Desc)], name: "idx_events_type_recent")

  @@map("session_events")
}

// ══════════════════════════════════════════════════════════════════════════════
// TRANSITION SUPPORT SYSTEM
// Provides predictable transitions for neurodiverse learners
// ══════════════════════════════════════════════════════════════════════════════

/// Visual warning style for transition countdowns
enum VisualWarningStyle {
  COUNTDOWN_CIRCLE     // Circular countdown animation
  PROGRESS_BAR         // Horizontal bar that shrinks
  SAND_TIMER           // Visual hourglass
  NUMBER_COUNTDOWN     // Large numbers
  CHARACTER_ANIMATION  // Friendly character showing countdown

  @@map("visual_warning_style")
}

/// Color scheme for transition visuals
enum TransitionColorScheme {
  TRAFFIC_LIGHT  // Green → Yellow → Red
  BLUE_GRADIENT  // Calm blue shades
  NATURE         // Green/brown earth tones
  MONOCHROME     // Grayscale for sensory sensitivity
  CUSTOM         // User-defined colors

  @@map("transition_color_scheme")
}

/// Audio warning type for transitions
enum AudioWarningType {
  GENTLE_CHIME      // Soft bell sound
  NATURE_SOUND      // Bird chirp, water drop
  MUSICAL_TONE      // Pleasant musical note
  SPOKEN_COUNTDOWN  // Voice countdown
  VIBRATION_ONLY    // No audio, haptic only
  SILENT            // No audio at all

  @@map("audio_warning_type")
}

/// Outcome of a transition event
enum TransitionOutcome {
  SMOOTH           // Completed without issues
  NEEDED_EXTRA_TIME // Required additional time
  USED_ROUTINE     // Followed transition routine
  SKIPPED          // Learner skipped ahead
  INTERRUPTED      // Session ended during transition
  STRUGGLED        // Showed signs of difficulty

  @@map("transition_outcome")
}

/// Transition configuration per learner
/// Stores preferences for how transitions are handled
model TransitionPreferences {
  id                    String    @id @default(uuid()) @db.Uuid
  learnerId             String    @unique @map("learner_id") @db.Uuid
  tenantId              String    @map("tenant_id") @db.Uuid

  // Warning timing
  warningIntervals      Int[]     @default([60, 30, 10]) @map("warning_intervals") // seconds before transition
  minimumTransitionTime Int       @default(30) @map("minimum_transition_time") // minimum seconds

  // Sensory preferences for transitions
  enableVisualWarnings  Boolean   @default(true) @map("enable_visual_warnings")
  enableAudioWarnings   Boolean   @default(true) @map("enable_audio_warnings")
  enableHapticWarnings  Boolean   @default(true) @map("enable_haptic_warnings")

  // Visual settings
  visualWarningStyle    VisualWarningStyle @default(COUNTDOWN_CIRCLE) @map("visual_warning_style")
  colorScheme           TransitionColorScheme @default(TRAFFIC_LIGHT) @map("color_scheme")
  showProgressBar       Boolean   @default(true) @map("show_progress_bar")

  // Audio settings
  audioWarningType      AudioWarningType @default(GENTLE_CHIME) @map("audio_warning_type")
  audioVolume           Float     @default(0.7) @map("audio_volume")
  useSpokenWarnings     Boolean   @default(false) @map("use_spoken_warnings") // "30 seconds until..."

  // Transition routine
  transitionRoutineId   String?   @map("transition_routine_id") @db.Uuid
  showFirstThenBoard    Boolean   @default(true) @map("show_first_then_board")
  requireAcknowledgment Boolean   @default(false) @map("require_acknowledgment")

  /// Specific activity transitions (JSON for flexibility)
  /// { "quiz_to_video": { extraTime: 30, routineId: "..." } }
  activityTransitions   Json?     @map("activity_transitions") @db.JsonB

  /// Custom colors if colorScheme is CUSTOM
  /// { "warning": "#22c55e", "caution": "#eab308", "ready": "#ef4444" }
  customColors          Json?     @map("custom_colors") @db.JsonB

  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  routine               TransitionRoutine? @relation(fields: [transitionRoutineId], references: [id])

  @@index([tenantId], name: "idx_transition_prefs_tenant")
  @@map("transition_preferences")
}

/// Transition routines - reusable step-by-step sequences
/// Can be system defaults or tenant-customized
model TransitionRoutine {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  name            String
  description     String?

  /// Routine steps as JSON array
  /// [
  ///   { "type": "breathing", "duration": 10, "instruction": "Take 3 deep breaths" },
  ///   { "type": "movement", "duration": 5, "instruction": "Stretch your arms up high" },
  ///   { "type": "preview", "duration": 10, "instruction": "Look at what's coming next" },
  ///   { "type": "ready_check", "instruction": "Tap when you're ready" }
  /// ]
  steps           Json      @db.JsonB

  totalDuration   Int       @map("total_duration") // Total seconds
  isDefault       Boolean   @default(false) @map("is_default")
  isSystemRoutine Boolean   @default(false) @map("is_system_routine") // Built-in vs custom

  /// Target activity types (empty = all types)
  targetActivityTypes String[] @default([]) @map("target_activity_types")

  /// Target age range { "min": 5, "max": 8 }
  targetAgeRange      Json?   @map("target_age_range") @db.JsonB

  /// Target grade bands (empty = all)
  targetGradeBands    String[] @default([]) @map("target_grade_bands")

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  preferences     TransitionPreferences[]

  @@index([tenantId], name: "idx_transition_routines_tenant")
  @@index([tenantId, isDefault], name: "idx_transition_routines_default")
  @@map("transition_routines")
}

/// Transition event log for analytics
/// Tracks every transition for measuring effectiveness
model TransitionEvent {
  id              String    @id @default(uuid()) @db.Uuid
  sessionId       String    @map("session_id") @db.Uuid
  learnerId       String    @map("learner_id") @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid

  // Transition details
  fromActivityId   String?  @map("from_activity_id")
  fromActivityType String?  @map("from_activity_type")
  toActivityId     String   @map("to_activity_id")
  toActivityType   String   @map("to_activity_type")

  // Timing
  warningStartedAt    DateTime  @map("warning_started_at") @db.Timestamptz
  transitionStartedAt DateTime? @map("transition_started_at") @db.Timestamptz
  transitionCompletedAt DateTime? @map("transition_completed_at") @db.Timestamptz

  // Outcome
  outcome         TransitionOutcome @default(SMOOTH)
  acknowledgedAt  DateTime?   @map("acknowledged_at") @db.Timestamptz
  skippedWarning  Boolean     @default(false) @map("skipped_warning")
  usedRoutine     Boolean     @default(false) @map("used_routine")
  routineId       String?     @map("routine_id") @db.Uuid

  // Context
  focusStateBeforeTransition String? @map("focus_state_before")
  moodBeforeTransition       String? @map("mood_before")

  // Duration metrics
  totalTransitionSeconds Int?  @map("total_transition_seconds")
  plannedDurationSeconds Int?  @map("planned_duration_seconds")

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([sessionId], name: "idx_transition_events_session")
  @@index([learnerId], name: "idx_transition_events_learner")
  @@index([tenantId, createdAt(sort: Desc)], name: "idx_transition_events_tenant_recent")
  @@index([tenantId, outcome], name: "idx_transition_events_outcome")
  @@map("transition_events")
}

// ══════════════════════════════════════════════════════════════════════════════
// VISUAL SCHEDULE SYSTEM - ND-1.3
// Provides predictable visual schedules for neurodiverse learners
// ══════════════════════════════════════════════════════════════════════════════

/// Type of schedule - determines scope and context
enum ScheduleType {
  DAILY           // Full day schedule
  SESSION         // Just for current learning session
  ACTIVITY        // Steps within an activity
  CUSTOM          // Custom schedule

  @@map("schedule_type")
}

/// Display style for rendering schedules
enum ScheduleDisplayStyle {
  VERTICAL_LIST   // Items stacked vertically
  HORIZONTAL_STRIP // Horizontal scrolling strip
  GRID            // Grid of items
  FIRST_THEN      // Simple first/then board
  NOW_NEXT_LATER  // Three-item view

  @@map("schedule_display_style")
}

/// Visual schedule for a learner on a specific day
/// Core model for the visual schedule system
model VisualSchedule {
  id              String    @id @default(uuid()) @db.Uuid
  learnerId       String    @map("learner_id") @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid

  // Schedule info
  date            DateTime  @map("date") @db.Date
  type            ScheduleType @default(DAILY)

  /// Items as JSON array of ScheduleItem objects
  /// [
  ///   {
  ///     "id": "item_1",
  ///     "title": "Morning Circle",
  ///     "type": "activity",
  ///     "status": "upcoming",
  ///     "scheduledTime": "09:00",
  ///     "estimatedDuration": 15,
  ///     "activityId": "...",
  ///     "icon": "circle_time",
  ///     "color": "#4CAF50",
  ///     "image": "...",
  ///     "isFlexible": false,
  ///     "notes": "Remember to sit in your spot"
  ///   }
  /// ]
  items           Json      @db.JsonB

  // Customization
  displayStyle    ScheduleDisplayStyle @default(VERTICAL_LIST) @map("display_style")
  showTimes       Boolean   @default(true) @map("show_times")
  showDuration    Boolean   @default(true) @map("show_duration")
  showImages      Boolean   @default(true) @map("show_images")
  useSymbols      Boolean   @default(false) @map("use_symbols") // For AAC users

  // Progress
  currentItemIndex Int      @default(0) @map("current_item_index")
  completedCount  Int       @default(0) @map("completed_count")

  // Generated by
  generatedBy     String?   @map("generated_by") // "system", "teacher", "parent", or user ID
  isTemplate      Boolean   @default(false) @map("is_template")
  templateId      String?   @map("template_id") @db.Uuid

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([learnerId, date, type], name: "visual_schedules_learner_date_type_key")
  @@index([tenantId], name: "idx_visual_schedules_tenant")
  @@index([learnerId, date], name: "idx_visual_schedules_learner_date")
  @@map("visual_schedules")
}

/// Reusable schedule templates for teachers/parents
model ScheduleTemplate {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid

  // Template info
  name            String
  description     String?

  /// Default items (times are relative to session start)
  /// Uses same schema as VisualSchedule.items but times are relative minutes
  items           Json      @db.JsonB

  // Targeting
  targetAgeMin    Int?      @map("target_age_min")
  targetAgeMax    Int?      @map("target_age_max")
  dayOfWeek       Int[]     @default([]) @map("day_of_week") // 0=Sunday, 1=Monday, etc. Empty = any

  // Settings
  displayStyle    ScheduleDisplayStyle @default(VERTICAL_LIST) @map("display_style")
  showTimes       Boolean   @default(true) @map("show_times")

  isDefault       Boolean   @default(false) @map("is_default")
  createdBy       String    @map("created_by") @db.Uuid

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId], name: "idx_schedule_templates_tenant")
  @@index([tenantId, isDefault], name: "idx_schedule_templates_default")
  @@map("schedule_templates")
}

/// Learner preferences for schedule display and behavior
model SchedulePreferences {
  id              String    @id @default(uuid()) @db.Uuid
  learnerId       String    @unique @map("learner_id") @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid

  // Display preferences
  preferredStyle  ScheduleDisplayStyle @default(VERTICAL_LIST) @map("preferred_style")
  showTimes       Boolean   @default(true) @map("show_times")
  showDuration    Boolean   @default(true) @map("show_duration")
  showImages      Boolean   @default(true) @map("show_images")
  useSymbols      Boolean   @default(false) @map("use_symbols")

  // Timing preferences
  showCountdownToNext Boolean @default(true) @map("show_countdown_to_next")
  warnBeforeTransition Boolean @default(true) @map("warn_before_transition")
  transitionWarningMinutes Int @default(2) @map("transition_warning_minutes")

  // Visual preferences
  iconSize        String    @default("medium") @map("icon_size") // small, medium, large
  colorCoding     Boolean   @default(true) @map("color_coding")
  highContrast    Boolean   @default(false) @map("high_contrast")

  // Audio preferences
  announceItems   Boolean   @default(false) @map("announce_items")
  playChimeOnChange Boolean @default(true) @map("play_chime_on_change")

  // Completion preferences
  celebrateCompletion Boolean @default(true) @map("celebrate_completion")
  showProgressBar Boolean   @default(true) @map("show_progress_bar")

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId], name: "idx_schedule_preferences_tenant")
  @@map("schedule_preferences")
}

