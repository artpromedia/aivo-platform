generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Partner & Organization Models
// ============================================================================

model Partner {
  id              String          @id @default(uuid())
  name            String
  website         String?
  contactName     String
  contactEmail    String          @unique
  contactRole     String?
  status          PartnerStatus   @default(PENDING)
  tier            String          @default("free") // 'free', 'standard', 'enterprise'
  approvedAt      DateTime?
  approvedBy      String?
  approvalNotes   String?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  applications    PartnerApplication[]
  sandboxTenants  SandboxTenant[]

  @@index([status])
  @@index([contactEmail])
  @@map("partners")
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

model PartnerApplication {
  id                String   @id @default(uuid())
  partnerId         String
  partner           Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  integrationType   String[] // ['api', 'webhooks', 'lti', 'sis', 'sso']
  useCase           String
  expectedVolume    String?
  timeline          String?
  reviewNotes       String?
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime @default(now())

  @@index([partnerId])
  @@map("partner_applications")
}

// ============================================================================
// Sandbox Tenant Models
// ============================================================================

model SandboxTenant {
  id              String   @id @default(uuid())
  partnerId       String
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  name            String
  tenantCode      String   @unique
  webhookSecret   String
  isActive        Boolean  @default(true)
  lastResetAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  apiKeys           SandboxApiKey[]
  webhookEndpoints  SandboxWebhookEndpoint[]
  syntheticLearners SandboxSyntheticLearner[]
  syntheticTeachers SandboxSyntheticTeacher[]
  syntheticClasses  SandboxSyntheticClass[]
  apiUsageLogs      SandboxApiUsageLog[]

  @@index([partnerId])
  @@index([tenantCode])
  @@map("sandbox_tenants")
}

model SandboxApiKey {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String
  keyHash         String   @unique
  keyPrefix       String   // First 12 chars for display
  scopes          String[] // ['read:learner_progress', 'read:session_data', etc.]
  status          ApiKeyStatus @default(ACTIVE)
  lastUsedAt      DateTime?
  revokedAt       DateTime?
  revokedBy       String?
  expiresAt       DateTime?
  createdAt       DateTime @default(now())

  // Relationships
  usageLogs       SandboxApiUsageLog[]

  @@index([tenantId])
  @@index([keyHash])
  @@index([status])
  @@map("sandbox_api_keys")
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

model SandboxWebhookEndpoint {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String
  url             String
  eventTypes      String[] // ['SESSION_COMPLETED', 'BASELINE_COMPLETED', etc.]
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  deliveries      SandboxWebhookDelivery[]

  @@index([tenantId])
  @@map("sandbox_webhook_endpoints")
}

model SandboxWebhookDelivery {
  id              String   @id @default(uuid())
  endpointId      String
  endpoint        SandboxWebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  eventType       String
  payloadJson     Json
  status          DeliveryStatus @default(PENDING)
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  responseStatus  Int?
  responseBody    String?
  deliveredAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([endpointId])
  @@index([status])
  @@map("sandbox_webhook_deliveries")
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  PERMANENT_FAILURE
}

// ============================================================================
// Synthetic Data Models
// ============================================================================

model SandboxSyntheticLearner {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  externalId      String
  firstName       String
  lastName        String
  email           String
  gradeLevel      Int
  metadataJson    Json?

  // Relationships
  progress        SandboxSyntheticLearnerProgress[]
  sessions        SandboxSyntheticSession[]
  enrollments     SandboxSyntheticEnrollment[]

  @@unique([tenantId, externalId])
  @@index([tenantId])
  @@map("sandbox_synthetic_learners")
}

model SandboxSyntheticTeacher {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  externalId      String
  firstName       String
  lastName        String
  email           String
  role            String   @default("teacher")

  // Relationships
  classes         SandboxSyntheticClass[]

  @@unique([tenantId, externalId])
  @@index([tenantId])
  @@map("sandbox_synthetic_teachers")
}

model SandboxSyntheticClass {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  externalId      String
  name            String
  subject         String
  gradeLevel      Int
  teacherId       String?
  teacher         SandboxSyntheticTeacher? @relation(fields: [teacherId], references: [id])

  // Relationships
  enrollments     SandboxSyntheticEnrollment[]

  @@unique([tenantId, externalId])
  @@index([tenantId])
  @@map("sandbox_synthetic_classes")
}

model SandboxSyntheticEnrollment {
  id              String   @id @default(uuid())
  learnerId       String
  learner         SandboxSyntheticLearner @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  classId         String
  class           SandboxSyntheticClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  role            String   @default("student")
  createdAt       DateTime @default(now())

  @@unique([learnerId, classId])
  @@index([learnerId])
  @@index([classId])
  @@map("sandbox_synthetic_enrollments")
}

model SandboxSyntheticLearnerProgress {
  id              String   @id @default(uuid())
  learnerId       String
  learner         SandboxSyntheticLearner @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  skillDomain     String
  skillId         String
  masteryLevel    Float    @default(0)
  progressPct     Int      @default(0)
  lastPracticed   DateTime?
  recordedAt      DateTime @default(now())

  @@unique([learnerId, skillId])
  @@index([learnerId])
  @@map("sandbox_synthetic_learner_progress")
}

model SandboxSyntheticSession {
  id                String   @id @default(uuid())
  learnerId         String
  learner           SandboxSyntheticLearner @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  sessionType       String
  skillDomain       String
  startedAt         DateTime
  completedAt       DateTime?
  durationSeconds   Int?
  questionsAttempted Int     @default(0)
  questionsCorrect  Int      @default(0)
  accuracyPct       Int?
  xpEarned          Int      @default(0)
  eventsJson        Json?

  @@index([learnerId])
  @@index([startedAt])
  @@map("sandbox_synthetic_sessions")
}

// ============================================================================
// Usage & Analytics Models
// ============================================================================

model SandboxApiUsageLog {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          SandboxTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeyId        String?
  apiKey          SandboxApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)
  endpoint        String
  method          String
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([apiKeyId])
  @@index([createdAt])
  @@index([endpoint])
  @@map("sandbox_api_usage_logs")
}

// ============================================================================
// Admin Authentication Models
// ============================================================================

/// Admin user for sandbox management
model SandboxAdmin {
  id                  String        @id @default(uuid())
  email               String        @unique
  name                String        @default("")
  passwordHash        String        @map("password_hash")
  role                AdminRole     @default(SANDBOX_ADMIN)
  isActive            Boolean       @default(true) @map("is_active")
  mfaEnabled          Boolean       @default(false) @map("mfa_enabled")
  mfaSecret           String?       @map("mfa_secret") // Encrypted TOTP secret
  allowedIPs          String[]      @default([]) @map("allowed_ips") // IP allowlist
  lastLoginAt         DateTime?     @map("last_login_at")
  passwordChangedAt   DateTime      @default(now()) @map("password_changed_at")
  passwordResetToken  String?       @map("password_reset_token")
  passwordResetExpiry DateTime?     @map("password_reset_expiry")
  failedLoginAttempts Int           @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime?     @map("locked_until")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  createdBy           String?       @map("created_by")

  // Relationships
  sessions        AdminSession[]
  loginAttempts   AdminLoginAttempt[]
  passwordHistory AdminPasswordHistory[]
  auditLogs       AdminAuditLog[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([passwordResetToken])
  @@map("sandbox_admins")
}

/// Admin session for tracking active logins
model AdminSession {
  id          String        @id @default(uuid())
  adminId     String        @map("admin_id")
  admin       SandboxAdmin  @relation(fields: [adminId], references: [id], onDelete: Cascade)
  token       String        @unique
  ipAddress   String        @map("ip_address")
  userAgent   String        @map("user_agent")
  expiresAt   DateTime      @map("expires_at")
  lastActivityAt DateTime   @default(now()) @map("last_activity_at")
  revokedAt   DateTime?     @map("revoked_at")
  revokedReason String?     @map("revoked_reason")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([adminId])
  @@index([token])
  @@index([expiresAt])
  @@map("admin_sessions")
}

/// Login attempts for security monitoring and rate limiting
model AdminLoginAttempt {
  id          String        @id @default(uuid())
  adminId     String?       @map("admin_id")
  admin       SandboxAdmin? @relation(fields: [adminId], references: [id], onDelete: SetNull)
  email       String
  ipAddress   String        @map("ip_address")
  userAgent   String        @map("user_agent")
  success     Boolean
  failReason  String?       @map("fail_reason")
  mfaUsed     Boolean       @default(false) @map("mfa_used")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([adminId, createdAt])
  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
  @@map("admin_login_attempts")
}

/// Audit log for all admin actions
model AdminAuditLog {
  id          String        @id @default(uuid())
  adminId     String        @map("admin_id")
  admin       SandboxAdmin  @relation(fields: [adminId], references: [id], onDelete: Cascade)
  adminEmail  String        @map("admin_email")
  action      String
  resource    String?
  resourceId  String?       @map("resource_id")
  metadata    Json?
  ipAddress   String        @map("ip_address")
  userAgent   String        @map("user_agent")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([adminId, createdAt])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

/// Password history to prevent reuse
model AdminPasswordHistory {
  id          String        @id @default(uuid())
  adminId     String        @map("admin_id")
  admin       SandboxAdmin  @relation(fields: [adminId], references: [id], onDelete: Cascade)
  passwordHash String       @map("password_hash")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([adminId, createdAt])
  @@map("admin_password_history")
}

/// Admin roles with different permission levels
enum AdminRole {
  SUPER_ADMIN    // Full access to all features
  SANDBOX_ADMIN  // Manage sandboxes and partners
  SALES_DEMO     // Present demos, limited access
  SUPPORT        // Read access and user impersonation
}
