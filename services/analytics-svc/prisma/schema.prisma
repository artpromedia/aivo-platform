generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// NOTE: This schema references tables managed by other services.
// Analytics service has READ-ONLY access to these tables.
// We define views/queries against the existing data.
// ══════════════════════════════════════════════════════════════════════════════

// Re-declare enums needed for queries
enum SessionType {
  LEARNING
  HOMEWORK
  BASELINE
  PRACTICE
  SEL
  ASSESSMENT

  @@map("session_type")
}

enum SessionOrigin {
  MOBILE_LEARNER
  WEB_LEARNER
  TEACHER_LED
  HOMEWORK_HELPER
  PARENT_APP
  SYSTEM

  @@map("session_origin")
}

enum SessionEventType {
  SESSION_STARTED
  SESSION_PAUSED
  SESSION_RESUMED
  SESSION_ENDED
  SESSION_ABANDONED
  ACTIVITY_STARTED
  ACTIVITY_COMPLETED
  ACTIVITY_SKIPPED
  ACTIVITY_RESPONSE_SUBMITTED
  HOMEWORK_CAPTURED
  HOMEWORK_PARSED
  HOMEWORK_STEP_STARTED
  HOMEWORK_STEP_COMPLETED
  HOMEWORK_HINT_REQUESTED
  HOMEWORK_SOLUTION_SHOWN
  FOCUS_LOSS_DETECTED
  FOCUS_BREAK_STARTED
  FOCUS_BREAK_ENDED
  FOCUS_INTERVENTION_SHOWN
  FOCUS_INTERVENTION_COMPLETED
  SKILL_MASTERY_UPDATED
  SKILL_UNLOCKED
  REWARD_EARNED
  STREAK_MILESTONE
  ACHIEVEMENT_UNLOCKED

  @@map("session_event_type")
}

enum Subject {
  ELA
  MATH
  SCIENCE
  OTHER

  @@map("subject")
}

enum GradeBand {
  K5
  G6_8
  G9_12

  @@map("grade_band")
}

enum SubmissionStatus {
  RECEIVED
  PARSED
  SCAFFOLDED
  COMPLETED
  FAILED

  @@map("submission_status")
}

// ══════════════════════════════════════════════════════════════════════════════
// READ-ONLY MODELS (managed by other services)
// ══════════════════════════════════════════════════════════════════════════════

/// Sessions table (managed by session-svc)
model Session {
  id          String        @id @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  learnerId   String        @map("learner_id") @db.Uuid
  sessionType SessionType   @map("session_type")
  origin      SessionOrigin
  startedAt   DateTime      @map("started_at") @db.Timestamptz
  endedAt     DateTime?     @map("ended_at") @db.Timestamptz
  durationMs  Int?          @map("duration_ms")
  metadataJson Json?        @map("metadata_json") @db.JsonB
  createdAt   DateTime      @map("created_at") @db.Timestamptz
  updatedAt   DateTime      @map("updated_at") @db.Timestamptz

  events      SessionEvent[]

  @@index([tenantId, learnerId, startedAt(sort: Desc)])
  @@index([tenantId, sessionType, startedAt(sort: Desc)])
  @@map("sessions")
}

/// Session events table (managed by session-svc)
model SessionEvent {
  id          String           @id @db.Uuid
  sessionId   String           @map("session_id") @db.Uuid
  tenantId    String           @map("tenant_id") @db.Uuid
  learnerId   String           @map("learner_id") @db.Uuid
  eventType   SessionEventType @map("event_type")
  eventTime   DateTime         @map("event_time") @db.Timestamptz
  metadataJson Json?           @map("metadata_json") @db.JsonB
  createdAt   DateTime         @map("created_at") @db.Timestamptz

  session     Session          @relation(fields: [sessionId], references: [id])

  @@index([sessionId, eventTime(sort: Asc)])
  @@index([tenantId, learnerId, eventTime(sort: Desc)])
  @@index([tenantId, eventType, eventTime(sort: Desc)])
  @@map("session_events")
}

/// Homework submissions (managed by homework-helper-svc)
model HomeworkSubmission {
  id              String           @id @db.Uuid
  tenantId        String           @map("tenant_id") @db.Uuid
  learnerId       String           @map("learner_id") @db.Uuid
  sessionId       String?          @map("session_id") @db.Uuid
  subject         Subject
  gradeBand       GradeBand        @map("grade_band")
  status          SubmissionStatus
  stepCount       Int              @map("step_count")
  stepsCompleted  Int              @map("steps_completed")
  createdAt       DateTime         @map("created_at")
  updatedAt       DateTime         @map("updated_at")

  steps           HomeworkStep[]

  @@index([tenantId, learnerId])
  @@index([sessionId])
  @@map("homework_submissions")
}

/// Homework steps (managed by homework-helper-svc)
model HomeworkStep {
  id            String           @id @db.Uuid
  submissionId  String           @map("submission_id") @db.Uuid
  stepOrder     Int              @map("step_order")
  promptText    String           @map("prompt_text")
  hintText      String?          @map("hint_text")
  isStarted     Boolean          @map("is_started")
  isCompleted   Boolean          @map("is_completed")
  hintRevealed  Boolean          @map("hint_revealed")
  createdAt     DateTime         @map("created_at")
  updatedAt     DateTime         @map("updated_at")

  submission    HomeworkSubmission @relation(fields: [submissionId], references: [id])
  responses     HomeworkStepResponse[]

  @@index([submissionId])
  @@map("homework_steps")
}

/// Homework step responses (managed by homework-helper-svc)
model HomeworkStepResponse {
  id            String           @id @db.Uuid
  stepId        String           @map("step_id") @db.Uuid
  responseText  String           @map("response_text")
  aiFeedback    String?          @map("ai_feedback")
  isCorrect     Boolean?         @map("is_correct")
  createdAt     DateTime         @map("created_at")

  step          HomeworkStep     @relation(fields: [stepId], references: [id])

  @@index([stepId])
  @@map("homework_step_responses")
}

// ══════════════════════════════════════════════════════════════════════════════
// EXPLAINABILITY MODELS
// ══════════════════════════════════════════════════════════════════════════════

enum ExplanationSourceType {
  LESSON_PLANNER
  VIRTUAL_BRAIN
  FOCUS_AGENT
  RECOMMENDER
  SYSTEM_POLICY
  BASELINE_AGENT
  HOMEWORK_HELPER

  @@map("explanation_source_type")
}

enum ExplanationActionType {
  CONTENT_SELECTION
  DIFFICULTY_CHANGE
  FOCUS_BREAK_TRIGGER
  FOCUS_INTERVENTION
  MODULE_RECOMMENDATION
  LEARNING_PATH_ADJUSTMENT
  SKILL_PROGRESSION
  SCAFFOLDING_DECISION
  POLICY_ENFORCEMENT

  @@map("explanation_action_type")
}

/// Explanation events - structured justifications for platform decisions
model ExplanationEvent {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String                @map("tenant_id") @db.Uuid
  learnerId           String?               @map("learner_id") @db.Uuid
  userId              String?               @map("user_id") @db.Uuid
  sessionId           String?               @map("session_id") @db.Uuid
  sourceType          ExplanationSourceType @map("source_type")
  actionType          ExplanationActionType @map("action_type")
  relatedEntityType   String                @map("related_entity_type")
  relatedEntityId     String                @map("related_entity_id")
  summaryText         String                @map("summary_text")
  detailsJson         Json                  @default("{}") @map("details_json") @db.JsonB
  aiCallLogId         String?               @map("ai_call_log_id") @db.Uuid
  templateId          String?               @map("template_id") @db.Uuid
  confidence          Decimal?              @db.Decimal(4, 3)
  generatorVersion    String                @default("1.0.0") @map("generator_version")
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz

  template            ExplanationTemplate?  @relation(fields: [templateId], references: [id])

  @@index([tenantId, learnerId, createdAt(sort: Desc)])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, actionType, createdAt(sort: Desc)])
  @@index([tenantId, sourceType, createdAt(sort: Desc)])
  @@index([relatedEntityType, relatedEntityId])
  @@index([sessionId, createdAt])
  @@index([aiCallLogId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("explanation_events")
}

/// Explanation templates - vetted language patterns for consistent explanations
model ExplanationTemplate {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sourceType          ExplanationSourceType @map("source_type")
  actionType          ExplanationActionType @map("action_type")
  templateKey         String                @unique @map("template_key")
  displayName         String                @map("display_name")
  templateText        String                @map("template_text")
  placeholdersSchema  Json                  @default("{}") @map("placeholders_schema") @db.JsonB
  isActive            Boolean               @default(true) @map("is_active")
  createdBy           String?               @map("created_by") @db.Uuid
  updatedBy           String?               @map("updated_by") @db.Uuid
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  events              ExplanationEvent[]

  @@index([templateKey])
  @@index([sourceType, actionType])
  @@map("explanation_templates")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODEL CARDS & AI TRANSPARENCY
// ══════════════════════════════════════════════════════════════════════════════

enum ModelProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  INTERNAL
  META
  MISTRAL
  COHERE

  @@map("model_provider")
}

/// Model cards - AI model documentation for transparency and governance
model ModelCard {
  id                    String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelKey              String        @unique @map("model_key")
  provider              ModelProvider
  displayName           String        @map("display_name")
  description           String
  intendedUseCases      String        @map("intended_use_cases")
  limitations           String
  safetyConsiderations  String        @map("safety_considerations")
  inputTypes            String        @map("input_types")
  outputTypes           String        @map("output_types")
  dataSourcesSummary    String        @map("data_sources_summary")
  lastReviewedAt        DateTime      @map("last_reviewed_at") @db.Timestamptz
  lastReviewedBy        String?       @map("last_reviewed_by") @db.Uuid
  metadataJson          Json          @default("{}") @map("metadata_json") @db.JsonB
  createdAt             DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenantAssignments     TenantModelAssignment[]

  @@index([provider])
  @@index([modelKey])
  @@index([lastReviewedAt(sort: Desc)])
  @@map("model_cards")
}

/// Tenant model assignments - maps which models are available to each tenant
model TenantModelAssignment {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  modelCardId String    @map("model_card_id") @db.Uuid
  featureKey  String    @map("feature_key")
  isActive    Boolean   @default(true) @map("is_active")
  assignedAt  DateTime  @default(now()) @map("assigned_at") @db.Timestamptz
  assignedBy  String?   @map("assigned_by") @db.Uuid

  modelCard   ModelCard @relation(fields: [modelCardId], references: [id], onDelete: Cascade)

  @@unique([tenantId, modelCardId, featureKey])
  @@index([tenantId])
  @@index([modelCardId])
  @@index([tenantId, isActive])
  @@map("tenant_model_assignments")
}

// ══════════════════════════════════════════════════════════════════════════════
// AUDIT EVENTS
// ══════════════════════════════════════════════════════════════════════════════

enum AuditActorType {
  USER
  SYSTEM
  AGENT

  @@map("audit_actor_type")
}

enum AuditActionType {
  CREATED
  UPDATED
  DELETED
  ACTIVATED
  DEACTIVATED

  @@map("audit_action_type")
}

/// Audit events - unified audit trail for tracking changes
model AuditEvent {
  id                    String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId              String          @map("tenant_id") @db.Uuid
  actorType             AuditActorType  @map("actor_type")
  actorId               String?         @map("actor_id")
  actorDisplayName      String?         @map("actor_display_name")
  entityType            String          @map("entity_type")
  entityId              String          @map("entity_id")
  entityDisplayName     String?         @map("entity_display_name")
  action                AuditActionType
  changeJson            Json            @default("{}") @map("change_json") @db.JsonB
  summary               String
  reason                String?
  relatedExplanationId  String?         @map("related_explanation_id") @db.Uuid
  sessionId             String?         @map("session_id") @db.Uuid
  learnerId             String?         @map("learner_id") @db.Uuid
  createdAt             DateTime        @default(now()) @map("created_at") @db.Timestamptz

  @@index([tenantId, entityType, entityId, createdAt(sort: Desc)])
  @@index([tenantId, learnerId, createdAt(sort: Desc)])
  @@index([tenantId, actorType, actorId, createdAt(sort: Desc)])
  @@index([sessionId, createdAt(sort: Desc)])
  @@index([entityType, tenantId, createdAt(sort: Desc)])
  @@index([relatedExplanationId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_events")
}

// ══════════════════════════════════════════════════════════════════════════════
// LEARNING EVENTS (Raw event ingestion)
// ══════════════════════════════════════════════════════════════════════════════

enum LearningEventType {
  // Content events
  CONTENT_VIEWED
  CONTENT_STARTED
  CONTENT_COMPLETED
  CONTENT_PROGRESS
  CONTENT_BOOKMARKED
  CONTENT_RATED

  // Video events
  VIDEO_PLAY
  VIDEO_PAUSE
  VIDEO_SEEK
  VIDEO_COMPLETE

  // Assessment events
  ASSESSMENT_STARTED
  ASSESSMENT_COMPLETED
  QUESTION_ANSWERED
  QUESTION_SKIPPED
  HINT_USED

  // Session events
  SESSION_STARTED
  SESSION_ENDED
  SESSION_PAUSED
  SESSION_RESUMED

  // Engagement events
  XP_EARNED
  BADGE_EARNED
  STREAK_UPDATED
  LEVEL_UP
  ACHIEVEMENT_UNLOCKED

  // Search/Navigation
  SEARCH_PERFORMED
  RECOMMENDATION_CLICKED
  NAVIGATION

  // AI events
  AI_TUTOR_QUERY
  AI_EXPLANATION_REQUESTED
  AI_FEEDBACK_RECEIVED

  // User actions
  LOGIN
  LOGOUT
  PROFILE_UPDATED
  SETTINGS_CHANGED

  @@map("learning_event_type")
}

enum LearningEventCategory {
  LEARNING
  ASSESSMENT
  ENGAGEMENT
  NAVIGATION
  AI_INTERACTION
  SYSTEM

  @@map("learning_event_category")
}

/// Raw learning event captured from various sources
model LearningEvent {
  id            String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String                @map("tenant_id") @db.Uuid
  userId        String                @map("user_id") @db.Uuid
  sessionId     String?               @map("session_id") @db.Uuid

  eventType     LearningEventType     @map("event_type")
  eventCategory LearningEventCategory @map("event_category")

  contentId     String?               @map("content_id") @db.Uuid
  contentType   String?               @map("content_type") @db.VarChar(50)
  subjectId     String?               @map("subject_id") @db.Uuid
  topicId       String?               @map("topic_id") @db.Uuid
  assessmentId  String?               @map("assessment_id") @db.Uuid
  questionId    String?               @map("question_id") @db.Uuid

  data          Json                  @default("{}") @db.JsonB
  duration      Int?
  score         Float?

  deviceType    String?               @map("device_type") @db.VarChar(50)
  platform      String?               @db.VarChar(50)
  appVersion    String?               @map("app_version") @db.VarChar(20)

  timestamp     DateTime              @default(now()) @db.Timestamptz
  processedAt   DateTime?             @map("processed_at") @db.Timestamptz

  @@index([tenantId, timestamp(sort: Desc)], name: "idx_learning_event_tenant_time")
  @@index([userId, timestamp(sort: Desc)], name: "idx_learning_event_user_time")
  @@index([eventType], name: "idx_learning_event_type")
  @@index([contentId], name: "idx_learning_event_content")
  @@index([sessionId], name: "idx_learning_event_session")
  @@map("learning_events")
}

// ══════════════════════════════════════════════════════════════════════════════
// AGGREGATED DAILY METRICS
// ══════════════════════════════════════════════════════════════════════════════

/// Aggregated daily metrics per user
model DailyUserMetrics {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  userId               String   @map("user_id") @db.Uuid
  date                 DateTime @db.Date

  totalTimeSeconds     Int      @default(0) @map("total_time_seconds")
  activeTimeSeconds    Int      @default(0) @map("active_time_seconds")
  sessionsCount        Int      @default(0) @map("sessions_count")

  contentViewed        Int      @default(0) @map("content_viewed")
  contentCompleted     Int      @default(0) @map("content_completed")
  videosWatched        Int      @default(0) @map("videos_watched")
  videoTimeSeconds     Int      @default(0) @map("video_time_seconds")

  assessmentsStarted   Int      @default(0) @map("assessments_started")
  assessmentsCompleted Int      @default(0) @map("assessments_completed")
  questionsAnswered    Int      @default(0) @map("questions_answered")
  questionsCorrect     Int      @default(0) @map("questions_correct")
  averageScore         Float?   @map("average_score")

  xpEarned             Int      @default(0) @map("xp_earned")
  badgesEarned         Int      @default(0) @map("badges_earned")
  streakMaintained     Boolean  @default(false) @map("streak_maintained")

  aiInteractions       Int      @default(0) @map("ai_interactions")

  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, userId, date], name: "uq_daily_user_metrics")
  @@index([tenantId, date], name: "idx_daily_user_tenant_date")
  @@index([userId, date], name: "idx_daily_user_date")
  @@map("daily_user_metrics")
}

/// Aggregated daily metrics per content item
model DailyContentMetrics {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  contentId        String   @map("content_id") @db.Uuid
  contentType      String   @map("content_type") @db.VarChar(50)
  date             DateTime @db.Date

  views            Int      @default(0)
  uniqueViewers    Int      @default(0) @map("unique_viewers")
  completions      Int      @default(0)
  completionRate   Float?   @map("completion_rate")

  totalTimeSeconds Int      @default(0) @map("total_time_seconds")
  avgTimeSeconds   Float?   @map("avg_time_seconds")

  bookmarks        Int      @default(0)
  ratings          Int      @default(0)
  avgRating        Float?   @map("avg_rating")

  attempts         Int      @default(0)
  avgScore         Float?   @map("avg_score")
  passRate         Float?   @map("pass_rate")

  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, contentId, date], name: "uq_daily_content_metrics")
  @@index([tenantId, date], name: "idx_daily_content_tenant_date")
  @@index([contentId, date], name: "idx_daily_content_date")
  @@map("daily_content_metrics")
}

// ══════════════════════════════════════════════════════════════════════════════
// TOPIC/SUBJECT PROGRESS
// ══════════════════════════════════════════════════════════════════════════════

/// Aggregated topic/subject progress per user
model TopicProgress {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  subjectId        String    @map("subject_id") @db.Uuid
  topicId          String    @map("topic_id") @db.Uuid

  progressPercent  Float     @default(0) @map("progress_percent")
  masteryLevel     Float     @default(0) @map("mastery_level")

  totalContent     Int       @default(0) @map("total_content")
  completedContent Int       @default(0) @map("completed_content")

  assessmentsTaken Int       @default(0) @map("assessments_taken")
  averageScore     Float?    @map("average_score")
  bestScore        Float?    @map("best_score")

  totalTimeSeconds Int       @default(0) @map("total_time_seconds")

  firstAccessedAt  DateTime? @map("first_accessed_at") @db.Timestamptz
  lastAccessedAt   DateTime? @map("last_accessed_at") @db.Timestamptz
  masteredAt       DateTime? @map("mastered_at") @db.Timestamptz

  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, topicId], name: "uq_user_topic_progress")
  @@index([userId, subjectId], name: "idx_topic_progress_user_subject")
  @@index([tenantId, topicId], name: "idx_topic_progress_tenant_topic")
  @@map("topic_progress")
}

// ══════════════════════════════════════════════════════════════════════════════
// PERIOD ROLLUPS (Weekly/Monthly/Quarterly/Yearly)
// ══════════════════════════════════════════════════════════════════════════════

enum PeriodType {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY

  @@map("period_type")
}

enum MetricScope {
  USER
  CONTENT
  TOPIC
  SUBJECT
  TENANT

  @@map("metric_scope")
}

/// Period-based aggregated metrics
model PeriodMetrics {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  periodType  PeriodType  @map("period_type")
  periodStart DateTime    @map("period_start") @db.Date
  periodEnd   DateTime    @map("period_end") @db.Date

  scope       MetricScope
  scopeId     String?     @map("scope_id") @db.Uuid

  metrics     Json        @db.JsonB

  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz

  @@unique([tenantId, periodType, periodStart, scope, scopeId], name: "uq_period_metrics")
  @@index([tenantId, periodType, periodStart], name: "idx_period_metrics_lookup")
  @@map("period_metrics")
}

// ══════════════════════════════════════════════════════════════════════════════
// METRICS CACHE
// ══════════════════════════════════════════════════════════════════════════════

/// Cache for dashboard metrics
model MetricsCache {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  cacheKey  String   @map("cache_key") @db.VarChar(255)
  metrics   Json     @db.JsonB
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, cacheKey], name: "uq_metrics_cache")
  @@index([expiresAt], name: "idx_metrics_cache_expires")
  @@map("metrics_cache")
}

// ══════════════════════════════════════════════════════════════════════════════
// LEARNING PATH ANALYTICS
// ══════════════════════════════════════════════════════════════════════════════

/// Analytics for learning path progression
model LearningPathAnalytics {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  pathId           String    @map("path_id") @db.Uuid

  startedAt        DateTime  @map("started_at") @db.Timestamptz
  completedAt      DateTime? @map("completed_at") @db.Timestamptz
  currentNodeId    String?   @map("current_node_id") @db.Uuid
  nodesCompleted   Int       @default(0) @map("nodes_completed")
  totalNodes       Int       @map("total_nodes")

  averageScore     Float?    @map("average_score")
  totalTimeSeconds Int       @default(0) @map("total_time_seconds")

  sessionsCount    Int       @default(0) @map("sessions_count")
  lastSessionAt    DateTime? @map("last_session_at") @db.Timestamptz

  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, pathId], name: "uq_user_path_analytics")
  @@index([tenantId, pathId], name: "idx_path_analytics_tenant")
  @@map("learning_path_analytics")
}

// ══════════════════════════════════════════════════════════════════════════════
// TEACHER ANALYTICS - IEP & ENGAGEMENT TRACKING
// ══════════════════════════════════════════════════════════════════════════════

enum IEPGoalStatus {
  ON_TRACK
  BEHIND
  AT_RISK
  COMPLETED
  DISCONTINUED

  @@map("iep_goal_status")
}

enum IEPGoalCategory {
  READING
  MATH
  WRITING
  COMMUNICATION
  SOCIAL_EMOTIONAL
  BEHAVIOR
  MOTOR_SKILLS
  DAILY_LIVING
  OTHER

  @@map("iep_goal_category")
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("risk_level")
}

enum MasteryLevel {
  NOT_STARTED
  BEGINNING
  DEVELOPING
  PROFICIENT
  MASTERED

  @@map("mastery_level")
}

/// IEP Goals for students with Individualized Education Programs
model IEPGoal {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  classId              String?           @map("class_id") @db.Uuid
  
  description          String
  category             IEPGoalCategory
  status               IEPGoalStatus     @default(ON_TRACK)
  
  targetDate           DateTime          @map("target_date") @db.Date
  currentProgress      Float             @default(0) @map("current_progress")
  expectedProgress     Float             @default(0) @map("expected_progress")
  
  relatedSkillId       String?           @map("related_skill_id") @db.Uuid
  relatedSkillName     String?           @map("related_skill_name")
  
  createdBy            String            @map("created_by") @db.Uuid
  lastModifiedBy       String?           @map("last_modified_by") @db.Uuid
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  progressRecords      IEPProgressRecord[]

  @@index([tenantId, learnerId, status])
  @@index([tenantId, classId, status])
  @@index([learnerId, category])
  @@index([targetDate])
  @@map("iep_goals")
}

/// Progress records for IEP goals
model IEPProgressRecord {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  goalId               String            @map("goal_id") @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  
  progressValue        Float             @map("progress_value")
  notes                String?
  
  recordedBy           String            @map("recorded_by") @db.Uuid
  recordedAt           DateTime          @default(now()) @map("recorded_at") @db.Timestamptz
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz

  goal                 IEPGoal           @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId, recordedAt(sort: Desc)])
  @@index([tenantId, learnerId, recordedAt(sort: Desc)])
  @@map("iep_progress_records")
}

/// Learner model snapshots for tracking mastery/engagement over time
model LearnerModelSnapshot {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  classId              String?           @map("class_id") @db.Uuid
  
  snapshotDate         DateTime          @map("snapshot_date") @db.Date
  
  // Mastery metrics
  overallMastery       Float             @map("overall_mastery")
  masteryLevel         MasteryLevel      @map("mastery_level")
  skillsMastered       Int               @default(0) @map("skills_mastered")
  skillsInProgress     Int               @default(0) @map("skills_in_progress")
  skillsNotStarted     Int               @default(0) @map("skills_not_started")
  
  // Engagement metrics
  engagementScore      Float             @map("engagement_score")
  totalTimeMinutes     Int               @default(0) @map("total_time_minutes")
  sessionsCompleted    Int               @default(0) @map("sessions_completed")
  avgSessionDuration   Float?            @map("avg_session_duration")
  
  // Risk assessment
  riskLevel            RiskLevel         @map("risk_level")
  riskFactors          Json              @default("[]") @map("risk_factors") @db.JsonB
  
  // Detailed skill breakdown (JSON for flexibility)
  skillBreakdown       Json              @default("[]") @map("skill_breakdown") @db.JsonB
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz

  @@unique([tenantId, learnerId, snapshotDate], name: "uq_learner_snapshot")
  @@index([tenantId, classId, snapshotDate(sort: Desc)])
  @@index([learnerId, snapshotDate(sort: Desc)])
  @@index([tenantId, riskLevel, snapshotDate(sort: Desc)])
  @@map("learner_model_snapshots")
}

/// Class analytics summary - aggregated metrics per class
model ClassAnalyticsSummary {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  classId              String            @map("class_id") @db.Uuid
  teacherId            String            @map("teacher_id") @db.Uuid
  
  summaryDate          DateTime          @map("summary_date") @db.Date
  
  // Student counts
  totalStudents        Int               @default(0) @map("total_students")
  studentsWithIEP      Int               @default(0) @map("students_with_iep")
  
  // Mastery distribution
  masteredCount        Int               @default(0) @map("mastered_count")
  proficientCount      Int               @default(0) @map("proficient_count")
  developingCount      Int               @default(0) @map("developing_count")
  beginningCount       Int               @default(0) @map("beginning_count")
  
  avgClassMastery      Float             @default(0) @map("avg_class_mastery")
  masteryTrend         Float             @default(0) @map("mastery_trend")
  
  // Engagement metrics
  avgEngagement        Float             @default(0) @map("avg_engagement")
  engagementTrend      Float             @default(0) @map("engagement_trend")
  totalTimeMinutes     Int               @default(0) @map("total_time_minutes")
  
  // Risk distribution
  lowRiskCount         Int               @default(0) @map("low_risk_count")
  mediumRiskCount      Int               @default(0) @map("medium_risk_count")
  highRiskCount        Int               @default(0) @map("high_risk_count")
  criticalRiskCount    Int               @default(0) @map("critical_risk_count")
  
  // IEP summary
  iepGoalsOnTrack      Int               @default(0) @map("iep_goals_on_track")
  iepGoalsAtRisk       Int               @default(0) @map("iep_goals_at_risk")
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, classId, summaryDate], name: "uq_class_summary")
  @@index([teacherId, summaryDate(sort: Desc)])
  @@index([tenantId, summaryDate(sort: Desc)])
  @@map("class_analytics_summaries")
}

/// Teacher contact log - tracks parent/guardian communications
model TeacherContactLog {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  teacherId            String            @map("teacher_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  classId              String?           @map("class_id") @db.Uuid
  
  contactType          String            @map("contact_type") @db.VarChar(50)
  contactMethod        String            @map("contact_method") @db.VarChar(50)
  subject              String
  notes                String?
  
  contactDate          DateTime          @map("contact_date") @db.Timestamptz
  followUpDate         DateTime?         @map("follow_up_date") @db.Date
  followUpCompleted    Boolean           @default(false) @map("follow_up_completed")
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, teacherId, contactDate(sort: Desc)])
  @@index([tenantId, learnerId, contactDate(sort: Desc)])
  @@index([followUpDate, followUpCompleted])
  @@map("teacher_contact_logs")
}

/// Student accommodations - special support requirements
model StudentAccommodation {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  
  accommodationType    String            @map("accommodation_type") @db.VarChar(100)
  description          String
  isActive             Boolean           @default(true) @map("is_active")
  
  effectiveFrom        DateTime          @map("effective_from") @db.Date
  effectiveUntil       DateTime?         @map("effective_until") @db.Date
  
  createdBy            String            @map("created_by") @db.Uuid
  lastModifiedBy       String?           @map("last_modified_by") @db.Uuid
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, learnerId, isActive])
  @@index([learnerId, accommodationType])
  @@map("student_accommodations")
}

/// IEP Review schedule - upcoming reviews for students
model IEPReviewSchedule {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  learnerId            String            @map("learner_id") @db.Uuid
  classId              String?           @map("class_id") @db.Uuid
  
  reviewDate           DateTime          @map("review_date") @db.Date
  reviewType           String            @map("review_type") @db.VarChar(50)
  notes                String?
  
  isCompleted          Boolean           @default(false) @map("is_completed")
  completedAt          DateTime?         @map("completed_at") @db.Timestamptz
  completedBy          String?           @map("completed_by") @db.Uuid
  
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, reviewDate, isCompleted])
  @@index([tenantId, learnerId])
  @@index([classId, reviewDate])
  @@map("iep_review_schedules")
}
