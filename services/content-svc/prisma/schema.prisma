generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

enum LearningObjectSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  OTHER

  @@map("learning_object_subject")
}

enum LearningObjectGradeBand {
  K_2
  G3_5
  G6_8
  G9_12

  @@map("learning_object_grade_band")
}

enum LearningObjectVersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED

  @@map("learning_object_version_state")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Logical identity of a learning content unit.
/// Examples: "ELA G3 reading passage: Dogs in Winter"
model LearningObject {
  id               String                   @id @default(uuid()) @db.Uuid
  tenantId         String?                  @map("tenant_id") @db.Uuid
  slug             String
  title            String
  subject          LearningObjectSubject
  gradeBand        LearningObjectGradeBand  @map("grade_band")
  primarySkillId   String?                  @map("primary_skill_id") @db.Uuid
  isActive         Boolean                  @default(true) @map("is_active")
  createdByUserId  String                   @map("created_by_user_id") @db.Uuid
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  versions LearningObjectVersion[]
  tags     LearningObjectTag[]

  @@unique([tenantId, slug])
  @@index([tenantId, subject, gradeBand])
  @@index([primarySkillId])
  @@map("learning_objects")
}

/// Versioned content with review workflow.
/// Only one PUBLISHED version per LO at a time.
model LearningObjectVersion {
  id                 String                      @id @default(uuid()) @db.Uuid
  learningObjectId   String                      @map("learning_object_id") @db.Uuid
  versionNumber      Int                         @map("version_number")
  state              LearningObjectVersionState  @default(DRAFT)
  createdByUserId    String                      @map("created_by_user_id") @db.Uuid
  reviewedByUserId   String?                     @map("reviewed_by_user_id") @db.Uuid
  approvedByUserId   String?                     @map("approved_by_user_id") @db.Uuid
  changeSummary      String?                     @map("change_summary")
  reviewNotes        String?                     @map("review_notes")
  contentJson        Json                        @map("content_json")
  accessibilityJson  Json                        @default("{}") @map("accessibility_json")
  standardsJson      Json                        @default("{}") @map("standards_json")
  metadataJson       Json                        @default("{}") @map("metadata_json")
  createdAt          DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                    @updatedAt @map("updated_at") @db.Timestamptz
  publishedAt        DateTime?                   @map("published_at") @db.Timestamptz
  retiredAt          DateTime?                   @map("retired_at") @db.Timestamptz

  // Relations
  learningObject LearningObject                   @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  skills         LearningObjectSkill[]
  transitions    LearningObjectVersionTransition[]
  reviews        LearningObjectReview[]

  @@unique([learningObjectId, versionNumber])
  @@index([learningObjectId, state, versionNumber(sort: Desc)])
  @@index([state])
  @@map("learning_object_versions")
}

/// Flexible tags for content discovery and filtering.
model LearningObjectTag {
  id               String   @id @default(uuid()) @db.Uuid
  learningObjectId String   @map("learning_object_id") @db.Uuid
  tag              String
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObject LearningObject @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)

  @@unique([learningObjectId, tag])
  @@index([tag])
  @@map("learning_object_tags")
}

/// Version-specific skill alignments beyond the primary skill.
model LearningObjectSkill {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  skillId                  String   @map("skill_id") @db.Uuid
  isPrimary                Boolean  @default(false) @map("is_primary")
  weight                   Decimal? @db.Decimal(4, 3)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, skillId])
  @@index([skillId])
  @@map("learning_object_skills")
}

/// Audit trail for all workflow state changes.
model LearningObjectVersionTransition {
  id                    String                      @id @default(uuid()) @db.Uuid
  versionId             String                      @map("version_id") @db.Uuid
  fromState             LearningObjectVersionState  @map("from_state")
  toState               LearningObjectVersionState  @map("to_state")
  transitionedByUserId  String                      @map("transitioned_by_user_id") @db.Uuid
  reason                String?
  transitionedAt        DateTime                    @default(now()) @map("transitioned_at") @db.Timestamptz

  // Relations
  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("learning_object_version_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT REVIEW
// ══════════════════════════════════════════════════════════════════════════════

enum ReviewDecision {
  APPROVED
  CHANGES_REQUESTED
  REJECTED

  @@map("review_decision")
}

/// Formal review records for learning object versions.
/// Supports multiple reviewers and detailed feedback tracking.
model LearningObjectReview {
  id                String                      @id @default(uuid()) @db.Uuid
  versionId         String                      @map("version_id") @db.Uuid
  reviewerUserId    String                      @map("reviewer_user_id") @db.Uuid
  decision          ReviewDecision
  comments          String?                     @db.Text
  validationErrors  Json                        @default("[]") @map("validation_errors")
  checklist         Json                        @default("{}") @map("checklist")
  createdAt         DateTime                    @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, createdAt(sort: Desc)])
  @@index([reviewerUserId])
  @@map("learning_object_reviews")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT INGESTION
// ══════════════════════════════════════════════════════════════════════════════

enum IngestionJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED

  @@map("ingestion_job_status")
}

enum IngestionSource {
  MANUAL      // Structured JSON via API
  FILE_CSV    // CSV file upload
  FILE_JSON   // JSON file upload
  AI_DRAFT    // AI-generated content

  @@map("ingestion_source")
}

/// Tracks bulk content ingestion jobs with row-level error reporting.
model IngestionJob {
  id                String                   @id @default(uuid()) @db.Uuid
  tenantId          String?                  @map("tenant_id") @db.Uuid
  source            IngestionSource
  status            IngestionJobStatus       @default(PENDING)
  
  // Input metadata
  inputFileUrl      String?                  @map("input_file_url")
  inputMetadata     Json                     @default("{}") @map("input_metadata")
  
  // Results
  totalRows         Int                      @default(0) @map("total_rows")
  successCount      Int                      @default(0) @map("success_count")
  errorCount        Int                      @default(0) @map("error_count")
  createdLoIds      String[]                 @default([]) @map("created_lo_ids") @db.Uuid
  
  // Error details (array of { row, field, message })
  errors            Json                     @default("[]")
  
  // Tracking
  createdByUserId   String                   @map("created_by_user_id") @db.Uuid
  startedAt         DateTime?                @map("started_at") @db.Timestamptz
  completedAt       DateTime?                @map("completed_at") @db.Timestamptz
  createdAt         DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([createdByUserId])
  @@map("ingestion_jobs")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT PACKAGING
// ══════════════════════════════════════════════════════════════════════════════

enum ContentPackageStatus {
  PENDING
  BUILDING
  READY
  EXPIRED
  FAILED

  @@map("content_package_status")
}

enum ContentLocale {
  en
  es
  fr
  zh
  ar

  @@map("content_locale")
}

/// Content package for bulk device preloading and delta updates.
model ContentPackage {
  id                 String                @id @default(uuid()) @db.Uuid
  tenantId           String                @map("tenant_id") @db.Uuid
  gradeBands         LearningObjectGradeBand[] @map("grade_bands")
  subjects           LearningObjectSubject[]   @map("subjects")
  locales            ContentLocale[]       @default([en])
  status             ContentPackageStatus  @default(PENDING)
  manifestUrl        String?               @map("manifest_url")
  bundleUrl          String?               @map("bundle_url")
  totalItems         Int                   @default(0) @map("total_items")
  totalSizeBytes     BigInt                @default(0) @map("total_size_bytes")
  requestedAt        DateTime              @default(now()) @map("requested_at") @db.Timestamptz
  completedAt        DateTime?             @map("completed_at") @db.Timestamptz
  expiresAt          DateTime?             @map("expires_at") @db.Timestamptz
  requestedByUserId  String                @map("requested_by_user_id") @db.Uuid
  errorMessage       String?               @map("error_message")
  urlExpirationHours Int                   @default(24) @map("url_expiration_hours")
  updatedSince       DateTime?             @map("updated_since") @db.Timestamptz
  createdAt          DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, status])
  @@index([tenantId, requestedAt(sort: Desc)])
  @@map("content_packages")
}

/// Track content version changes for delta updates.
model ContentVersionChange {
  id                String                   @id @default(uuid()) @db.Uuid
  loVersionId       String                   @map("lo_version_id") @db.Uuid
  learningObjectId  String                   @map("learning_object_id") @db.Uuid
  tenantId          String?                  @map("tenant_id") @db.Uuid
  subject           LearningObjectSubject
  gradeBand         LearningObjectGradeBand  @map("grade_band")
  versionNumber     Int                      @map("version_number")
  changeType        String                   @map("change_type") // ADDED, UPDATED, REMOVED
  checksum          String?
  sizeBytes         BigInt?                  @map("size_bytes")
  locale            ContentLocale            @default(en)
  changedAt         DateTime                 @default(now()) @map("changed_at") @db.Timestamptz

  @@index([tenantId, changedAt(sort: Desc)])
  @@index([tenantId, subject, gradeBand, changedAt(sort: Desc)])
  @@map("content_version_changes")
}

// ══════════════════════════════════════════════════════════════════════════════
// FILE STORAGE
// ══════════════════════════════════════════════════════════════════════════════

/// File category for access control and lifecycle policies.
enum FileCategory {
  IEP_DOCUMENT        // Individualized Education Program documents
  HOMEWORK_IMAGE      // Student-uploaded homework photos
  ASSESSMENT_AUDIO    // Recorded audio responses
  ASSESSMENT_VIDEO    // Recorded video responses
  AVATAR_IMAGE        // User profile images
  EXPORTED_REPORT     // Generated PDF/CSV reports
  ATTACHMENT          // General file attachments
  OTHER               // Uncategorized files

  @@map("file_category")
}

/// Owner type for files - user or system.
enum FileOwnerType {
  USER                // Owned by a specific user
  SYSTEM              // System-generated file
  TENANT              // Tenant-level shared resource

  @@map("file_owner_type")
}

/// Virus scan status for uploaded files.
enum VirusScanStatus {
  PENDING             // Not yet scanned
  SCANNING            // Currently being scanned
  CLEAN               // No threats detected
  INFECTED            // Threat detected and file quarantined
  ERROR               // Scan failed

  @@map("virus_scan_status")
}

/// Tenant-scoped file storage with virus scanning and access control.
/// S3 key format: {tenantId}/{ownerType}/{ownerId}/{category}/{fileId}/{filename}
model StoredFile {
  id                String           @id @default(uuid()) @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  ownerId           String           @map("owner_id") @db.Uuid
  ownerType         FileOwnerType    @default(USER) @map("owner_type")
  category          FileCategory     @default(OTHER)
  
  // File metadata
  filename          String
  mimeType          String           @map("mime_type")
  sizeBytes         BigInt           @map("size_bytes")
  checksum          String?          // SHA-256 hash for integrity
  
  // S3 storage location
  s3Bucket          String           @map("s3_bucket")
  s3Key             String           @map("s3_key")
  s3Region          String?          @map("s3_region")
  
  // Virus scanning
  virusScanStatus   VirusScanStatus  @default(PENDING) @map("virus_scan_status")
  virusScannedAt    DateTime?        @map("virus_scanned_at") @db.Timestamptz
  virusScanResult   Json?            @map("virus_scan_result")
  
  // Soft delete
  isDeleted         Boolean          @default(false) @map("is_deleted")
  deletedAt         DateTime?        @map("deleted_at") @db.Timestamptz
  deletedByUserId   String?          @map("deleted_by_user_id") @db.Uuid
  
  // Extended metadata (tags, description, etc.)
  metadataJson      Json             @default("{}") @map("metadata_json")
  
  // Timestamps
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz
  
  // Lifecycle
  expiresAt         DateTime?        @map("expires_at") @db.Timestamptz

  // Indexes for efficient tenant-scoped queries
  @@index([tenantId, ownerId, category])
  @@index([tenantId, category, createdAt(sort: Desc)])
  @@index([tenantId, virusScanStatus])
  @@index([s3Key], type: Hash)
  @@index([tenantId, isDeleted, expiresAt])
  @@map("stored_files")
}
