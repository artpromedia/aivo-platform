generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

enum LearningObjectSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  OTHER

  @@map("learning_object_subject")
}

enum LearningObjectGradeBand {
  K_2
  G3_5
  G6_8
  G9_12

  @@map("learning_object_grade_band")
}

enum LearningObjectVersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED

  @@map("learning_object_version_state")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Logical identity of a learning content unit.
/// Examples: "ELA G3 reading passage: Dogs in Winter"
model LearningObject {
  id               String                   @id @default(uuid()) @db.Uuid
  tenantId         String?                  @map("tenant_id") @db.Uuid
  slug             String
  title            String
  subject          LearningObjectSubject
  gradeBand        LearningObjectGradeBand  @map("grade_band")
  primarySkillId   String?                  @map("primary_skill_id") @db.Uuid
  isActive         Boolean                  @default(true) @map("is_active")
  createdByUserId  String                   @map("created_by_user_id") @db.Uuid
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  versions LearningObjectVersion[]
  tags     LearningObjectTag[]

  @@unique([tenantId, slug])
  @@index([tenantId, subject, gradeBand])
  @@index([primarySkillId])
  @@map("learning_objects")
}

/// Versioned content with review workflow.
/// Only one PUBLISHED version per LO at a time.
model LearningObjectVersion {
  id                 String                      @id @default(uuid()) @db.Uuid
  learningObjectId   String                      @map("learning_object_id") @db.Uuid
  versionNumber      Int                         @map("version_number")
  state              LearningObjectVersionState  @default(DRAFT)
  createdByUserId    String                      @map("created_by_user_id") @db.Uuid
  reviewedByUserId   String?                     @map("reviewed_by_user_id") @db.Uuid
  approvedByUserId   String?                     @map("approved_by_user_id") @db.Uuid
  changeSummary      String?                     @map("change_summary")
  reviewNotes        String?                     @map("review_notes")
  contentJson        Json                        @map("content_json")
  accessibilityJson  Json                        @default("{}") @map("accessibility_json")
  standardsJson      Json                        @default("{}") @map("standards_json")
  metadataJson       Json                        @default("{}") @map("metadata_json")
  createdAt          DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                    @updatedAt @map("updated_at") @db.Timestamptz
  publishedAt        DateTime?                   @map("published_at") @db.Timestamptz
  retiredAt          DateTime?                   @map("retired_at") @db.Timestamptz

  // Relations
  learningObject LearningObject                   @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  skills         LearningObjectSkill[]
  transitions    LearningObjectVersionTransition[]
  reviews        LearningObjectReview[]

  @@unique([learningObjectId, versionNumber])
  @@index([learningObjectId, state, versionNumber(sort: Desc)])
  @@index([state])
  @@map("learning_object_versions")
}

/// Flexible tags for content discovery and filtering.
model LearningObjectTag {
  id               String   @id @default(uuid()) @db.Uuid
  learningObjectId String   @map("learning_object_id") @db.Uuid
  tag              String
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObject LearningObject @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)

  @@unique([learningObjectId, tag])
  @@index([tag])
  @@map("learning_object_tags")
}

/// Version-specific skill alignments beyond the primary skill.
model LearningObjectSkill {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  skillId                  String   @map("skill_id") @db.Uuid
  isPrimary                Boolean  @default(false) @map("is_primary")
  weight                   Decimal? @db.Decimal(4, 3)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, skillId])
  @@index([skillId])
  @@map("learning_object_skills")
}

/// Audit trail for all workflow state changes.
model LearningObjectVersionTransition {
  id                    String                      @id @default(uuid()) @db.Uuid
  versionId             String                      @map("version_id") @db.Uuid
  fromState             LearningObjectVersionState  @map("from_state")
  toState               LearningObjectVersionState  @map("to_state")
  transitionedByUserId  String                      @map("transitioned_by_user_id") @db.Uuid
  reason                String?
  transitionedAt        DateTime                    @default(now()) @map("transitioned_at") @db.Timestamptz

  // Relations
  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("learning_object_version_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT REVIEW
// ══════════════════════════════════════════════════════════════════════════════

enum ReviewDecision {
  APPROVED
  CHANGES_REQUESTED
  REJECTED

  @@map("review_decision")
}

/// Formal review records for learning object versions.
/// Supports multiple reviewers and detailed feedback tracking.
model LearningObjectReview {
  id                String                      @id @default(uuid()) @db.Uuid
  versionId         String                      @map("version_id") @db.Uuid
  reviewerUserId    String                      @map("reviewer_user_id") @db.Uuid
  decision          ReviewDecision
  comments          String?                     @db.Text
  validationErrors  Json                        @default("[]") @map("validation_errors")
  checklist         Json                        @default("{}") @map("checklist")
  createdAt         DateTime                    @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, createdAt(sort: Desc)])
  @@index([reviewerUserId])
  @@map("learning_object_reviews")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT INGESTION
// ══════════════════════════════════════════════════════════════════════════════

enum IngestionJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED

  @@map("ingestion_job_status")
}

enum IngestionSource {
  MANUAL      // Structured JSON via API
  FILE_CSV    // CSV file upload
  FILE_JSON   // JSON file upload
  AI_DRAFT    // AI-generated content

  @@map("ingestion_source")
}

/// Tracks bulk content ingestion jobs with row-level error reporting.
model IngestionJob {
  id                String                   @id @default(uuid()) @db.Uuid
  tenantId          String?                  @map("tenant_id") @db.Uuid
  source            IngestionSource
  status            IngestionJobStatus       @default(PENDING)
  
  // Input metadata
  inputFileUrl      String?                  @map("input_file_url")
  inputMetadata     Json                     @default("{}") @map("input_metadata")
  
  // Results
  totalRows         Int                      @default(0) @map("total_rows")
  successCount      Int                      @default(0) @map("success_count")
  errorCount        Int                      @default(0) @map("error_count")
  createdLoIds      String[]                 @default([]) @map("created_lo_ids") @db.Uuid
  
  // Error details (array of { row, field, message })
  errors            Json                     @default("[]")
  
  // Tracking
  createdByUserId   String                   @map("created_by_user_id") @db.Uuid
  startedAt         DateTime?                @map("started_at") @db.Timestamptz
  completedAt       DateTime?                @map("completed_at") @db.Timestamptz
  createdAt         DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([createdByUserId])
  @@map("ingestion_jobs")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT PACKAGING
// ══════════════════════════════════════════════════════════════════════════════

enum ContentPackageStatus {
  PENDING
  BUILDING
  READY
  EXPIRED
  FAILED

  @@map("content_package_status")
}

enum ContentLocale {
  en
  es
  fr
  zh
  ar

  @@map("content_locale")
}

/// Content package for bulk device preloading and delta updates.
model ContentPackage {
  id                 String                @id @default(uuid()) @db.Uuid
  tenantId           String                @map("tenant_id") @db.Uuid
  gradeBands         LearningObjectGradeBand[] @map("grade_bands")
  subjects           LearningObjectSubject[]   @map("subjects")
  locales            ContentLocale[]       @default([en])
  status             ContentPackageStatus  @default(PENDING)
  manifestUrl        String?               @map("manifest_url")
  bundleUrl          String?               @map("bundle_url")
  totalItems         Int                   @default(0) @map("total_items")
  totalSizeBytes     BigInt                @default(0) @map("total_size_bytes")
  requestedAt        DateTime              @default(now()) @map("requested_at") @db.Timestamptz
  completedAt        DateTime?             @map("completed_at") @db.Timestamptz
  expiresAt          DateTime?             @map("expires_at") @db.Timestamptz
  requestedByUserId  String                @map("requested_by_user_id") @db.Uuid
  errorMessage       String?               @map("error_message")
  urlExpirationHours Int                   @default(24) @map("url_expiration_hours")
  updatedSince       DateTime?             @map("updated_since") @db.Timestamptz
  createdAt          DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, status])
  @@index([tenantId, requestedAt(sort: Desc)])
  @@map("content_packages")
}

/// Track content version changes for delta updates.
model ContentVersionChange {
  id                String                   @id @default(uuid()) @db.Uuid
  loVersionId       String                   @map("lo_version_id") @db.Uuid
  learningObjectId  String                   @map("learning_object_id") @db.Uuid
  tenantId          String?                  @map("tenant_id") @db.Uuid
  subject           LearningObjectSubject
  gradeBand         LearningObjectGradeBand  @map("grade_band")
  versionNumber     Int                      @map("version_number")
  changeType        String                   @map("change_type") // ADDED, UPDATED, REMOVED
  checksum          String?
  sizeBytes         BigInt?                  @map("size_bytes")
  locale            ContentLocale            @default(en)
  changedAt         DateTime                 @default(now()) @map("changed_at") @db.Timestamptz

  @@index([tenantId, changedAt(sort: Desc)])
  @@index([tenantId, subject, gradeBand, changedAt(sort: Desc)])
  @@map("content_version_changes")
}

// ══════════════════════════════════════════════════════════════════════════════
// FILE STORAGE
// ══════════════════════════════════════════════════════════════════════════════

/// File category for access control and lifecycle policies.
enum FileCategory {
  IEP_DOCUMENT        // Individualized Education Program documents
  HOMEWORK_IMAGE      // Student-uploaded homework photos
  ASSESSMENT_AUDIO    // Recorded audio responses
  ASSESSMENT_VIDEO    // Recorded video responses
  AVATAR_IMAGE        // User profile images
  EXPORTED_REPORT     // Generated PDF/CSV reports
  ATTACHMENT          // General file attachments
  OTHER               // Uncategorized files

  @@map("file_category")
}

/// Owner type for files - user or system.
enum FileOwnerType {
  USER                // Owned by a specific user
  SYSTEM              // System-generated file
  TENANT              // Tenant-level shared resource

  @@map("file_owner_type")
}

/// Virus scan status for uploaded files.
enum VirusScanStatus {
  PENDING             // Not yet scanned
  SCANNING            // Currently being scanned
  CLEAN               // No threats detected
  INFECTED            // Threat detected and file quarantined
  ERROR               // Scan failed

  @@map("virus_scan_status")
}

/// Tenant-scoped file storage with virus scanning and access control.
/// S3 key format: {tenantId}/{ownerType}/{ownerId}/{category}/{fileId}/{filename}
model StoredFile {
  id                String           @id @default(uuid()) @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  ownerId           String           @map("owner_id") @db.Uuid
  ownerType         FileOwnerType    @default(USER) @map("owner_type")
  category          FileCategory     @default(OTHER)
  
  // File metadata
  filename          String
  mimeType          String           @map("mime_type")
  sizeBytes         BigInt           @map("size_bytes")
  checksum          String?          // SHA-256 hash for integrity
  
  // S3 storage location
  s3Bucket          String           @map("s3_bucket")
  s3Key             String           @map("s3_key")
  s3Region          String?          @map("s3_region")
  
  // Virus scanning
  virusScanStatus   VirusScanStatus  @default(PENDING) @map("virus_scan_status")
  virusScannedAt    DateTime?        @map("virus_scanned_at") @db.Timestamptz
  virusScanResult   Json?            @map("virus_scan_result")
  
  // Soft delete
  isDeleted         Boolean          @default(false) @map("is_deleted")
  deletedAt         DateTime?        @map("deleted_at") @db.Timestamptz
  deletedByUserId   String?          @map("deleted_by_user_id") @db.Uuid
  
  // Extended metadata (tags, description, etc.)
  metadataJson      Json             @default("{}") @map("metadata_json")
  
  // Timestamps
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz
  
  // Lifecycle
  expiresAt         DateTime?        @map("expires_at") @db.Timestamptz

  // Indexes for efficient tenant-scoped queries
  @@index([tenantId, ownerId, category])
  @@index([tenantId, category, createdAt(sort: Desc)])
  @@index([tenantId, virusScanStatus])
  @@index([s3Key], type: Hash)
  @@index([tenantId, isDeleted, expiresAt])
  @@map("stored_files")
}

// ══════════════════════════════════════════════════════════════════════════════
// SOCIAL STORIES - ND-1.2
// Evidence-based visual narratives for neurodiverse learners
// ══════════════════════════════════════════════════════════════════════════════

/// Categories for social stories following Carol Gray's Social Stories framework
enum SocialStoryCategory {
  // Transition & Routine
  STARTING_LESSON          // Beginning academic activities
  ENDING_LESSON            // Completing and wrapping up activities
  CHANGING_ACTIVITY        // Moving between different tasks
  UNEXPECTED_CHANGE        // Handling schedule changes
  
  // Assessment & Testing
  TAKING_QUIZ              // Quiz and assessment situations
  TEST_TAKING              // Formal test-taking strategies
  RECEIVING_FEEDBACK       // Getting grades or corrections
  
  // Communication & Help
  ASKING_FOR_HELP          // Requesting assistance
  ASKING_FOR_BREAK         // Requesting sensory/mental breaks
  RAISING_HAND             // Classroom participation
  TALKING_TO_TEACHER       // Teacher communication
  
  // Emotional Regulation
  FEELING_FRUSTRATED       // Managing frustration
  FEELING_OVERWHELMED      // Handling sensory/cognitive overload
  FEELING_ANXIOUS          // Anxiety management
  CALMING_DOWN             // Self-regulation strategies
  CELEBRATING_SUCCESS      // Appropriate celebration
  
  // Focus & Attention
  STAYING_ON_TASK          // Maintaining focus
  IGNORING_DISTRACTIONS    // Handling interruptions
  WAITING_TURN             // Patient waiting
  
  // Technology
  USING_DEVICE             // Device handling expectations
  TECHNICAL_PROBLEM        // Handling tech issues
  
  // Social Interactions
  WORKING_WITH_PEERS       // Group work situations
  SHARING_MATERIALS        // Resource sharing
  RESPECTFUL_DISAGREEMENT  // Handling different opinions
  
  // Sensory & Physical
  SENSORY_BREAK            // Taking sensory breaks
  MOVEMENT_BREAK           // Physical activity breaks
  QUIET_SPACE              // Using calm-down areas
  
  // Safety & Emergencies
  FIRE_DRILL               // Emergency procedures
  LOCKDOWN                 // Safety procedures
  FEELING_UNSAFE           // Reporting concerns
  
  // Custom
  CUSTOM                   // User-defined category

  @@map("social_story_category")
}

/// Reading level for social story content
enum SocialStoryReadingLevel {
  PRE_READER       // Picture-only with minimal text
  EARLY_READER     // Simple sentences, large text
  DEVELOPING       // Short paragraphs
  INTERMEDIATE     // Grade-level text
  
  @@map("social_story_reading_level")
}

/// Visual style preferences for social stories
enum SocialStoryVisualStyle {
  PHOTOGRAPHS      // Real photographs
  REALISTIC_ART    // Realistic illustrations
  CARTOON          // Cartoon-style illustrations
  SIMPLE_ICONS     // Simple symbolic icons
  ABSTRACT         // Abstract/minimalist visuals
  
  @@map("social_story_visual_style")
}

/// Social story content - visual narratives for behavioral support
model SocialStory {
  id                String                    @id @default(uuid()) @db.Uuid
  tenantId          String?                   @map("tenant_id") @db.Uuid
  
  // Basic metadata
  slug              String                    @unique
  title             String
  description       String?                   @db.Text
  category          SocialStoryCategory
  
  // Content
  pages             Json                      @default("[]") // Array of StoryPage
  readingLevel      SocialStoryReadingLevel   @default(DEVELOPING) @map("reading_level")
  estimatedDuration Int                       @default(60) @map("estimated_duration") // seconds
  
  // Targeting
  minAge            Int?                      @map("min_age")
  maxAge            Int?                      @map("max_age")
  gradeBands        LearningObjectGradeBand[] @map("grade_bands")
  
  // Personalization tokens
  supportsPersonalization Boolean             @default(true) @map("supports_personalization")
  personalizationTokens   String[]            @default([]) @map("personalization_tokens")
  
  // Visual preferences
  defaultVisualStyle SocialStoryVisualStyle   @default(CARTOON) @map("default_visual_style")
  hasAudio          Boolean                   @default(false) @map("has_audio")
  hasVideo          Boolean                   @default(false) @map("has_video")
  
  // Accessibility
  accessibilityFeatures Json                  @default("{}") @map("accessibility_features")
  translations      Json                      @default("{}") // Locale -> translated content
  
  // Source & versioning
  isBuiltIn         Boolean                   @default(false) @map("is_built_in")
  sourceTemplate    String?                   @map("source_template")
  version           Int                       @default(1)
  
  // Status
  isActive          Boolean                   @default(true) @map("is_active")
  isApproved        Boolean                   @default(false) @map("is_approved")
  approvedByUserId  String?                   @map("approved_by_user_id") @db.Uuid
  approvedAt        DateTime?                 @map("approved_at") @db.Timestamptz
  
  // Tracking
  createdByUserId   String?                   @map("created_by_user_id") @db.Uuid
  createdAt         DateTime                  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime                  @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  views             SocialStoryView[]
  assignments       SocialStoryAssignment[]

  @@unique([tenantId, slug])
  @@index([tenantId, category, isActive])
  @@index([tenantId, isActive, readingLevel])
  @@index([category, isBuiltIn, isActive])
  @@map("social_stories")
}

/// Learner preferences for social story presentation
model LearnerStoryPreferences {
  id               String                    @id @default(uuid()) @db.Uuid
  learnerId        String                    @unique @map("learner_id") @db.Uuid
  
  // Visual preferences
  preferredVisualStyle SocialStoryVisualStyle @default(CARTOON) @map("preferred_visual_style")
  preferredReadingLevel SocialStoryReadingLevel @default(DEVELOPING) @map("preferred_reading_level")
  
  // Audio preferences
  enableAudio       Boolean                   @default(true) @map("enable_audio")
  enableTts         Boolean                   @default(true) @map("enable_tts")
  ttsVoice          String?                   @map("tts_voice")
  ttsSpeed          Float                     @default(1.0) @map("tts_speed")
  
  // Pacing preferences
  autoAdvance       Boolean                   @default(false) @map("auto_advance")
  pageDisplayTime   Int                       @default(10) @map("page_display_time") // seconds
  
  // Personalization
  characterName     String?                   @map("character_name") // Custom character name
  favoriteColor     String?                   @map("favorite_color")
  interests         String[]                  @default([])
  
  // Accessibility
  highContrast      Boolean                   @default(false) @map("high_contrast")
  largeText         Boolean                   @default(false) @map("large_text")
  reducedMotion     Boolean                   @default(false) @map("reduced_motion")
  
  // Timestamps
  createdAt         DateTime                  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime                  @updatedAt @map("updated_at") @db.Timestamptz

  @@map("learner_story_preferences")
}

/// Tracks social story views for analytics and recommendations
model SocialStoryView {
  id               String    @id @default(uuid()) @db.Uuid
  storyId          String    @map("story_id") @db.Uuid
  learnerId        String    @map("learner_id") @db.Uuid
  sessionId        String?   @map("session_id") @db.Uuid
  
  // View context
  triggerType      String    @map("trigger_type") // MANUAL, AUTO, SCHEDULED, RECOMMENDED
  triggerContext   Json      @default("{}") @map("trigger_context")
  
  // Completion tracking
  pagesViewed      Int       @default(0) @map("pages_viewed")
  totalPages       Int       @map("total_pages")
  completedAt      DateTime? @map("completed_at") @db.Timestamptz
  durationSeconds  Int?      @map("duration_seconds")
  
  // Engagement metrics
  replayCount      Int       @default(0) @map("replay_count")
  audioPlayed      Boolean   @default(false) @map("audio_played")
  interactions     Json      @default("[]") // Array of interaction events
  
  // Effectiveness tracking
  preEmotionalState  String?  @map("pre_emotional_state")
  postEmotionalState String?  @map("post_emotional_state")
  helpfulnessRating  Int?     @map("helpfulness_rating") // 1-5
  
  // Timestamps
  viewedAt         DateTime  @default(now()) @map("viewed_at") @db.Timestamptz

  // Relations
  story            SocialStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([learnerId, viewedAt(sort: Desc)])
  @@index([storyId, viewedAt(sort: Desc)])
  @@index([learnerId, storyId])
  @@map("social_story_views")
}

/// Teacher/parent assigned stories for specific learners
model SocialStoryAssignment {
  id               String    @id @default(uuid()) @db.Uuid
  storyId          String    @map("story_id") @db.Uuid
  learnerId        String    @map("learner_id") @db.Uuid
  assignedByUserId String    @map("assigned_by_user_id") @db.Uuid
  
  // Assignment configuration
  priority         Int       @default(0)
  isRequired       Boolean   @default(false) @map("is_required")
  
  // Scheduling
  showBefore       String[]  @default([]) @map("show_before") // Activity types
  showAfter        String[]  @default([]) @map("show_after")  // Activity types
  scheduledTimes   Json      @default("[]") @map("scheduled_times") // Specific times
  
  // Frequency limits
  maxDailyViews    Int?      @map("max_daily_views")
  minHoursBetween  Float?    @map("min_hours_between")
  
  // Status
  isActive         Boolean   @default(true) @map("is_active")
  expiresAt        DateTime? @map("expires_at") @db.Timestamptz
  
  // Notes
  notes            String?   @db.Text
  
  // Timestamps
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  story            SocialStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, learnerId])
  @@index([learnerId, isActive])
  @@index([learnerId, isActive, priority(sort: Desc)])
  @@map("social_story_assignments")
}
