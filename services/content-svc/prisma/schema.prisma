generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

enum LearningObjectSubject {
  ELA
  MATH
  SCIENCE
  SEL
  SPEECH
  OTHER

  @@map("learning_object_subject")
}

enum LearningObjectGradeBand {
  K_2
  G3_5
  G6_8
  G9_12

  @@map("learning_object_grade_band")
}

enum LearningObjectVersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED

  @@map("learning_object_version_state")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Logical identity of a learning content unit.
/// Examples: "ELA G3 reading passage: Dogs in Winter"
model LearningObject {
  id               String                   @id @default(uuid()) @db.Uuid
  tenantId         String?                  @map("tenant_id") @db.Uuid
  slug             String
  title            String
  subject          LearningObjectSubject
  gradeBand        LearningObjectGradeBand  @map("grade_band")
  primarySkillId   String?                  @map("primary_skill_id") @db.Uuid
  isActive         Boolean                  @default(true) @map("is_active")
  createdByUserId  String                   @map("created_by_user_id") @db.Uuid
  createdAt        DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  versions LearningObjectVersion[]
  tags     LearningObjectTag[]

  @@unique([tenantId, slug])
  @@index([tenantId, subject, gradeBand])
  @@index([primarySkillId])
  @@map("learning_objects")
}

/// Versioned content with review workflow.
/// Only one PUBLISHED version per LO at a time.
model LearningObjectVersion {
  id                 String                      @id @default(uuid()) @db.Uuid
  learningObjectId   String                      @map("learning_object_id") @db.Uuid
  versionNumber      Int                         @map("version_number")
  state              LearningObjectVersionState  @default(DRAFT)
  createdByUserId    String                      @map("created_by_user_id") @db.Uuid
  reviewedByUserId   String?                     @map("reviewed_by_user_id") @db.Uuid
  approvedByUserId   String?                     @map("approved_by_user_id") @db.Uuid
  changeSummary      String?                     @map("change_summary")
  reviewNotes        String?                     @map("review_notes")
  contentJson        Json                        @map("content_json")
  accessibilityJson  Json                        @default("{}") @map("accessibility_json")
  standardsJson      Json                        @default("{}") @map("standards_json")
  metadataJson       Json                        @default("{}") @map("metadata_json")
  createdAt          DateTime                    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                    @updatedAt @map("updated_at") @db.Timestamptz
  publishedAt        DateTime?                   @map("published_at") @db.Timestamptz
  retiredAt          DateTime?                   @map("retired_at") @db.Timestamptz

  // Relations
  learningObject LearningObject                   @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  skills         LearningObjectSkill[]
  transitions    LearningObjectVersionTransition[]

  @@unique([learningObjectId, versionNumber])
  @@index([learningObjectId, state, versionNumber(sort: Desc)])
  @@index([state])
  @@map("learning_object_versions")
}

/// Flexible tags for content discovery and filtering.
model LearningObjectTag {
  id               String   @id @default(uuid()) @db.Uuid
  learningObjectId String   @map("learning_object_id") @db.Uuid
  tag              String
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObject LearningObject @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)

  @@unique([learningObjectId, tag])
  @@index([tag])
  @@map("learning_object_tags")
}

/// Version-specific skill alignments beyond the primary skill.
model LearningObjectSkill {
  id                       String   @id @default(uuid()) @db.Uuid
  learningObjectVersionId  String   @map("learning_object_version_id") @db.Uuid
  skillId                  String   @map("skill_id") @db.Uuid
  isPrimary                Boolean  @default(false) @map("is_primary")
  weight                   Decimal? @db.Decimal(4, 3)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  learningObjectVersion LearningObjectVersion @relation(fields: [learningObjectVersionId], references: [id], onDelete: Cascade)

  @@unique([learningObjectVersionId, skillId])
  @@index([skillId])
  @@map("learning_object_skills")
}

/// Audit trail for all workflow state changes.
model LearningObjectVersionTransition {
  id                    String                      @id @default(uuid()) @db.Uuid
  versionId             String                      @map("version_id") @db.Uuid
  fromState             LearningObjectVersionState  @map("from_state")
  toState               LearningObjectVersionState  @map("to_state")
  transitionedByUserId  String                      @map("transitioned_by_user_id") @db.Uuid
  reason                String?
  transitionedAt        DateTime                    @default(now()) @map("transitioned_at") @db.Timestamptz

  // Relations
  version LearningObjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId, transitionedAt(sort: Desc)])
  @@map("learning_object_version_transitions")
}

// ══════════════════════════════════════════════════════════════════════════════
// CONTENT PACKAGING
// ══════════════════════════════════════════════════════════════════════════════

enum ContentPackageStatus {
  PENDING
  BUILDING
  READY
  EXPIRED
  FAILED

  @@map("content_package_status")
}

enum ContentLocale {
  en
  es
  fr
  zh
  ar

  @@map("content_locale")
}

/// Content package for bulk device preloading and delta updates.
model ContentPackage {
  id                 String                @id @default(uuid()) @db.Uuid
  tenantId           String                @map("tenant_id") @db.Uuid
  gradeBands         LearningObjectGradeBand[] @map("grade_bands")
  subjects           LearningObjectSubject[]   @map("subjects")
  locales            ContentLocale[]       @default([en])
  status             ContentPackageStatus  @default(PENDING)
  manifestUrl        String?               @map("manifest_url")
  bundleUrl          String?               @map("bundle_url")
  totalItems         Int                   @default(0) @map("total_items")
  totalSizeBytes     BigInt                @default(0) @map("total_size_bytes")
  requestedAt        DateTime              @default(now()) @map("requested_at") @db.Timestamptz
  completedAt        DateTime?             @map("completed_at") @db.Timestamptz
  expiresAt          DateTime?             @map("expires_at") @db.Timestamptz
  requestedByUserId  String                @map("requested_by_user_id") @db.Uuid
  errorMessage       String?               @map("error_message")
  urlExpirationHours Int                   @default(24) @map("url_expiration_hours")
  updatedSince       DateTime?             @map("updated_since") @db.Timestamptz
  createdAt          DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, status])
  @@index([tenantId, requestedAt(sort: Desc)])
  @@map("content_packages")
}

/// Track content version changes for delta updates.
model ContentVersionChange {
  id                String                   @id @default(uuid()) @db.Uuid
  loVersionId       String                   @map("lo_version_id") @db.Uuid
  learningObjectId  String                   @map("learning_object_id") @db.Uuid
  tenantId          String?                  @map("tenant_id") @db.Uuid
  subject           LearningObjectSubject
  gradeBand         LearningObjectGradeBand  @map("grade_band")
  versionNumber     Int                      @map("version_number")
  changeType        String                   @map("change_type") // ADDED, UPDATED, REMOVED
  checksum          String?
  sizeBytes         BigInt?                  @map("size_bytes")
  locale            ContentLocale            @default(en)
  changedAt         DateTime                 @default(now()) @map("changed_at") @db.Timestamptz

  @@index([tenantId, changedAt(sort: Desc)])
  @@index([tenantId, subject, gradeBand, changedAt(sort: Desc)])
  @@map("content_version_changes")
}
