generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Type of notification
enum NotificationType {
  SYSTEM           // Platform system notifications
  ACHIEVEMENT      // Learning achievements
  REMINDER         // Session/homework reminders
  GOAL_UPDATE      // Goal progress updates
  SESSION_SUMMARY  // Session completion summaries
  CONSENT_REQUEST  // Parental consent requests
  MESSAGE          // In-app message notifications
  ALERT            // Important alerts

  @@map("notification_type")
}

/// Notification delivery channel
enum DeliveryChannel {
  IN_APP          // In-app notification
  PUSH            // Mobile push (FCM/APNs)
  EMAIL           // Email delivery
  SMS             // SMS (for critical alerts)

  @@map("delivery_channel")
}

/// Delivery status
enum DeliveryStatus {
  PENDING         // Queued for delivery
  SENT            // Sent to provider
  DELIVERED       // Confirmed delivered
  FAILED          // Delivery failed
  BOUNCED         // Email/SMS bounced

  @@map("delivery_status")
}

/// Notification priority
enum NotificationPriority {
  LOW             // Can be batched/delayed
  NORMAL          // Standard delivery
  HIGH            // Prioritized delivery
  URGENT          // Immediate delivery required

  @@map("notification_priority")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// User notification preferences
model NotificationPreference {
  id                String            @id @default(uuid()) @db.Uuid
  tenantId          String            @map("tenant_id") @db.Uuid
  userId            String            @map("user_id") @db.Uuid

  // Channel preferences
  inAppEnabled      Boolean           @default(true) @map("in_app_enabled")
  pushEnabled       Boolean           @default(true) @map("push_enabled")
  emailEnabled      Boolean           @default(true) @map("email_enabled")
  smsEnabled        Boolean           @default(false) @map("sms_enabled")

  // Type preferences (JSON map of NotificationType -> enabled)
  typePreferences   Json              @default("{}") @map("type_preferences")

  // Quiet hours (time strings like "22:00")
  quietHoursStart   String?           @map("quiet_hours_start")
  quietHoursEnd     String?           @map("quiet_hours_end")
  quietHoursTimezone String?          @map("quiet_hours_timezone")

  // Digest preferences
  digestEnabled     Boolean           @default(false) @map("digest_enabled")
  digestFrequency   String?           @map("digest_frequency") // 'daily', 'weekly'
  digestTime        String?           @map("digest_time") // "09:00"

  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // TENANT ISOLATION: One preference per user per tenant
  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@map("notification_preferences")
}

/// Push notification device tokens
model DeviceToken {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  
  // Token details
  token             String    @unique
  platform          String    // 'ios', 'android', 'web'
  deviceId          String?   @map("device_id")
  appVersion        String?   @map("app_version")
  
  // Status
  isActive          Boolean   @default(true) @map("is_active")
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamptz
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, userId])
  @@index([token])
  @@map("device_tokens")
}

/// Notification record
model Notification {
  id                String               @id @default(uuid()) @db.Uuid
  tenantId          String               @map("tenant_id") @db.Uuid
  recipientId       String               @map("recipient_id") @db.Uuid
  
  // Notification content
  type              NotificationType
  title             String
  body              String
  imageUrl          String?              @map("image_url")
  actionUrl         String?              @map("action_url")
  actionData        Json?                @map("action_data")
  
  // Priority and expiry
  priority          NotificationPriority @default(NORMAL)
  expiresAt         DateTime?            @map("expires_at") @db.Timestamptz
  
  // Grouping
  groupKey          String?              @map("group_key")
  collapseKey       String?              @map("collapse_key")
  
  // Source context
  sourceType        String?              @map("source_type") // 'session', 'goal', 'message', etc.
  sourceId          String?              @map("source_id") @db.Uuid
  
  // Status
  isRead            Boolean              @default(false) @map("is_read")
  readAt            DateTime?            @map("read_at") @db.Timestamptz
  isDismissed       Boolean              @default(false) @map("is_dismissed")
  dismissedAt       DateTime?            @map("dismissed_at") @db.Timestamptz
  
  // Timestamps
  createdAt         DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  deliveries        DeliveryLog[]

  @@index([tenantId, recipientId, createdAt(sort: Desc)])
  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@index([groupKey])
  @@index([expiresAt])
  @@map("notifications")
}

/// Delivery attempt log
model DeliveryLog {
  id                String         @id @default(uuid()) @db.Uuid
  notificationId    String         @map("notification_id") @db.Uuid
  
  // Delivery details
  channel           DeliveryChannel
  status            DeliveryStatus @default(PENDING)
  
  // Provider details
  providerName      String?        @map("provider_name") // 'fcm', 'apns', 'sendgrid', 'twilio'
  providerMessageId String?        @map("provider_message_id")
  
  // Timestamps
  attemptedAt       DateTime       @default(now()) @map("attempted_at") @db.Timestamptz
  sentAt            DateTime?      @map("sent_at") @db.Timestamptz
  deliveredAt       DateTime?      @map("delivered_at") @db.Timestamptz
  
  // Error details
  errorCode         String?        @map("error_code")
  errorMessage      String?        @map("error_message")
  
  // Retry info
  retryCount        Int            @default(0) @map("retry_count")
  nextRetryAt       DateTime?      @map("next_retry_at") @db.Timestamptz

  // Relations
  notification      Notification   @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([channel, status])
  @@index([status, nextRetryAt])
  @@map("delivery_logs")
}

/// Learner notification settings (COPPA compliant, parent-controlled)
model LearnerNotificationSettings {
  id                  String    @id @default(uuid()) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  learnerId           String    @map("learner_id") @db.Uuid
  parentId            String    @map("parent_id") @db.Uuid

  // Parent-controlled notification types (only educational allowed)
  remindersEnabled    Boolean   @default(true) @map("reminders_enabled")
  achievementsEnabled Boolean   @default(true) @map("achievements_enabled")
  streakRemindersEnabled Boolean @default(true) @map("streak_reminders_enabled")
  encouragementEnabled Boolean  @default(true) @map("encouragement_enabled")

  // Delivery settings
  soundsEnabled       Boolean   @default(true) @map("sounds_enabled")
  vibrationEnabled    Boolean   @default(true) @map("vibration_enabled")

  // Quiet hours (stricter for children - recommended 8pm-8am)
  quietHoursEnabled   Boolean   @default(true) @map("quiet_hours_enabled")
  quietHoursStart     String    @default("20:00") @map("quiet_hours_start")
  quietHoursEnd       String    @default("08:00") @map("quiet_hours_end")

  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // TENANT ISOLATION: One settings per learner per tenant
  @@unique([tenantId, learnerId])
  @@index([tenantId, learnerId])
  @@index([parentId])
  @@map("learner_notification_settings")
}

/// Topic subscriptions for FCM
model TopicSubscription {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  
  topic             String    // e.g., 'user_123', 'tenant_abc', 'class_456'
  subscribedAt      DateTime  @default(now()) @map("subscribed_at") @db.Timestamptz
  
  @@unique([userId, topic])
  @@index([tenantId])
  @@index([topic])
  @@map("topic_subscriptions")
}

/// Notification template
model NotificationTemplate {
  id                String           @id @default(uuid()) @db.Uuid
  tenantId          String?          @map("tenant_id") @db.Uuid // null = global template
  
  // Template identity
  templateKey       String           @map("template_key") // e.g., 'session.completed'
  type              NotificationType
  channel           DeliveryChannel
  locale            String           @default("en")
  
  // Content templates (supports variable interpolation)
  titleTemplate     String           @map("title_template")
  bodyTemplate      String           @map("body_template")
  imageUrlTemplate  String?          @map("image_url_template")
  actionUrlTemplate String?          @map("action_url_template")
  
  // Email-specific
  emailSubject      String?          @map("email_subject")
  emailHtmlTemplate String?          @map("email_html_template")
  
  // Status
  isActive          Boolean          @default(true) @map("is_active")
  
  // Timestamps
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, templateKey, channel, locale])
  @@index([templateKey, channel])
  @@map("notification_templates")
}

/// Scheduled/queued notifications
model NotificationQueue {
  id                String               @id @default(uuid()) @db.Uuid
  tenantId          String               @map("tenant_id") @db.Uuid
  recipientId       String               @map("recipient_id") @db.Uuid
  
  // Notification content
  type              NotificationType
  priority          NotificationPriority @default(NORMAL)
  templateKey       String?              @map("template_key")
  templateData      Json?                @map("template_data")
  
  // Or direct content
  title             String?
  body              String?
  
  // Scheduling
  scheduledFor      DateTime             @map("scheduled_for") @db.Timestamptz
  channels          DeliveryChannel[]
  
  // Status
  processedAt       DateTime?            @map("processed_at") @db.Timestamptz
  notificationId    String?              @map("notification_id") @db.Uuid
  
  // Timestamps
  createdAt         DateTime             @default(now()) @map("created_at") @db.Timestamptz

  @@index([scheduledFor, processedAt])
  @@index([tenantId, recipientId])
  @@map("notification_queue")
}

// ══════════════════════════════════════════════════════════════════════════════
// PARENT NOTIFICATION ENUMS (ND-3.1)
// ══════════════════════════════════════════════════════════════════════════════

/// Categories for parent notifications
enum ParentNotificationCategory {
  EMOTIONAL_STATE    // Emotional state alerts
  ACHIEVEMENT        // Badges, levels, streaks
  SESSION_ACTIVITY   // Session start/complete
  LEARNING_PROGRESS  // Progress reports
  SAFETY_CONCERN     // Safety-related alerts
  CARE_TEAM          // Care team updates
  GOAL_UPDATE        // Goal progress
  SYSTEM             // System notifications
  REMINDER           // Reminders

  @@map("parent_notification_category")
}

/// Urgency levels for parent notifications
enum ParentNotificationUrgency {
  CRITICAL    // Immediate attention required (safety, meltdown)
  HIGH        // Important, time-sensitive
  MEDIUM      // Notable events
  LOW         // Nice to know
  INFO        // Informational only

  @@map("parent_notification_urgency")
}

/// Status for parent notification queue
enum ParentNotificationStatus {
  PENDING           // Awaiting processing
  SCHEDULED         // Scheduled for later
  QUEUED_FOR_DIGEST // Will be sent in digest
  SENDING           // Currently being sent
  SENT              // Successfully sent
  DELIVERED         // Confirmed delivered
  FAILED            // Failed to send
  CANCELLED         // Cancelled
  RATE_LIMITED      // Rate limited, queued for digest

  @@map("parent_notification_status")
}

// ══════════════════════════════════════════════════════════════════════════════
// PARENT NOTIFICATION MODELS (ND-3.1)
// ══════════════════════════════════════════════════════════════════════════════

/// Parent notification preferences per child
model ParentNotificationPreferences {
  id                      String    @id @default(uuid()) @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // === Global Settings ===
  notificationsEnabled    Boolean   @default(true) @map("notifications_enabled")
  
  // === Urgency Thresholds ===
  urgencySettings         Json      @default("{}") @map("urgency_settings")
  
  // === Category Preferences ===
  categorySettings        Json      @default("{}") @map("category_settings")
  
  // === Delivery Preferences ===
  preferredChannels       String[]  @default(["push", "email"]) @map("preferred_channels")
  
  // Push notification settings
  pushEnabled             Boolean   @default(true) @map("push_enabled")
  pushDeviceTokens        Json      @default("[]") @map("push_device_tokens")
  
  // Email settings
  emailEnabled            Boolean   @default(true) @map("email_enabled")
  emailAddress            String?   @map("email_address")
  emailFormat             String    @default("html") @map("email_format")
  
  // SMS settings
  smsEnabled              Boolean   @default(false) @map("sms_enabled")
  smsPhoneNumber          String?   @map("sms_phone_number")
  smsForCriticalOnly      Boolean   @default(true) @map("sms_for_critical_only")
  
  // In-app settings
  inAppEnabled            Boolean   @default(true) @map("in_app_enabled")
  inAppBadgeCount         Boolean   @default(true) @map("in_app_badge_count")
  
  // === Timing Preferences ===
  timezone                String    @default("America/New_York")
  
  // Quiet hours
  quietHoursEnabled       Boolean   @default(true) @map("quiet_hours_enabled")
  quietHoursStart         String    @default("21:00") @map("quiet_hours_start")
  quietHoursEnd           String    @default("07:00") @map("quiet_hours_end")
  quietHoursWeekendOnly   Boolean   @default(false) @map("quiet_hours_weekend_only")
  
  // === Digest Settings ===
  digestEnabled           Boolean   @default(true) @map("digest_enabled")
  digestFrequency         String    @default("daily") @map("digest_frequency")
  digestTime              String    @default("18:00") @map("digest_time")
  digestDayOfWeek         Int?      @default(5) @map("digest_day_of_week")
  digestIncludeDetails    Boolean   @default(true) @map("digest_include_details")
  
  // === Rate Limiting ===
  maxNotificationsPerHour Int       @default(5) @map("max_notifications_per_hour")
  maxNotificationsPerDay  Int       @default(20) @map("max_notifications_per_day")
  cooldownMinutes         Int       @default(15) @map("cooldown_minutes")
  
  // === Language & Format ===
  language                String    @default("en")
  useSimpleLanguage       Boolean   @default(false) @map("use_simple_language")
  includeActionItems      Boolean   @default(true) @map("include_action_items")
  includeResources        Boolean   @default(true) @map("include_resources")
  
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // TENANT ISOLATION: One preferences per parent-learner pair per tenant
  @@unique([tenantId, parentId, learnerId])
  @@index([tenantId])
  @@map("parent_notification_preferences")
}

/// Parent notification queue
model ParentNotificationQueue {
  id                      String                     @id @default(uuid()) @db.Uuid
  parentId                String                     @map("parent_id") @db.Uuid
  learnerId               String                     @map("learner_id") @db.Uuid
  tenantId                String                     @map("tenant_id") @db.Uuid
  
  // Notification content
  category                ParentNotificationCategory
  urgency                 ParentNotificationUrgency
  title                   String
  body                    String
  richContent             Json?                      @map("rich_content")
  actionUrl               String?                    @map("action_url")
  
  // Metadata
  sourceEvent             String                     @map("source_event")
  sourceEventId           String?                    @map("source_event_id") @db.Uuid
  relatedSessionId        String?                    @map("related_session_id") @db.Uuid
  
  // Status
  status                  ParentNotificationStatus   @default(PENDING)
  
  // Scheduling
  scheduledFor            DateTime?                  @map("scheduled_for") @db.Timestamptz
  digestEligible          Boolean                    @default(true) @map("digest_eligible")
  addedToDigest           Boolean                    @default(false) @map("added_to_digest")
  
  // Delivery tracking
  channels                String[]                   @default([])
  deliveredVia            String[]                   @default([]) @map("delivered_via")
  deliveredAt             DateTime?                  @map("delivered_at") @db.Timestamptz
  readAt                  DateTime?                  @map("read_at") @db.Timestamptz
  
  // Rate limiting
  similarNotificationKey  String?                    @map("similar_notification_key")
  
  createdAt               DateTime                   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime                   @updatedAt @map("updated_at") @db.Timestamptz

  @@index([parentId, status])
  @@index([scheduledFor])
  @@index([category, urgency])
  @@map("parent_notification_queue")
}

/// Notification digest for parents
model ParentNotificationDigest {
  id                      String    @id @default(uuid()) @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // Digest period
  periodStart             DateTime  @map("period_start") @db.Timestamptz
  periodEnd               DateTime  @map("period_end") @db.Timestamptz
  digestType              String    @map("digest_type")
  
  // Content
  notifications           Json      @default("[]")
  summary                 Json      @default("{}")
  
  // Delivery
  status                  String    @default("pending")
  sentAt                  DateTime? @map("sent_at") @db.Timestamptz
  sentVia                 String[]  @default([]) @map("sent_via")
  
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([parentId, periodStart])
  @@index([status])
  @@map("parent_notification_digests")
}

/// Parent notification delivery log
model ParentNotificationLog {
  id                      String    @id @default(uuid()) @db.Uuid
  notificationId          String?   @map("notification_id") @db.Uuid
  digestId                String?   @map("digest_id") @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // Delivery details
  channel                 String
  status                  String
  
  // Tracking
  sentAt                  DateTime  @map("sent_at") @db.Timestamptz
  deliveredAt             DateTime? @map("delivered_at") @db.Timestamptz
  openedAt                DateTime? @map("opened_at") @db.Timestamptz
  clickedAt               DateTime? @map("clicked_at") @db.Timestamptz
  
  // Error tracking
  errorMessage            String?   @map("error_message")
  retryCount              Int       @default(0) @map("retry_count")
  
  // Metadata
  metadata                Json?

  @@index([parentId])
  @@index([channel, status])
  @@map("parent_notification_logs")
}

// ══════════════════════════════════════════════════════════════════════════════
// EMAIL ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Email delivery status
enum EmailStatus {
  PENDING           // Queued for delivery
  SENT              // Sent to provider
  DELIVERED         // Confirmed delivered
  OPENED            // Email opened
  CLICKED           // Link clicked
  BOUNCED           // Hard or soft bounce
  DROPPED           // Dropped by provider
  FAILED            // Send failed
  COMPLAINED        // Marked as spam
  UNSUBSCRIBED      // User unsubscribed

  @@map("email_status")
}

/// Email provider
enum EmailProvider {
  SENDGRID          // SendGrid
  SES               // AWS SES

  @@map("email_provider")
}

/// Suppression reason
enum SuppressionReason {
  HARD_BOUNCE       // Permanent delivery failure
  SOFT_BOUNCE       // Temporary delivery failure (repeated)
  SPAM_COMPLAINT    // Marked as spam
  UNSUBSCRIBED      // User unsubscribed
  INVALID_EMAIL     // Invalid email format/domain
  MANUAL            // Manually added

  @@map("suppression_reason")
}

/// Email category
enum EmailCategory {
  TRANSACTIONAL     // Critical emails (password reset, verification)
  NOTIFICATION      // Notifications (session summaries, progress)
  MARKETING         // Marketing/promotional
  BILLING           // Payment/billing related
  ADMIN             // Admin/system emails

  @@map("email_category")
}

// ══════════════════════════════════════════════════════════════════════════════
// EMAIL MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// Email delivery log
model EmailLog {
  id                String         @id @default(uuid()) @db.Uuid
  tenantId          String?        @map("tenant_id") @db.Uuid
  
  // Recipient
  toEmail           String         @map("to_email")
  toUserId          String?        @map("to_user_id") @db.Uuid
  
  // Email content
  subject           String
  templateName      String?        @map("template_name")
  category          EmailCategory  @default(NOTIFICATION)
  
  // Delivery details
  provider          EmailProvider
  messageId         String?        @map("message_id")
  status            EmailStatus    @default(PENDING)
  
  // Tracking
  sentAt            DateTime?      @map("sent_at") @db.Timestamptz
  deliveredAt       DateTime?      @map("delivered_at") @db.Timestamptz
  openedAt          DateTime?      @map("opened_at") @db.Timestamptz
  clickedAt         DateTime?      @map("clicked_at") @db.Timestamptz
  bouncedAt         DateTime?      @map("bounced_at") @db.Timestamptz
  
  // Error tracking
  errorCode         String?        @map("error_code")
  errorMessage      String?        @map("error_message")
  
  // Metadata
  tags              String[]       @default([])
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([toEmail, createdAt(sort: Desc)])
  @@index([toUserId])
  @@index([messageId])
  @@index([status])
  @@index([templateName, createdAt(sort: Desc)])
  @@map("email_logs")
}

/// Email suppression list
model EmailSuppression {
  id                String            @id @default(uuid()) @db.Uuid
  
  // Email (globally suppressed)
  email             String            @unique
  
  // Suppression details
  reason            SuppressionReason
  source            String            // 'sendgrid_webhook', 'ses_webhook', 'manual', etc.
  
  // Original event details
  originalMessageId String?           @map("original_message_id")
  bounceType        String?           @map("bounce_type")
  bounceSubType     String?           @map("bounce_sub_type")
  diagnosticCode    String?           @map("diagnostic_code")
  
  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime?         @updatedAt @map("updated_at") @db.Timestamptz
  expiresAt         DateTime?         @map("expires_at") @db.Timestamptz

  @@index([reason])
  @@index([source])
  @@index([expiresAt])
  @@map("email_suppressions")
}

/// Email preferences (per-user email settings)
model EmailPreference {
  id                String         @id @default(uuid()) @db.Uuid
  tenantId          String         @map("tenant_id") @db.Uuid
  userId            String         @map("user_id") @db.Uuid

  // Global email toggle
  emailEnabled      Boolean        @default(true) @map("email_enabled")

  // Category preferences
  transactionalEnabled Boolean     @default(true) @map("transactional_enabled") // Cannot really disable
  notificationEnabled  Boolean     @default(true) @map("notification_enabled")
  marketingEnabled     Boolean     @default(false) @map("marketing_enabled")
  billingEnabled       Boolean     @default(true) @map("billing_enabled")

  // Digest settings
  digestEnabled     Boolean        @default(false) @map("digest_enabled")
  digestFrequency   String?        @map("digest_frequency") // 'daily', 'weekly'
  digestDayOfWeek   Int?           @map("digest_day_of_week") // 0-6 (Sunday-Saturday)
  digestTime        String?        @map("digest_time") // "09:00"
  digestTimezone    String?        @map("digest_timezone")

  // Preferred locale
  preferredLocale   String         @default("en") @map("preferred_locale")

  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // TENANT ISOLATION: One email preference per user per tenant
  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@map("email_preferences")
}

/// Email template (stored templates for customization)
model EmailTemplate {
  id                String         @id @default(uuid()) @db.Uuid
  tenantId          String?        @map("tenant_id") @db.Uuid // null = global template
  
  // Template identity
  name              String         // e.g., 'transactional/welcome'
  locale            String         @default("en")
  category          EmailCategory
  
  // Content
  subject           String
  htmlContent       String         @map("html_content") @db.Text
  textContent       String?        @map("text_content") @db.Text
  
  // Metadata
  description       String?
  variables         String[]       @default([]) // List of expected variables
  
  // Provider templates (if using provider-hosted templates)
  sendgridTemplateId String?       @map("sendgrid_template_id")
  sesTemplateArn    String?        @map("ses_template_arn")
  
  // Status
  isActive          Boolean        @default(true) @map("is_active")
  version           Int            @default(1)
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, name, locale])
  @@index([name, locale])
  @@index([category])
  @@map("email_templates")
}

/// Email webhook events (raw event log)
model EmailWebhookEvent {
  id                String         @id @default(uuid()) @db.Uuid
  
  // Provider info
  provider          EmailProvider
  eventId           String?        @map("event_id") // Provider's event ID
  
  // Event details
  eventType         String         @map("event_type")
  email             String
  messageId         String?        @map("message_id")
  timestamp         DateTime       @db.Timestamptz
  
  // Raw payload
  rawPayload        Json           @map("raw_payload")
  
  // Processing status
  processedAt       DateTime?      @map("processed_at") @db.Timestamptz
  processingError   String?        @map("processing_error")
  
  // Created
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz

  @@index([provider, createdAt(sort: Desc)])
  @@index([email])
  @@index([messageId])
  @@index([eventType])
  @@map("email_webhook_events")
}

// ══════════════════════════════════════════════════════════════════════════════
// SMS ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// SMS message type
enum SmsType {
  OTP               // One-time password / 2FA
  TRANSACTIONAL     // Critical transactional (password reset, security alerts)
  REMINDER          // Session/class reminders
  ALERT             // Parent alerts, attendance
  MARKETING         // Marketing (requires explicit consent)
  INBOUND           // Inbound message from user

  @@map("sms_type")
}

/// SMS delivery status
enum SmsStatus {
  QUEUED            // Queued at provider
  SENDING           // Being sent
  SENT              // Sent to carrier
  DELIVERED         // Confirmed delivered
  UNDELIVERED       // Delivery failed (carrier issue)
  FAILED            // Send failed (provider issue)
  RECEIVED          // Inbound message received
  READ              // Message read (if supported)
  CANCELLED         // Message cancelled before send

  @@map("sms_status")
}

/// SMS consent type
enum SmsConsentType {
  OPT_IN            // User opted in
  OPT_OUT           // User opted out
  IMPLICIT          // Implied consent (transactional relationship)
  EXPLICIT          // Explicit written/digital consent
  DOUBLE_OPT_IN     // Confirmed opt-in (2-step verification)

  @@map("sms_consent_type")
}

/// SMS consent method
enum SmsConsentMethod {
  WEB_FORM          // Opted in via web form
  MOBILE_APP        // Opted in via mobile app
  SMS_KEYWORD       // Opted in via SMS keyword (START)
  PAPER_FORM        // Physical form (keep record reference)
  API               // Opted in via API call
  IMPORTED          // Imported from external system

  @@map("sms_consent_method")
}

// ══════════════════════════════════════════════════════════════════════════════
// SMS MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// SMS delivery log
model SmsLog {
  id                String         @id @default(uuid()) @db.Uuid
  tenantId          String         @map("tenant_id") @db.Uuid
  
  // User (optional - OTP may not have user context)
  userId            String?        @map("user_id") @db.Uuid
  
  // Phone numbers
  toPhone           String         @map("to_phone")
  fromPhone         String         @map("from_phone")
  
  // Message content
  body              String         @db.Text
  type              SmsType
  
  // Message details
  segments          Int            @default(1)
  encoding          String?        // 'GSM-7', 'UCS-2'
  
  // Delivery details
  provider          String         // 'twilio'
  messageId         String?        @map("message_id")
  messagingServiceSid String?      @map("messaging_service_sid")
  status            SmsStatus      @default(QUEUED)
  
  // Timestamps
  sentAt            DateTime?      @map("sent_at") @db.Timestamptz
  deliveredAt       DateTime?      @map("delivered_at") @db.Timestamptz
  failedAt          DateTime?      @map("failed_at") @db.Timestamptz
  
  // Error tracking
  errorCode         String?        @map("error_code")
  errorMessage      String?        @map("error_message")
  
  // Cost tracking
  price             Decimal?       @db.Decimal(10, 6)
  priceCurrency     String?        @map("price_currency") @default("USD")
  
  // Metadata
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([toPhone, createdAt(sort: Desc)])
  @@index([userId])
  @@index([messageId])
  @@index([status])
  @@index([type])
  @@map("sms_logs")
}

/// SMS consent records (TCPA compliance)
model SmsConsent {
  id                String           @id @default(uuid()) @db.Uuid
  
  // Phone number (E.164 format)
  phoneNumber       String           @map("phone_number")
  
  // Associated user/tenant
  userId            String?          @map("user_id") @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  
  // Consent details
  consentType       SmsConsentType   @map("consent_type")
  consentMethod     SmsConsentMethod @map("consent_method")
  
  // What they consented to receive
  smsTypes          SmsType[]        @map("sms_types")
  
  // Consent metadata
  consentedAt       DateTime         @map("consented_at") @db.Timestamptz
  expiresAt         DateTime?        @map("expires_at") @db.Timestamptz
  revokedAt         DateTime?        @map("revoked_at") @db.Timestamptz
  revokedMethod     String?          @map("revoked_method")
  
  // Audit trail
  ipAddress         String?          @map("ip_address")
  userAgent         String?          @map("user_agent")
  consentText       String?          @map("consent_text") @db.Text // The actual consent language shown
  documentRef       String?          @map("document_ref") // Reference to paper form if applicable
  
  // Status
  isActive          Boolean          @default(true) @map("is_active")
  
  // Timestamps
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([phoneNumber, tenantId])
  @@index([phoneNumber])
  @@index([tenantId, phoneNumber])
  @@index([userId])
  @@index([isActive, expiresAt])
  @@map("sms_consents")
}

/// SMS webhook events (raw event log)
model SmsWebhookEvent {
  id                String         @id @default(uuid()) @db.Uuid
  
  // Provider info
  provider          String         // 'twilio'
  eventId           String?        @map("event_id")
  
  // Event details
  eventType         String         @map("event_type") // 'status_callback', 'inbound'
  phoneNumber       String         @map("phone_number")
  messageId         String?        @map("message_id")
  timestamp         DateTime       @db.Timestamptz
  
  // Raw payload
  rawPayload        Json           @map("raw_payload")
  
  // Processing status
  processedAt       DateTime?      @map("processed_at") @db.Timestamptz
  processingError   String?        @map("processing_error")
  
  // Created
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz

  @@index([provider, createdAt(sort: Desc)])
  @@index([phoneNumber])
  @@index([messageId])
  @@index([eventType])
  @@map("sms_webhook_events")
}

/// SMS phone number validation cache
model SmsPhoneCache {
  id                String         @id @default(uuid()) @db.Uuid
  
  // Phone number (E.164 format)
  phoneNumber       String         @unique @map("phone_number")
  
  // Validation results
  isValid           Boolean        @map("is_valid")
  phoneType         String?        @map("phone_type") // 'mobile', 'landline', 'voip', etc.
  carrier           String?
  countryCode       String?        @map("country_code")
  nationalFormat    String?        @map("national_format")
  
  // Carrier lookup
  carrierName       String?        @map("carrier_name")
  carrierType       String?        @map("carrier_type")
  mobileCountryCode String?        @map("mobile_country_code")
  mobileNetworkCode String?        @map("mobile_network_code")
  
  // Error info
  errorCode         String?        @map("error_code")
  
  // Cache control
  lastLookupAt      DateTime       @map("last_lookup_at") @db.Timestamptz
  expiresAt         DateTime       @map("expires_at") @db.Timestamptz
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  @@index([isValid])
  @@index([expiresAt])
  @@map("sms_phone_cache")
}

/// SMS global opt-out list (STOP across all tenants)
model SmsGlobalOptOut {
  id                String         @id @default(uuid()) @db.Uuid
  
  // Phone number (E.164 format)
  phoneNumber       String         @unique @map("phone_number")
  
  // Opt-out details
  optOutAt          DateTime       @map("opt_out_at") @db.Timestamptz
  optOutMethod      String         @map("opt_out_method") // 'sms_keyword', 'api', 'manual'
  
  // Last message that triggered opt-out
  lastMessageId     String?        @map("last_message_id")
  lastTenantId      String?        @map("last_tenant_id") @db.Uuid
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz

  @@map("sms_global_opt_outs")
}
