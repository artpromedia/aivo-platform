generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ══════════════════════════════════════════════════════════════════════════════

/// Type of notification
enum NotificationType {
  SYSTEM           // Platform system notifications
  ACHIEVEMENT      // Learning achievements
  REMINDER         // Session/homework reminders
  GOAL_UPDATE      // Goal progress updates
  SESSION_SUMMARY  // Session completion summaries
  CONSENT_REQUEST  // Parental consent requests
  MESSAGE          // In-app message notifications
  ALERT            // Important alerts

  @@map("notification_type")
}

/// Notification delivery channel
enum DeliveryChannel {
  IN_APP          // In-app notification
  PUSH            // Mobile push (FCM/APNs)
  EMAIL           // Email delivery
  SMS             // SMS (for critical alerts)

  @@map("delivery_channel")
}

/// Delivery status
enum DeliveryStatus {
  PENDING         // Queued for delivery
  SENT            // Sent to provider
  DELIVERED       // Confirmed delivered
  FAILED          // Delivery failed
  BOUNCED         // Email/SMS bounced

  @@map("delivery_status")
}

/// Notification priority
enum NotificationPriority {
  LOW             // Can be batched/delayed
  NORMAL          // Standard delivery
  HIGH            // Prioritized delivery
  URGENT          // Immediate delivery required

  @@map("notification_priority")
}

// ══════════════════════════════════════════════════════════════════════════════
// MODELS
// ══════════════════════════════════════════════════════════════════════════════

/// User notification preferences
model NotificationPreference {
  id                String            @id @default(uuid()) @db.Uuid
  tenantId          String            @map("tenant_id") @db.Uuid
  userId            String            @unique @map("user_id") @db.Uuid
  
  // Channel preferences
  inAppEnabled      Boolean           @default(true) @map("in_app_enabled")
  pushEnabled       Boolean           @default(true) @map("push_enabled")
  emailEnabled      Boolean           @default(true) @map("email_enabled")
  smsEnabled        Boolean           @default(false) @map("sms_enabled")
  
  // Type preferences (JSON map of NotificationType -> enabled)
  typePreferences   Json              @default("{}") @map("type_preferences")
  
  // Quiet hours (time strings like "22:00")
  quietHoursStart   String?           @map("quiet_hours_start")
  quietHoursEnd     String?           @map("quiet_hours_end")
  quietHoursTimezone String?          @map("quiet_hours_timezone")
  
  // Digest preferences
  digestEnabled     Boolean           @default(false) @map("digest_enabled")
  digestFrequency   String?           @map("digest_frequency") // 'daily', 'weekly'
  digestTime        String?           @map("digest_time") // "09:00"
  
  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, userId])
  @@map("notification_preferences")
}

/// Push notification device tokens
model DeviceToken {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  
  // Token details
  token             String    @unique
  platform          String    // 'ios', 'android', 'web'
  deviceId          String?   @map("device_id")
  appVersion        String?   @map("app_version")
  
  // Status
  isActive          Boolean   @default(true) @map("is_active")
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamptz
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId, userId])
  @@index([token])
  @@map("device_tokens")
}

/// Notification record
model Notification {
  id                String               @id @default(uuid()) @db.Uuid
  tenantId          String               @map("tenant_id") @db.Uuid
  recipientId       String               @map("recipient_id") @db.Uuid
  
  // Notification content
  type              NotificationType
  title             String
  body              String
  imageUrl          String?              @map("image_url")
  actionUrl         String?              @map("action_url")
  actionData        Json?                @map("action_data")
  
  // Priority and expiry
  priority          NotificationPriority @default(NORMAL)
  expiresAt         DateTime?            @map("expires_at") @db.Timestamptz
  
  // Grouping
  groupKey          String?              @map("group_key")
  collapseKey       String?              @map("collapse_key")
  
  // Source context
  sourceType        String?              @map("source_type") // 'session', 'goal', 'message', etc.
  sourceId          String?              @map("source_id") @db.Uuid
  
  // Status
  isRead            Boolean              @default(false) @map("is_read")
  readAt            DateTime?            @map("read_at") @db.Timestamptz
  isDismissed       Boolean              @default(false) @map("is_dismissed")
  dismissedAt       DateTime?            @map("dismissed_at") @db.Timestamptz
  
  // Timestamps
  createdAt         DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  deliveries        DeliveryLog[]

  @@index([tenantId, recipientId, createdAt(sort: Desc)])
  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@index([groupKey])
  @@index([expiresAt])
  @@map("notifications")
}

/// Delivery attempt log
model DeliveryLog {
  id                String         @id @default(uuid()) @db.Uuid
  notificationId    String         @map("notification_id") @db.Uuid
  
  // Delivery details
  channel           DeliveryChannel
  status            DeliveryStatus @default(PENDING)
  
  // Provider details
  providerName      String?        @map("provider_name") // 'fcm', 'apns', 'sendgrid', 'twilio'
  providerMessageId String?        @map("provider_message_id")
  
  // Timestamps
  attemptedAt       DateTime       @default(now()) @map("attempted_at") @db.Timestamptz
  sentAt            DateTime?      @map("sent_at") @db.Timestamptz
  deliveredAt       DateTime?      @map("delivered_at") @db.Timestamptz
  
  // Error details
  errorCode         String?        @map("error_code")
  errorMessage      String?        @map("error_message")
  
  // Retry info
  retryCount        Int            @default(0) @map("retry_count")
  nextRetryAt       DateTime?      @map("next_retry_at") @db.Timestamptz

  // Relations
  notification      Notification   @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([channel, status])
  @@index([status, nextRetryAt])
  @@map("delivery_logs")
}

/// Notification template
model NotificationTemplate {
  id                String           @id @default(uuid()) @db.Uuid
  tenantId          String?          @map("tenant_id") @db.Uuid // null = global template
  
  // Template identity
  templateKey       String           @map("template_key") // e.g., 'session.completed'
  type              NotificationType
  channel           DeliveryChannel
  locale            String           @default("en")
  
  // Content templates (supports variable interpolation)
  titleTemplate     String           @map("title_template")
  bodyTemplate      String           @map("body_template")
  imageUrlTemplate  String?          @map("image_url_template")
  actionUrlTemplate String?          @map("action_url_template")
  
  // Email-specific
  emailSubject      String?          @map("email_subject")
  emailHtmlTemplate String?          @map("email_html_template")
  
  // Status
  isActive          Boolean          @default(true) @map("is_active")
  
  // Timestamps
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([tenantId, templateKey, channel, locale])
  @@index([templateKey, channel])
  @@map("notification_templates")
}

/// Scheduled/queued notifications
model NotificationQueue {
  id                String               @id @default(uuid()) @db.Uuid
  tenantId          String               @map("tenant_id") @db.Uuid
  recipientId       String               @map("recipient_id") @db.Uuid
  
  // Notification content
  type              NotificationType
  priority          NotificationPriority @default(NORMAL)
  templateKey       String?              @map("template_key")
  templateData      Json?                @map("template_data")
  
  // Or direct content
  title             String?
  body              String?
  
  // Scheduling
  scheduledFor      DateTime             @map("scheduled_for") @db.Timestamptz
  channels          DeliveryChannel[]
  
  // Status
  processedAt       DateTime?            @map("processed_at") @db.Timestamptz
  notificationId    String?              @map("notification_id") @db.Uuid
  
  // Timestamps
  createdAt         DateTime             @default(now()) @map("created_at") @db.Timestamptz

  @@index([scheduledFor, processedAt])
  @@index([tenantId, recipientId])
  @@map("notification_queue")
}

// ══════════════════════════════════════════════════════════════════════════════
// PARENT NOTIFICATION ENUMS (ND-3.1)
// ══════════════════════════════════════════════════════════════════════════════

/// Categories for parent notifications
enum ParentNotificationCategory {
  EMOTIONAL_STATE    // Emotional state alerts
  ACHIEVEMENT        // Badges, levels, streaks
  SESSION_ACTIVITY   // Session start/complete
  LEARNING_PROGRESS  // Progress reports
  SAFETY_CONCERN     // Safety-related alerts
  CARE_TEAM          // Care team updates
  GOAL_UPDATE        // Goal progress
  SYSTEM             // System notifications
  REMINDER           // Reminders

  @@map("parent_notification_category")
}

/// Urgency levels for parent notifications
enum ParentNotificationUrgency {
  CRITICAL    // Immediate attention required (safety, meltdown)
  HIGH        // Important, time-sensitive
  MEDIUM      // Notable events
  LOW         // Nice to know
  INFO        // Informational only

  @@map("parent_notification_urgency")
}

/// Status for parent notification queue
enum ParentNotificationStatus {
  PENDING           // Awaiting processing
  SCHEDULED         // Scheduled for later
  QUEUED_FOR_DIGEST // Will be sent in digest
  SENDING           // Currently being sent
  SENT              // Successfully sent
  DELIVERED         // Confirmed delivered
  FAILED            // Failed to send
  CANCELLED         // Cancelled
  RATE_LIMITED      // Rate limited, queued for digest

  @@map("parent_notification_status")
}

// ══════════════════════════════════════════════════════════════════════════════
// PARENT NOTIFICATION MODELS (ND-3.1)
// ══════════════════════════════════════════════════════════════════════════════

/// Parent notification preferences per child
model ParentNotificationPreferences {
  id                      String    @id @default(uuid()) @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // === Global Settings ===
  notificationsEnabled    Boolean   @default(true) @map("notifications_enabled")
  
  // === Urgency Thresholds ===
  urgencySettings         Json      @default("{}") @map("urgency_settings")
  
  // === Category Preferences ===
  categorySettings        Json      @default("{}") @map("category_settings")
  
  // === Delivery Preferences ===
  preferredChannels       String[]  @default(["push", "email"]) @map("preferred_channels")
  
  // Push notification settings
  pushEnabled             Boolean   @default(true) @map("push_enabled")
  pushDeviceTokens        Json      @default("[]") @map("push_device_tokens")
  
  // Email settings
  emailEnabled            Boolean   @default(true) @map("email_enabled")
  emailAddress            String?   @map("email_address")
  emailFormat             String    @default("html") @map("email_format")
  
  // SMS settings
  smsEnabled              Boolean   @default(false) @map("sms_enabled")
  smsPhoneNumber          String?   @map("sms_phone_number")
  smsForCriticalOnly      Boolean   @default(true) @map("sms_for_critical_only")
  
  // In-app settings
  inAppEnabled            Boolean   @default(true) @map("in_app_enabled")
  inAppBadgeCount         Boolean   @default(true) @map("in_app_badge_count")
  
  // === Timing Preferences ===
  timezone                String    @default("America/New_York")
  
  // Quiet hours
  quietHoursEnabled       Boolean   @default(true) @map("quiet_hours_enabled")
  quietHoursStart         String    @default("21:00") @map("quiet_hours_start")
  quietHoursEnd           String    @default("07:00") @map("quiet_hours_end")
  quietHoursWeekendOnly   Boolean   @default(false) @map("quiet_hours_weekend_only")
  
  // === Digest Settings ===
  digestEnabled           Boolean   @default(true) @map("digest_enabled")
  digestFrequency         String    @default("daily") @map("digest_frequency")
  digestTime              String    @default("18:00") @map("digest_time")
  digestDayOfWeek         Int?      @default(5) @map("digest_day_of_week")
  digestIncludeDetails    Boolean   @default(true) @map("digest_include_details")
  
  // === Rate Limiting ===
  maxNotificationsPerHour Int       @default(5) @map("max_notifications_per_hour")
  maxNotificationsPerDay  Int       @default(20) @map("max_notifications_per_day")
  cooldownMinutes         Int       @default(15) @map("cooldown_minutes")
  
  // === Language & Format ===
  language                String    @default("en")
  useSimpleLanguage       Boolean   @default(false) @map("use_simple_language")
  includeActionItems      Boolean   @default(true) @map("include_action_items")
  includeResources        Boolean   @default(true) @map("include_resources")
  
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([parentId, learnerId])
  @@index([tenantId])
  @@map("parent_notification_preferences")
}

/// Parent notification queue
model ParentNotificationQueue {
  id                      String                     @id @default(uuid()) @db.Uuid
  parentId                String                     @map("parent_id") @db.Uuid
  learnerId               String                     @map("learner_id") @db.Uuid
  tenantId                String                     @map("tenant_id") @db.Uuid
  
  // Notification content
  category                ParentNotificationCategory
  urgency                 ParentNotificationUrgency
  title                   String
  body                    String
  richContent             Json?                      @map("rich_content")
  actionUrl               String?                    @map("action_url")
  
  // Metadata
  sourceEvent             String                     @map("source_event")
  sourceEventId           String?                    @map("source_event_id") @db.Uuid
  relatedSessionId        String?                    @map("related_session_id") @db.Uuid
  
  // Status
  status                  ParentNotificationStatus   @default(PENDING)
  
  // Scheduling
  scheduledFor            DateTime?                  @map("scheduled_for") @db.Timestamptz
  digestEligible          Boolean                    @default(true) @map("digest_eligible")
  addedToDigest           Boolean                    @default(false) @map("added_to_digest")
  
  // Delivery tracking
  channels                String[]                   @default([])
  deliveredVia            String[]                   @default([]) @map("delivered_via")
  deliveredAt             DateTime?                  @map("delivered_at") @db.Timestamptz
  readAt                  DateTime?                  @map("read_at") @db.Timestamptz
  
  // Rate limiting
  similarNotificationKey  String?                    @map("similar_notification_key")
  
  createdAt               DateTime                   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime                   @updatedAt @map("updated_at") @db.Timestamptz

  @@index([parentId, status])
  @@index([scheduledFor])
  @@index([category, urgency])
  @@map("parent_notification_queue")
}

/// Notification digest for parents
model ParentNotificationDigest {
  id                      String    @id @default(uuid()) @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // Digest period
  periodStart             DateTime  @map("period_start") @db.Timestamptz
  periodEnd               DateTime  @map("period_end") @db.Timestamptz
  digestType              String    @map("digest_type")
  
  // Content
  notifications           Json      @default("[]")
  summary                 Json      @default("{}")
  
  // Delivery
  status                  String    @default("pending")
  sentAt                  DateTime? @map("sent_at") @db.Timestamptz
  sentVia                 String[]  @default([]) @map("sent_via")
  
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([parentId, periodStart])
  @@index([status])
  @@map("parent_notification_digests")
}

/// Parent notification delivery log
model ParentNotificationLog {
  id                      String    @id @default(uuid()) @db.Uuid
  notificationId          String?   @map("notification_id") @db.Uuid
  digestId                String?   @map("digest_id") @db.Uuid
  parentId                String    @map("parent_id") @db.Uuid
  learnerId               String    @map("learner_id") @db.Uuid
  tenantId                String    @map("tenant_id") @db.Uuid
  
  // Delivery details
  channel                 String
  status                  String
  
  // Tracking
  sentAt                  DateTime  @map("sent_at") @db.Timestamptz
  deliveredAt             DateTime? @map("delivered_at") @db.Timestamptz
  openedAt                DateTime? @map("opened_at") @db.Timestamptz
  clickedAt               DateTime? @map("clicked_at") @db.Timestamptz
  
  // Error tracking
  errorMessage            String?   @map("error_message")
  retryCount              Int       @default(0) @map("retry_count")
  
  // Metadata
  metadata                Json?

  @@index([parentId])
  @@index([channel, status])
  @@map("parent_notification_logs")
}
