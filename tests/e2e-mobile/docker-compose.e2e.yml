# AIVO E2E Test Backend Services
# Docker Compose for running backend services during E2E tests

services:
  # PostgreSQL for test data
  postgres-test:
    image: postgres:15-alpine
    container_name: aivo-postgres-test
    environment:
      POSTGRES_USER: aivo_test
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: aivo_test
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aivo_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Redis for caching and sessions
  redis-test:
    image: redis:7-alpine
    container_name: aivo-redis-test
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # NATS for messaging
  nats-test:
    image: nats:2.10-alpine
    container_name: aivo-nats-test
    ports:
      - "4223:4222"
      - "8223:8222"
    command: ["--jetstream", "--store_dir=/data"]
    volumes:
      - nats_test_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Mock API Gateway
  mock-api:
    build:
      context: ./mock-server
      dockerfile: Dockerfile
    container_name: aivo-mock-api
    environment:
      PORT: 3000
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      REDIS_URL: redis://redis-test:6379
    ports:
      - "3001:3000"
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Auth Service (test mode)
  auth-svc-test:
    build:
      context: ../services/auth-svc
      target: test
    container_name: aivo-auth-test
    environment:
      PORT: 4000
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      REDIS_URL: redis://redis-test:6379
      JWT_SECRET: test-jwt-secret-e2e-only
      JWT_EXPIRY: 1h
      NATS_URL: nats://nats-test:4222
    ports:
      - "4001:4000"
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      nats-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Profile Service (test mode)
  profile-svc-test:
    build:
      context: ../services/profile-svc
      target: test
    container_name: aivo-profile-test
    environment:
      PORT: 4100
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      NATS_URL: nats://nats-test:4222
      AUTH_SERVICE_URL: http://auth-svc-test:4000
    ports:
      - "4101:4100"
    depends_on:
      postgres-test:
        condition: service_healthy
      auth-svc-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4100/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Session Service (test mode)
  session-svc-test:
    build:
      context: ../services/session-svc
      target: test
    container_name: aivo-session-test
    environment:
      PORT: 4200
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      REDIS_URL: redis://redis-test:6379
      NATS_URL: nats://nats-test:4222
    ports:
      - "4201:4200"
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4200/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Content Service (test mode)
  content-svc-test:
    build:
      context: ../services/content-svc
      target: test
    container_name: aivo-content-test
    environment:
      PORT: 4300
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      NATS_URL: nats://nats-test:4222
      STORAGE_TYPE: local
      STORAGE_PATH: /tmp/test-storage
    ports:
      - "4301:4300"
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4300/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Notification Service (test mode)
  notify-svc-test:
    build:
      context: ../services/notify-svc
      target: test
    container_name: aivo-notify-test
    environment:
      PORT: 4400
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      REDIS_URL: redis://redis-test:6379
      NATS_URL: nats://nats-test:4222
      PUSH_MOCK_MODE: "true"
    ports:
      - "4401:4400"
    depends_on:
      postgres-test:
        condition: service_healthy
      nats-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4400/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Billing Service (test mode)
  billing-svc-test:
    build:
      context: ../services/billing-svc
      target: test
    container_name: aivo-billing-test
    environment:
      PORT: 4500
      NODE_ENV: test
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      NATS_URL: nats://nats-test:4222
      STRIPE_API_KEY: sk_test_mock
      STRIPE_MOCK_MODE: "true"
    ports:
      - "4501:4500"
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4500/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aivo-test-network

  # Database migration runner
  db-migrate:
    build:
      context: ../services/auth-svc
      target: test
    container_name: aivo-db-migrate
    command: ["npm", "run", "db:migrate"]
    environment:
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - aivo-test-network
    profiles:
      - setup

  # Test data seeder
  db-seed:
    build:
      context: ../tests/e2e-mobile/mock-server
    container_name: aivo-db-seed
    command: ["npm", "run", "seed:e2e"]
    environment:
      DATABASE_URL: postgresql://aivo_test:test_password@postgres-test:5432/aivo_test
      REDIS_URL: redis://redis-test:6379
    depends_on:
      postgres-test:
        condition: service_healthy
      db-migrate:
        condition: service_completed_successfully
    networks:
      - aivo-test-network
    profiles:
      - setup

networks:
  aivo-test-network:
    driver: bridge

volumes:
  postgres_test_data:
  nats_test_data:
